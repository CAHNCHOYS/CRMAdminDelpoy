import{r as D,W as Ve,X as J,i as W,h as X,d as Y,P as ne,Y as Z,J as ae,O as p,e as a,Z as se,l as H,o as m,b as t,y as K,s as re,v as oe,x as de,g as e,z as G,B as f,C as L,D as w,$ as O,a0 as ie,a1 as ce,m as le,n as ue,p as k,t as Q,F as E,f as ee,q as A,a2 as Pe,u as _e,S as ke,c as xe,U as we,M as I,k as Ae,a3 as Me,a4 as Ue,a5 as $e,a6 as Ce,G as De}from"./index-1cb64e4a.js";import{u as j}from"./alert-18323748.js";import{u as Ee,a as Te,_ as qe}from"./ElementsTable.vue_vue_type_script_setup_true_lang-b1d75ebe.js";import{u as me,a as ge,b as R}from"./useFormSchemas-bbdef749.js";const Fe=(o,S,l)=>{const V=j(),x=D([+o.query.startPrice||1,+o.query.endPrice||99999]),v=D(o.query.productName||""),b=D([]),P=D(!1),c=D(!1),g=D(!1),y=()=>{v.value="",x.value=[1,99999],P.value=!1,b.value=[],S.push({name:"products-page",query:{}})},T=()=>{S.push({name:"products-page",query:{...o.query,productName:v.value,startPrice:x.value[0],endPrice:x.value[1]}})},_=async()=>{try{c.value=!0;const{data:M}=await J.getSearchedProducts({startPrice:o.query.startPrice,endPrice:o.query.endPrice,productName:o.query.productName,userId:l});b.value=M.products,console.log(b.value),P.value=!0}catch(M){W(M)?V.showMessage("error",X(M)):V.showMessage("error","Ошибка при поиске товара(")}finally{c.value=!1}};return Ve([()=>o.query.startPrice,()=>o.query.endPrice,()=>o.query.productName],async()=>{!o.query.startPrice&&!o.query.endPrice||_()},{immediate:!0}),{searchPrices:x,searchName:v,isSearchActive:P,searchedProducts:b,isSearchLoading:c,isSearchFormActive:g,searchUserProducts:_,addSearchQuery:T,resetSearch:y}},Ne=A("p",{class:"text-h6 font-weight-bold mb-4"},"Редактирование товара",-1),Be=A("p",{class:"text-h6 mb-2"},"Загрузка категорий....",-1),Ie=Y({__name:"ProductEditDialog",props:{isActive:{type:Boolean},product:null,isSearchActive:{type:Boolean}},emits:["closeDialog","updateSearchProducts"],setup(o,{emit:S}){const l=o,V=ne(()=>{var s,u,n,B;return{name:((s=l.product)==null?void 0:s.name)||"Товар не был выбран",price:((u=l.product)==null?void 0:u.price)||0,count:((n=l.product)==null?void 0:n.count)||0,categoryId:((B=l.product)==null?void 0:B.categoryId)||0}}),{userProductSchema:x}=me(),{handleSubmit:v,isSubmitting:b,resetForm:P}=ge({validationSchema:x,initialValues:V}),{value:c,errorMessage:g}=R("name"),{value:y,errorMessage:T}=R("price"),{value:_,errorMessage:M}=R("count"),{value:$,errorMessage:q}=R("categoryId"),F=Z(),U=j(),{productsCategories:z,categoriesErrorMessage:N,isCategoriesLoading:C}=ae(F),h=H(),d=v(async s=>{var u;try{await J.updateProduct(s,l.product.id);const n=z.value.find(B=>B.id===s.categoryId).name;F.updateUserProduct({...s,category:n,id:l.product.id}),l.isSearchActive&&S("updateSearchProducts"),U.showMessage("success","Товар был изменен")}catch(n){if(W(n)){if(((u=n.response)==null?void 0:u.status)===401){h.push({name:"login-page",query:{isExpiredToken:"true",redirectedFrom:"products-page"}});return}U.showMessage("error",X(n))}else U.showMessage("error","Ошибка при обновлении товара!")}finally{P(),S("closeDialog")}});return(s,u)=>(m(),p(se,{transition:"dialog-bottom-transition","max-width":"500","onUpdate:modelValue":u[5]||(u[5]=n=>s.$emit("closeDialog")),"model-value":o.isActive},{default:a(()=>[t(ee,{class:"pa-5",color:"white",elevation:"4"},{default:a(()=>[t(K,null,{default:a(()=>[Ne]),_:1}),t(re,null,{default:a(()=>[t(oe,{onSubmit:de(e(d),["prevent"])},{default:a(()=>[t(G,null,{default:a(()=>[t(f,{cols:"12"},{default:a(()=>[t(L,{modelValue:e(c),"onUpdate:modelValue":u[0]||(u[0]=n=>w(c)?c.value=n:null),"error-messages":e(g),label:"Название товара"},null,8,["modelValue","error-messages"])]),_:1}),t(f,{cols:"12"},{default:a(()=>[e(C)?(m(),p(O,{key:0},{default:a(()=>[Be,t(ie,{indeterminate:"",height:"6",color:"green"})]),_:1})):e(N)?(m(),p(O,{key:2},{default:a(()=>[t(le,{type:"error",border:"end",variant:"outlined",class:"pa-2"},{default:a(()=>[t(ue,{class:"text-h6"},{default:a(()=>[k(Q(e(N)),1)]),_:1})]),_:1})]),_:1})):(m(),p(ce,{key:1,modelValue:e($),"onUpdate:modelValue":u[1]||(u[1]=n=>w($)?$.value=n:null),label:"Категория товара","error-messages":e(q),items:e(z),"item-title":"name",clearable:!1,"item-value":"id","no-data-text":"Нет категорий"},null,8,["modelValue","error-messages","items"]))]),_:1}),t(f,{sm:"6",cols:"12"},{default:a(()=>[t(L,{modelValue:e(_),"onUpdate:modelValue":u[2]||(u[2]=n=>w(_)?_.value=n:null),modelModifiers:{number:!0},"error-messages":e(M),label:"Количество",type:"number"},null,8,["modelValue","error-messages"])]),_:1}),t(f,{sm:"6",cols:"12"},{default:a(()=>[t(L,{modelValue:e(y),"onUpdate:modelValue":u[3]||(u[3]=n=>w(y)?y.value=n:null),modelModifiers:{number:!0},"error-messages":e(T),label:"Цена",type:"number",suffix:"руб"},null,8,["modelValue","error-messages"])]),_:1}),t(f,{cols:"12"},{default:a(()=>[t(E,{color:"green-darken-4",variant:"flat",loading:e(b),type:"submit"},{default:a(()=>[k(" Сохранить ")]),_:1},8,["loading"]),t(E,{color:"blue-darken-4",variant:"flat",onClick:u[4]||(u[4]=n=>s.$emit("closeDialog"))},{default:a(()=>[k(" Отмена ")]),_:1})]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["model-value"]))}}),Re=A("p",{class:"font-weight-bold text-h5"},"Подтверждение удаления",-1),Le={class:"text-h6"},ze={class:"text-red"},Oe=A("span",{class:"text-white"},"Нет",-1),Qe=Y({__name:"ProductDeleteDialog",props:{product:null,isActive:{type:Boolean},isSearchActive:{type:Boolean}},emits:["closeDialog","updateSearchProducts"],setup(o,{emit:S}){const l=o,V=D(!1),x=Z(),v=j(),b=H(),P=async()=>{var c;try{V.value=!0,await J.deleteProduct(l.product.id),x.deleteUserProduct(l.product.id),l.isSearchActive&&S("updateSearchProducts"),v.showMessage("success","Товар был успешно удален")}catch(g){if(W(g)){if(((c=g.response)==null?void 0:c.status)===401){b.push({name:"login-page",query:{isExpiredToken:"true",redirectedFrom:"products-page"}});return}v.showMessage("error",X(g))}else v.showMessage("error","Ошибка при удалении товара!")}finally{V.value=!1,S("closeDialog")}};return(c,g)=>(m(),p(se,{"model-value":o.isActive,"max-width":450,persistent:"",transition:"dialog-bottom-transition"},{default:a(()=>[t(ee,{class:"pa-4"},{default:a(()=>[t(K,{class:"pa-0 mb-3"},{default:a(()=>[Re]),_:1}),t(Pe,{class:"pa-0 mb-4"},{default:a(()=>[A("p",Le,[k(" Вы уверены что хотите удалить товар "),A("span",ze,Q(l.product.name),1),k(" из списка? ")])]),_:1}),t(re,{class:"justify-center"},{default:a(()=>[t(E,{onClick:g[0]||(g[0]=y=>c.$emit("closeDialog")),height:"40",color:"blue-darken-4",variant:"flat"},{default:a(()=>[Oe]),_:1}),t(E,{height:"40",loading:V.value,color:"error",variant:"flat",onClick:P},{default:a(()=>[k("Да")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["model-value"]))}}),je=A("p",{class:"text-h6 font-weight-bold mb-4"},"Добавление нового товара",-1),Ge=A("p",{class:"text-h6 mb-2"},"Загрузка категорий....",-1),Je=Y({__name:"ProductAddDialog",props:{isActive:{type:Boolean}},emits:["closeDialog"],setup(o,{emit:S}){const{userProductSchema:l}=me(),{handleSubmit:V,isSubmitting:x,resetForm:v}=ge({validationSchema:l}),{value:b,errorMessage:P}=R("name"),{value:c,errorMessage:g}=R("categoryId"),{value:y,errorMessage:T}=R("count"),{value:_,errorMessage:M}=R("price"),$=Z(),q=j(),{productsCategories:F,categoriesErrorMessage:U,isCategoriesLoading:z}=ae($),N=H(),C=V(async h=>{var d;try{const{data:s}=await J.addProduct(h);console.log(h),$.addUserProduct({...h,...s}),q.showMessage("success",`Товар ${h.name} был успешно добавлен!`)}catch(s){if(W(s)){if(((d=s.response)==null?void 0:d.status)===401){N.push({name:"login-page",query:{isExpiredToken:"true",redirectedFrom:"products-page"}});return}q.showMessage("error",X(s))}else q.showMessage("error","Ошибка при добавлении товара !")}finally{v(),S("closeDialog")}});return(h,d)=>(m(),p(se,{transition:"dialog-bottom-transition","max-width":"500","onUpdate:modelValue":d[5]||(d[5]=s=>h.$emit("closeDialog")),scrollable:"","model-value":o.isActive},{default:a(()=>[t(ee,{class:"pa-5",color:"white",elevation:"4"},{default:a(()=>[t(K,null,{default:a(()=>[je]),_:1}),t(re,null,{default:a(()=>[t(oe,{onSubmit:de(e(C),["prevent"])},{default:a(()=>[t(G,null,{default:a(()=>[t(f,{cols:"12"},{default:a(()=>[t(L,{modelValue:e(b),"onUpdate:modelValue":d[0]||(d[0]=s=>w(b)?b.value=s:null),"error-messages":e(P),label:"Название товара"},null,8,["modelValue","error-messages"])]),_:1}),t(f,{cols:"12"},{default:a(()=>[e(z)?(m(),p(O,{key:0},{default:a(()=>[Ge,t(ie,{indeterminate:"",height:"6",color:"green"})]),_:1})):e(U)?(m(),p(O,{key:2},{default:a(()=>[t(le,{type:"error",border:"end",variant:"outlined",class:"pa-2"},{default:a(()=>[t(ue,{class:"text-h6"},{default:a(()=>[k(Q(e(U)),1)]),_:1})]),_:1})]),_:1})):(m(),p(ce,{key:1,modelValue:e(c),"onUpdate:modelValue":d[1]||(d[1]=s=>w(c)?c.value=s:null),label:"Категория товара","error-messages":e(g),items:e(F),"item-title":"name",clearable:!1,"item-value":"id","no-data-text":"Нет категорий"},null,8,["modelValue","error-messages","items"]))]),_:1}),t(f,{sm:"6",cols:"12"},{default:a(()=>[t(L,{modelValue:e(y),"onUpdate:modelValue":d[2]||(d[2]=s=>w(y)?y.value=s:null),modelModifiers:{number:!0},"error-messages":e(T),label:"Количество",type:"number"},null,8,["modelValue","error-messages"])]),_:1}),t(f,{sm:"6",cols:"12"},{default:a(()=>[t(L,{modelValue:e(_),"onUpdate:modelValue":d[3]||(d[3]=s=>w(_)?_.value=s:null),modelModifiers:{number:!0},"error-messages":e(M),label:"Цена",suffix:"руб",type:"number"},null,8,["modelValue","error-messages"])]),_:1}),t(f,{cols:"12"},{default:a(()=>[t(E,{color:"green-darken-4",variant:"flat",loading:e(x),type:"submit"},{default:a(()=>[k(" Добавить ")]),_:1},8,["loading"]),t(E,{color:"blue-darken-4",variant:"flat",onClick:d[4]||(d[4]=s=>h.$emit("closeDialog"))},{default:a(()=>[k(" Отмена ")]),_:1})]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["model-value"]))}}),We={key:0},Xe={class:"text-h6"},Ye=A("h2",{class:"title text-h2 mb-5"},"Товары",-1),Ze=A("span",{class:"text-wrap"}," Сбросить поиск",-1),He={class:"text-h6"},st=Y({__name:"ProductsView",setup(o){const S=Z(),l=j(),V=_e(),x=D([{fieldText:"Имя",fieldName:"name"},{fieldText:"Цена(руб)",fieldName:"price"},{fieldText:"Кол-во",fieldName:"count"},{fieldText:"Категория",fieldName:"category"}]),v=D("name"),{userProducts:b,productsErrorMessage:P,productsCategories:c}=ae(S);ke(async()=>{c.value.length||S.getAllProductsCategories()});const{itemToEdit:g,isAddDialogActive:y,isEditDialogActive:T,isDeleteDialogActive:_,openDialog:M}=Ee(),$=Ae(),q=H(),{searchName:F,searchPrices:U,searchedProducts:z,isSearchActive:N,isSearchLoading:C,isSearchFormActive:h,resetSearch:d,addSearchQuery:s,searchUserProducts:u}=Fe($,q,V.currentUser.id),n=ne(()=>N.value?z.value:b.value),{currentPage:B,paginatedElements:pe,totalPages:fe,isInverseSort:ve,elementsPerPageCount:te,setSortField:be}=Te({tableElements:n,pageName:"products-page",sortField:v,route:$,router:q});return(ye,r)=>{const he=De("TableActions");return e(V).currentUser?(m(),xe("div",We,[t(we,{modelValue:e(l).isMessageShown,"onUpdate:modelValue":r[0]||(r[0]=i=>e(l).isMessageShown=i),color:e(l).messageType,"location-strategy":"connected"},{default:a(()=>[A("p",Xe,Q(e(l).messageText),1)]),_:1},8,["modelValue","color"]),Ye,t(ee,{color:"white",elevation:"3",class:"pa-5 mb-6 rounded-lg mx-sm-0 mx-n5"},{default:a(()=>[e(P)?I("",!0):(m(),p(K,{key:0,class:"pa-0"},{default:a(()=>[t(he,{count:e(te),"onUpdate:count":r[1]||(r[1]=i=>w(te)?te.value=i:null),onToggleAddDialog:r[2]||(r[2]=i=>y.value=!0),onToggleSearch:r[3]||(r[3]=i=>h.value=!e(h)),"is-badge-active":!!ye.$route.query.startPrice},{default:a(()=>[k(" Все товары ")]),_:1},8,["count","is-badge-active"]),t(Me,null,{default:a(()=>[e(h)?(m(),p(oe,{key:0,class:"mb-8"},{default:a(()=>[t(G,{align:"center"},{default:a(()=>[t(f,{sm:"6",cols:"12",class:"mb-sm-0 mb-2"},{default:a(()=>[t(L,{modelValue:e(F),"onUpdate:modelValue":r[4]||(r[4]=i=>w(F)?F.value=i:null),variant:"outlined",label:"Название товара"},null,8,["modelValue"])]),_:1}),t(f,{sm:"6",cols:"12",class:"pr-7"},{default:a(()=>[t(Ue,{modelValue:e(U),"onUpdate:modelValue":r[5]||(r[5]=i=>w(U)?U.value=i:null),min:"1",step:"10",max:"99999",color:"blue-grey-darken-2",label:"Цена:"},null,8,["modelValue"])]),_:1}),t(f,{sm:"auto",cols:"12"},{default:a(()=>[t(G,null,{default:a(()=>[t(f,{sm:"auto",cols:"6"},{default:a(()=>[t(E,{variant:"flat",color:"green-darken-3",onClick:e(s),disabled:e(C),block:""},{default:a(()=>[k(" Искать ")]),_:1},8,["onClick","disabled"])]),_:1}),t(f,{sm:"auto",cols:"6"},{default:a(()=>[t(E,{variant:"flat",color:"red-darken-4",onClick:e(d),disabled:e(C),block:""},{default:a(()=>[Ze]),_:1},8,["onClick","disabled"])]),_:1}),t(f,{sm:"auto",cols:"12"},{default:a(()=>[t(E,{variant:"flat",color:"blue-darken-4",onClick:r[6]||(r[6]=i=>h.value=!1),disabled:e(C),block:""},{default:a(()=>[k(" Закрыть ")]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})):I("",!0)]),_:1})]),_:1})),e(P)?(m(),p(le,{key:1,type:"error",border:"end",variant:"tonal"},{default:a(()=>[t(ue,{class:"mb-2 text-h5"},{default:a(()=>[k(" Ошибка при загрузке товаров ")]),_:1}),A("p",He,Q(e(P)),1)]),_:1})):e(C)?I("",!0):(m(),p(qe,{key:2,items:e(pe),fields:x.value,"current-sort-field":v.value,onUpdateSortField:r[7]||(r[7]=i=>e(be)(i)),"is-inverse-sort":e(ve),"no-data-text":"Товары не найдены",onOpenDialog:r[8]||(r[8]=(i,Se)=>e(M)(i,Se))},null,8,["items","fields","current-sort-field","is-inverse-sort"])),e(C)?(m(),p(O,{key:3,class:"text-center mb-2"},{default:a(()=>[t($e,{indeterminate:"",size:"48",color:"green"})]),_:1})):I("",!0),e(n).length?(m(),p(Ce,{key:4,length:e(fe),modelValue:e(B),"onUpdate:modelValue":r[9]||(r[9]=i=>w(B)?B.value=i:null),rounded:"circle","total-visible":7,color:"indigo-darken-4"},null,8,["length","modelValue"])):I("",!0)]),_:1}),e(g)?(m(),p(Ie,{key:0,"is-active":e(T),onCloseDialog:r[10]||(r[10]=i=>T.value=!1),product:e(g),"is-search-active":e(N),onUpdateSearchProducts:e(u)},null,8,["is-active","product","is-search-active","onUpdateSearchProducts"])):I("",!0),e(g)?(m(),p(Qe,{key:1,"is-active":e(_),onCloseDialog:r[11]||(r[11]=i=>_.value=!1),product:e(g),"is-search-active":e(N),onUpdateSearchProducts:e(u)},null,8,["is-active","product","is-search-active","onUpdateSearchProducts"])):I("",!0),t(Je,{onCloseDialog:r[12]||(r[12]=i=>y.value=!1),"is-active":e(y)},null,8,["is-active"])])):I("",!0)}}});export{st as default};
