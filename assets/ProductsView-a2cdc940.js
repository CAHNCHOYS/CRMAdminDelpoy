import{r as I,D as xe,P as ee,i as te,h as oe,d as se,z as de,E as ae,v as ne,y as g,e as o,j as re,k as s,o as _,b as t,n as ue,f as e,p as A,l as w,t as Y,m as E,u as ke,B as Ve,c as Me,x as R,g as we}from"./index-895edbee.js";import{u as Z}from"./alert-139ef2ed.js";import{u as Ue,a as $e,_ as Ae}from"./ElementsTable.vue_vue_type_script_setup_true_lang-1b2db23d.js";import{u as ie,a as me,b as j}from"./useFormSchemas-8d352281.js";const Ee=(l,x,n)=>{const k=Z(),U=I([+l.query.startPrice||1,+l.query.endPrice||99999]),h=I(l.query.productName||""),y=I([]),V=I(!1),m=I(!1),v=I(!1),b=()=>{h.value="",U.value=[1,99999],V.value=!1,y.value=[],x.push({name:"products-page",query:{}})},q=()=>{x.push({name:"products-page",query:{...l.query,productName:h.value,startPrice:U.value[0],endPrice:U.value[1]}})},f=async()=>{try{m.value=!0;const{data:$}=await ee.getSearchedProducts({startPrice:l.query.startPrice,endPrice:l.query.endPrice,productName:l.query.productName,userId:n});y.value=$.products,console.log(y.value),V.value=!0}catch($){te($)?k.showMessage("error",oe($)):k.showMessage("error","Ошибка при поиске товара(")}finally{m.value=!1}};return xe([()=>l.query.startPrice,()=>l.query.endPrice,()=>l.query.productName],async()=>{!l.query.startPrice&&!l.query.endPrice||f()},{immediate:!0}),{searchPrices:U,searchName:h,isSearchActive:V,searchedProducts:y,isSearchLoading:m,isSearchFormActive:v,searchUserProducts:f,addSearchQuery:q,resetSearch:b}},Ce=E("p",{class:"text-h6 font-weight-bold mb-4"},"Редактирование товара",-1),qe=E("p",{class:"text-h6 mb-2"},"Загрузка категорий....",-1),Te=se({__name:"ProductEditDialog",props:{isActive:{type:Boolean},product:null,isSearchActive:{type:Boolean}},emits:["closeModal","updateSearchProducts"],setup(l,{emit:x}){const n=l,k=de(()=>{var d,r,u,P;return{name:((d=n.product)==null?void 0:d.name)||"Товар не был выбран",price:((r=n.product)==null?void 0:r.price)||0,count:((u=n.product)==null?void 0:u.count)||0,categoryId:((P=n.product)==null?void 0:P.categoryId)||0}}),{userProductSchema:U}=ie(),{handleSubmit:h,isSubmitting:y,resetForm:V}=me({validationSchema:U,initialValues:k}),{value:m,errorMessage:v}=j("name"),{value:b,errorMessage:q}=j("price"),{value:f,errorMessage:$}=j("count"),{value:C,errorMessage:T}=j("categoryId"),D=ae(),F=Z(),{productsCategories:Q,categoriesErrorMessage:L,isCategoriesLoading:B}=ne(D),S=re(),c=h(async d=>{var r;try{await ee.updateProduct(d,n.product.id);const u=Q.value.find(P=>P.id===d.categoryId).name;D.updateUserProduct({...d,category:u,id:n.product.id}),n.isSearchActive&&x("updateSearchProducts"),F.showMessage("success","Товар был изменен")}catch(u){if(te(u)){if(((r=u.response)==null?void 0:r.status)===401){S.push({name:"login-page",query:{isExpiredToken:"true",redirectedFrom:"products-page"}});return}F.showMessage("error",oe(u))}else F.showMessage("error","Ошибка при обновлении товара!")}finally{V(),x("closeModal")}});return(d,r)=>{const u=s("v-card-title"),P=s("v-text-field"),N=s("v-col"),H=s("v-progress-linear"),O=s("v-sheet"),z=s("v-autocomplete"),G=s("v-alert-title"),J=s("v-alert"),a=s("v-btn"),K=s("v-row"),W=s("v-form"),X=s("v-card-actions"),p=s("v-card"),le=s("v-dialog");return _(),g(le,{transition:"dialog-bottom-transition","max-width":"500","onUpdate:modelValue":r[5]||(r[5]=M=>d.$emit("closeModal")),"model-value":l.isActive},{default:o(()=>[t(p,{class:"pa-5",color:"white",elevation:"4"},{default:o(()=>[t(u,null,{default:o(()=>[Ce]),_:1}),t(X,null,{default:o(()=>[t(W,{onSubmit:ue(e(c),["prevent"])},{default:o(()=>[t(K,null,{default:o(()=>[t(N,{cols:"12"},{default:o(()=>[t(P,{modelValue:e(m),"onUpdate:modelValue":r[0]||(r[0]=M=>A(m)?m.value=M:null),"error-messages":e(v),label:"Название товара"},null,8,["modelValue","error-messages"])]),_:1}),t(N,{cols:"12"},{default:o(()=>[e(B)?(_(),g(O,{key:0},{default:o(()=>[qe,t(H,{indeterminate:"",height:"6",color:"green"})]),_:1})):e(L)?(_(),g(O,{key:2},{default:o(()=>[t(J,{type:"error",border:"end",variant:"outlined",class:"pa-2"},{default:o(()=>[t(G,{class:"text-h6"},{default:o(()=>[w(Y(e(L)),1)]),_:1})]),_:1})]),_:1})):(_(),g(z,{key:1,modelValue:e(C),"onUpdate:modelValue":r[1]||(r[1]=M=>A(C)?C.value=M:null),label:"Категория товара","error-messages":e(T),items:e(Q),"item-title":"name",clearable:!1,"item-value":"id","no-data-text":"Нет категорий"},null,8,["modelValue","error-messages","items"]))]),_:1}),t(N,{sm:"6",cols:"12"},{default:o(()=>[t(P,{modelValue:e(f),"onUpdate:modelValue":r[2]||(r[2]=M=>A(f)?f.value=M:null),modelModifiers:{number:!0},"error-messages":e($),label:"Количество",type:"number"},null,8,["modelValue","error-messages"])]),_:1}),t(N,{sm:"6",cols:"12"},{default:o(()=>[t(P,{modelValue:e(b),"onUpdate:modelValue":r[3]||(r[3]=M=>A(b)?b.value=M:null),modelModifiers:{number:!0},"error-messages":e(q),label:"Цена",type:"number",suffix:"руб"},null,8,["modelValue","error-messages"])]),_:1}),t(N,{cols:"12"},{default:o(()=>[t(a,{color:"green-darken-4",variant:"flat",loading:e(y),type:"submit"},{default:o(()=>[w(" Сохранить ")]),_:1},8,["loading"]),t(a,{color:"blue-darken-4",variant:"flat",onClick:r[4]||(r[4]=M=>d.$emit("closeModal"))},{default:o(()=>[w(" Отмена ")]),_:1})]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["model-value"])}}}),Fe=E("p",{class:"font-weight-bold text-h5"},"Подтверждение удаления",-1),Ne={class:"text-h6"},De={class:"text-red"},Be=E("span",{class:"text-white"},"Нет",-1),Ie=se({__name:"ProductDeleteDialog",props:{product:null,isActive:{type:Boolean},isSearchActive:{type:Boolean}},emits:["closeModal","updateSearchProducts"],setup(l,{emit:x}){const n=l,k=I(!1),U=ae(),h=Z(),y=re(),V=async()=>{var m;try{k.value=!0,await ee.deleteProduct(n.product.id),U.deleteUserProduct(n.product.id),n.isSearchActive&&x("updateSearchProducts"),h.showMessage("success","Товар был успешно удален")}catch(v){if(te(v)){if(((m=v.response)==null?void 0:m.status)===401){y.push({name:"login-page",query:{isExpiredToken:"true",redirectedFrom:"products-page"}});return}h.showMessage("error",oe(v))}else h.showMessage("error","Ошибка при удалении товара!")}finally{k.value=!1,x("closeModal")}};return(m,v)=>{const b=s("v-card-title"),q=s("v-card-text"),f=s("v-btn"),$=s("v-card-actions"),C=s("v-card"),T=s("v-dialog");return _(),g(T,{"model-value":l.isActive,"max-width":450,persistent:"",transition:"dialog-bottom-transition"},{default:o(()=>[t(C,{class:"pa-4"},{default:o(()=>[t(b,{class:"pa-0 mb-3"},{default:o(()=>[Fe]),_:1}),t(q,{class:"pa-0 mb-4"},{default:o(()=>[E("p",Ne,[w(" Вы уверены что хотите удалить товар "),E("span",De,Y(n.product.name),1),w(" из списка? ")])]),_:1}),t($,{class:"justify-center"},{default:o(()=>[t(f,{onClick:v[0]||(v[0]=D=>m.$emit("closeModal")),height:"40",color:"blue-darken-4",variant:"flat"},{default:o(()=>[Be]),_:1}),t(f,{height:"40",loading:k.value,color:"error",variant:"flat",onClick:V},{default:o(()=>[w("Да")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["model-value"])}}}),Le=E("p",{class:"text-h6 font-weight-bold mb-4"},"Добавление нового товара",-1),Re=E("p",{class:"text-h6 mb-2"},"Загрузка категорий....",-1),je=se({__name:"ProductAddDialog",props:{isActive:{type:Boolean}},emits:["closeModal"],setup(l,{emit:x}){const{userProductSchema:n}=ie(),{handleSubmit:k,isSubmitting:U,resetForm:h}=me({validationSchema:n}),{value:y,errorMessage:V}=j("name"),{value:m,errorMessage:v}=j("categoryId"),{value:b,errorMessage:q}=j("count"),{value:f,errorMessage:$}=j("price"),C=ae(),T=Z(),{productsCategories:D,categoriesErrorMessage:F,isCategoriesLoading:Q}=ne(C),L=re(),B=k(async S=>{var c;try{const{data:d}=await ee.addProduct(S);console.log(S),C.addUserProduct({...S,...d}),T.showMessage("success",`Товар ${S.name} был успешно добавлен!`)}catch(d){if(te(d)){if(((c=d.response)==null?void 0:c.status)===401){L.push({name:"login-page",query:{isExpiredToken:"true",redirectedFrom:"products-page"}});return}T.showMessage("error",oe(d))}else T.showMessage("error","Ошибка при добавлении товара !")}finally{h(),x("closeModal")}});return(S,c)=>{const d=s("v-card-title"),r=s("v-text-field"),u=s("v-col"),P=s("v-progress-linear"),N=s("v-sheet"),H=s("v-autocomplete"),O=s("v-alert-title"),z=s("v-alert"),G=s("v-btn"),J=s("v-row"),a=s("v-form"),K=s("v-card-actions"),W=s("v-card"),X=s("v-dialog");return _(),g(X,{transition:"dialog-bottom-transition","max-width":"500","onUpdate:modelValue":c[5]||(c[5]=p=>S.$emit("closeModal")),scrollable:"","model-value":l.isActive},{default:o(()=>[t(W,{class:"pa-5",color:"white",elevation:"4"},{default:o(()=>[t(d,null,{default:o(()=>[Le]),_:1}),t(K,null,{default:o(()=>[t(a,{onSubmit:ue(e(B),["prevent"])},{default:o(()=>[t(J,null,{default:o(()=>[t(u,{cols:"12"},{default:o(()=>[t(r,{modelValue:e(y),"onUpdate:modelValue":c[0]||(c[0]=p=>A(y)?y.value=p:null),"error-messages":e(V),label:"Название товара"},null,8,["modelValue","error-messages"])]),_:1}),t(u,{cols:"12"},{default:o(()=>[e(Q)?(_(),g(N,{key:0},{default:o(()=>[Re,t(P,{indeterminate:"",height:"6",color:"green"})]),_:1})):e(F)?(_(),g(N,{key:2},{default:o(()=>[t(z,{type:"error",border:"end",variant:"outlined",class:"pa-2"},{default:o(()=>[t(O,{class:"text-h6"},{default:o(()=>[w(Y(e(F)),1)]),_:1})]),_:1})]),_:1})):(_(),g(H,{key:1,modelValue:e(m),"onUpdate:modelValue":c[1]||(c[1]=p=>A(m)?m.value=p:null),label:"Категория товара","error-messages":e(v),items:e(D),"item-title":"name",clearable:!1,"item-value":"id","no-data-text":"Нет категорий"},null,8,["modelValue","error-messages","items"]))]),_:1}),t(u,{sm:"6",cols:"12"},{default:o(()=>[t(r,{modelValue:e(b),"onUpdate:modelValue":c[2]||(c[2]=p=>A(b)?b.value=p:null),modelModifiers:{number:!0},"error-messages":e(q),label:"Количество",type:"number"},null,8,["modelValue","error-messages"])]),_:1}),t(u,{sm:"6",cols:"12"},{default:o(()=>[t(r,{modelValue:e(f),"onUpdate:modelValue":c[3]||(c[3]=p=>A(f)?f.value=p:null),modelModifiers:{number:!0},"error-messages":e($),label:"Цена",suffix:"руб",type:"number"},null,8,["modelValue","error-messages"])]),_:1}),t(u,{cols:"12"},{default:o(()=>[t(G,{color:"green-darken-4",variant:"flat",loading:e(U),type:"submit"},{default:o(()=>[w(" Добавить ")]),_:1},8,["loading"]),t(G,{color:"blue-darken-4",variant:"flat",onClick:c[4]||(c[4]=p=>S.$emit("closeModal"))},{default:o(()=>[w(" Отмена ")]),_:1})]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["model-value"])}}}),ze={key:0},Qe={class:"text-h6"},Oe=E("h2",{class:"title text-h2 mb-5"},"Товары",-1),Ge=E("span",{class:"text-wrap"}," Сбросить поиск",-1),He={class:"text-h6"},Ye=se({__name:"ProductsView",setup(l){const x=ae(),n=Z(),k=ke(),U=I([{fieldText:"Имя",fieldName:"name"},{fieldText:"Цена(руб)",fieldName:"price"},{fieldText:"Кол-во",fieldName:"count"},{fieldText:"Категория",fieldName:"category"}]),h=I("name"),{userProducts:y,productsErrorMessage:V,productsCategories:m}=ne(x);Ve(async()=>{m.value.length||x.getAllProductsCategories()});const{itemToEdit:v,isAddDialogActive:b,isEditDialogActive:q,isDeleteDialogActive:f,openDialog:$}=Ue(),C=we(),T=re(),{searchName:D,searchPrices:F,searchedProducts:Q,isSearchActive:L,isSearchLoading:B,isSearchFormActive:S,resetSearch:c,addSearchQuery:d,searchUserProducts:r}=Ee(C,T,k.currentUser.id),u=de(()=>L.value?Q.value:y.value),{currentPage:P,paginatedElements:N,totalPages:H,isInverseSort:O,elementsPerPageCount:z,setSortField:G}=$e({tableElements:u,pageName:"products-page",sortField:h,route:C,router:T});return(J,a)=>{const K=s("v-snackbar"),W=s("TableActions"),X=s("v-text-field"),p=s("v-col"),le=s("v-range-slider"),M=s("v-btn"),ce=s("v-row"),pe=s("v-form"),_e=s("v-expand-transition"),ve=s("v-card-title"),ge=s("v-alert-title"),fe=s("v-alert"),be=s("v-progress-circular"),he=s("v-sheet"),ye=s("v-pagination"),Se=s("v-card");return e(k).currentUser?(_(),Me("div",ze,[t(K,{modelValue:e(n).isMessageShown,"onUpdate:modelValue":a[0]||(a[0]=i=>e(n).isMessageShown=i),color:e(n).messageType,position:"fixed"},{default:o(()=>[E("p",Qe,Y(e(n).messageText),1)]),_:1},8,["modelValue","color"]),Oe,t(Se,{color:"white",elevation:"3",class:"pa-5 mb-6 rounded-lg mx-sm-0 mx-n5"},{default:o(()=>[e(V)?R("",!0):(_(),g(ve,{key:0,class:"pa-0"},{default:o(()=>[t(W,{count:e(z),"onUpdate:count":a[1]||(a[1]=i=>A(z)?z.value=i:null),onToggleAddDialog:a[2]||(a[2]=i=>b.value=!0),onToggleSearch:a[3]||(a[3]=i=>S.value=!e(S)),"is-badge-active":!!J.$route.query.startPrice},{default:o(()=>[w(" Все товары ")]),_:1},8,["count","is-badge-active"]),t(_e,null,{default:o(()=>[e(S)?(_(),g(pe,{key:0,class:"mb-8"},{default:o(()=>[t(ce,{align:"center"},{default:o(()=>[t(p,{sm:"6",cols:"12",class:"mb-sm-0 mb-2"},{default:o(()=>[t(X,{modelValue:e(D),"onUpdate:modelValue":a[4]||(a[4]=i=>A(D)?D.value=i:null),variant:"outlined",label:"Название товара"},null,8,["modelValue"])]),_:1}),t(p,{sm:"6",cols:"12",class:"pr-7"},{default:o(()=>[t(le,{modelValue:e(F),"onUpdate:modelValue":a[5]||(a[5]=i=>A(F)?F.value=i:null),min:"1",step:"10",max:"99999",color:"blue-grey-darken-2",label:"Цена:"},null,8,["modelValue"])]),_:1}),t(p,{sm:"auto",cols:"12"},{default:o(()=>[t(ce,null,{default:o(()=>[t(p,{sm:"auto",cols:"6"},{default:o(()=>[t(M,{variant:"flat",color:"green-darken-3",onClick:e(d),disabled:e(B),block:""},{default:o(()=>[w(" Искать ")]),_:1},8,["onClick","disabled"])]),_:1}),t(p,{sm:"auto",cols:"6"},{default:o(()=>[t(M,{variant:"flat",color:"red-darken-4",onClick:e(c),disabled:e(B),block:""},{default:o(()=>[Ge]),_:1},8,["onClick","disabled"])]),_:1}),t(p,{sm:"auto",cols:"12"},{default:o(()=>[t(M,{variant:"flat",color:"blue-darken-4",onClick:a[6]||(a[6]=i=>S.value=!1),disabled:e(B),block:""},{default:o(()=>[w(" Закрыть ")]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})):R("",!0)]),_:1})]),_:1})),e(V)?(_(),g(fe,{key:1,type:"error",border:"end",variant:"tonal"},{default:o(()=>[t(ge,{class:"mb-2 text-h5"},{default:o(()=>[w(" Ошибка при загрузке товаров ")]),_:1}),E("p",He,Y(e(V)),1)]),_:1})):e(B)?R("",!0):(_(),g(Ae,{key:2,items:e(N),fields:U.value,"current-sort-field":h.value,onUpdateSortField:a[7]||(a[7]=i=>e(G)(i)),"is-inverse-sort":e(O),"no-data-text":"Товары не найдены",onOpenDialog:a[8]||(a[8]=(i,Pe)=>e($)(i,Pe))},null,8,["items","fields","current-sort-field","is-inverse-sort"])),e(B)?(_(),g(he,{key:3,class:"text-center mb-2"},{default:o(()=>[t(be,{indeterminate:"",size:"48",color:"green"})]),_:1})):R("",!0),e(u).length?(_(),g(ye,{key:4,length:e(H),modelValue:e(P),"onUpdate:modelValue":a[9]||(a[9]=i=>A(P)?P.value=i:null),rounded:"circle","total-visible":7,color:"indigo-darken-4"},null,8,["length","modelValue"])):R("",!0)]),_:1}),e(v)?(_(),g(Te,{key:0,product:e(v),onCloseModal:a[10]||(a[10]=i=>q.value=!1),"is-active":e(q),"is-search-active":e(L),onUpdateSearchProducts:e(r)},null,8,["product","is-active","is-search-active","onUpdateSearchProducts"])):R("",!0),e(v)?(_(),g(Ie,{key:1,"is-active":e(f),product:e(v),onCloseModal:a[11]||(a[11]=i=>f.value=!1),"is-search-active":e(L),onUpdateSearchProducts:e(r)},null,8,["is-active","product","is-search-active","onUpdateSearchProducts"])):R("",!0),t(je,{onCloseModal:a[12]||(a[12]=i=>b.value=!1),"is-active":e(b)},null,8,["is-active"])])):R("",!0)}}});export{Ye as default};
