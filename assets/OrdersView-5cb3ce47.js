import{r as $,W as he,au as ee,i as te,h as re,d as ae,Y as ce,aj as pe,ak as se,J as H,O as c,e,Z as ue,l as le,o as m,b as t,y as oe,p,s as ne,v as fe,x as ge,g as r,z as L,B as l,a1 as K,D as k,$ as G,m as Y,n as X,t as I,C as F,F as A,f as de,q as Q,a2 as ke,ah as me,u as De,P as Oe,c as _e,U as Ce,M as z,k as we,a3 as xe,a5 as Me,a6 as Ue,G as $e}from"./index-1cb64e4a.js";import{u as Ee,a as Ae,_ as Ne}from"./ElementsTable.vue_vue_type_script_setup_true_lang-b1d75ebe.js";import{u as Z}from"./alert-18323748.js";import{u as ve,a as ye,b as q}from"./useFormSchemas-bbdef749.js";const Te=(o,O,f)=>{const _=Z(),b=$(!1),v=$(!1),V=$(!1),S=$([]),y=$("2023-01-01"),n=$("2024-01-01"),x=$(""),C=$(""),T=()=>{O.push({name:"orders-page",query:{startDate:y.value,endDate:n.value,customerName:x.value,productName:C.value}})},D=()=>{y.value="2023-01-01",n.value="2024-01-01",x.value="",C.value="",v.value=!1,S.value=[],O.push({name:"orders-page",query:{}})},M=async()=>{try{if(!o.query.startDate&&!o.query.endDate)return;V.value=!0;const{data:h}=await ee.getSerachedOrders({userId:f,product:o.query.productName,customer:o.query.customerName,startDate:o.query.startDate,endDate:o.query.endDate});S.value=h.orders,v.value=!0}catch(h){te(h)?_.showMessage("error",re(h)):_.showMessage("error","Ошибка при поиске заказов")}finally{V.value=!1}};return he([()=>o.query.startDate,()=>o.query.endDate,()=>o.query.customerName,()=>o.query.productName],async()=>{!o.query.startDate&&!o.query.endDate||M()},{immediate:!0}),{isSearchLoading:V,isSearchFormActive:b,isSearchActive:v,startDate:y,endDate:n,customerName:x,productName:C,searchedOrders:S,resetSearch:D,addSearchQuery:T,searchOrders:M}},Fe=Q("span",{class:"px-5 text-wrap"},"Очистить ",-1),qe=ae({__name:"OrdersAddDialog",props:{isOpened:{type:Boolean}},emits:["closeDialog"],setup(o,{emit:O}){const f=ce(),_=pe(),b=se(),v=Z(),{userProducts:V,productsErrorMessage:S}=H(f),{customers:y,customersErrorMessage:n}=H(_),{userOrderSchema:x}=ve(),{handleSubmit:C,isSubmitting:T,resetForm:D}=ye({validationSchema:x}),{value:M,errorMessage:h}=q("customerId"),{value:N,errorMessage:P}=q("productId"),{value:B,errorMessage:R}=q("productCount"),{value:U,errorMessage:J}=q("date"),W=le(),j=C(async w=>{var s;try{const{data:i}=await ee.addOrder(w);w.date=w.date.split("-").reverse().join("-"),b.addOrder({...w,...i}),v.showMessage("success","Заказ был успешно добавлен!"),D()}catch(i){if(te(i)){if(((s=i.response)==null?void 0:s.status)===401){W.push({name:"login-page",query:{isExpiredToken:"true",redirectedFrom:"orders-page"}});return}v.showMessage("error",re(i))}else v.showMessage("error","Ошибка при добавлении заказа")}finally{O("closeDialog")}});return(w,s)=>(m(),c(ue,{"model-value":o.isOpened,"onUpdate:modelValue":s[6]||(s[6]=i=>w.$emit("closeDialog")),width:"auto",scrollable:"",transition:"dialog-bottom-transition"},{default:e(()=>[t(de,{width:"450",color:"white",class:"pa-4"},{default:e(()=>[t(oe,{class:"font-weight-bold text-h6 mb-3"},{default:e(()=>[p(" Добавление заказа ")]),_:1}),t(ne,null,{default:e(()=>[t(fe,{onSubmit:ge(r(j),["prevent"])},{default:e(()=>[t(L,null,{default:e(()=>[t(l,{cols:"12"},{default:e(()=>[r(n)?(m(),c(G,{key:1},{default:e(()=>[t(Y,{type:"error",border:"end",variant:"outlined",class:"pa-2"},{default:e(()=>[t(X,{class:"text-h6"},{default:e(()=>[p(I(r(n)),1)]),_:1})]),_:1})]),_:1})):(m(),c(K,{key:0,modelValue:r(M),"onUpdate:modelValue":s[0]||(s[0]=i=>k(M)?M.value=i:null),"error-messages":r(h),label:"Клиент",items:r(y),"item-title":"fullName","item-value":"id","no-data-text":"Клиенты не найдены"},null,8,["modelValue","error-messages","items"]))]),_:1}),t(l,{cols:"12"},{default:e(()=>[r(S)?(m(),c(G,{key:1},{default:e(()=>[t(Y,{type:"error",border:"end",variant:"outlined",class:"pa-2"},{default:e(()=>[t(X,{class:"text-h6"},{default:e(()=>[p(I(r(S)),1)]),_:1})]),_:1})]),_:1})):(m(),c(K,{key:0,modelValue:r(N),"onUpdate:modelValue":s[1]||(s[1]=i=>k(N)?N.value=i:null),"error-messages":r(P),label:"Товар",items:r(V),"item-title":"name","item-value":"id","no-data-text":"Товары не найдены"},null,8,["modelValue","error-messages","items"]))]),_:1}),t(l,{cols:"12"},{default:e(()=>[t(F,{type:"number",modelValue:r(B),"onUpdate:modelValue":s[2]||(s[2]=i=>k(B)?B.value=i:null),modelModifiers:{number:!0},label:"Количество товара","error-messages":r(R)},null,8,["modelValue","error-messages"])]),_:1}),t(l,{cols:"12"},{default:e(()=>[t(F,{modelValue:r(U),"onUpdate:modelValue":s[3]||(s[3]=i=>k(U)?U.value=i:null),"error-messages":r(J),type:"date"},null,8,["modelValue","error-messages"])]),_:1}),t(l,{cols:"12"},{default:e(()=>[t(L,null,{default:e(()=>[t(l,{sm:"auto",cols:"12"},{default:e(()=>[t(A,{color:"green-darken-4",variant:"flat",type:"submit",block:"",loading:r(T)},{default:e(()=>[p(" Добавить ")]),_:1},8,["loading"])]),_:1}),t(l,{sm:"5",cols:"6"},{default:e(()=>[t(A,{color:"error",variant:"flat",onClick:s[4]||(s[4]=i=>r(D)()),block:""},{default:e(()=>[Fe]),_:1})]),_:1}),t(l,{sm:"auto",cols:"6"},{default:e(()=>[t(A,{color:"blue-darken-4",block:"",variant:"flat",onClick:s[5]||(s[5]=i=>w.$emit("closeDialog"))},{default:e(()=>[p(" Отмена ")]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["model-value"]))}}),Ie={class:"text-h6"},Pe={class:"text-error"},Be=ae({__name:"OrdersDeleteDialog",props:{isOpened:{type:Boolean},order:null,isSearchActive:{type:Boolean}},emits:["closeDialog","updateSearchOrders"],setup(o,{emit:O}){const f=o,_=$(!1),b=Z(),v=se(),V=le(),S=async()=>{var y;try{_.value=!0,await ee.deleteOrder(f.order.id),v.deleteOrder(f.order.id),f.isSearchActive&&O("updateSearchOrders"),b.showMessage("success","Заказ был успешно удален!")}catch(n){if(te(n)){if(((y=n.response)==null?void 0:y.status)===401){V.push({name:"login-page",query:{isExpiredToken:"true",redirectedFrom:"orders-page"}});return}b.showMessage("error",re(n))}else b.showMessage("error","Ошибка при удалении заказа")}finally{_.value=!1,O("closeDialog")}};return(y,n)=>(m(),c(ue,{scrollable:"",width:"auto","model-value":o.isOpened,"onUpdate:modelValue":n[1]||(n[1]=x=>y.$emit("closeDialog")),persistent:""},{default:e(()=>[t(de,{width:"450",elevation:"3",class:"pa-4"},{default:e(()=>[t(oe,{class:"font-weight-bold text-h6 mb-4 pa-0"},{default:e(()=>[p("Удаление заказа")]),_:1}),t(ke,{class:"mb-4 pa-0"},{default:e(()=>[Q("p",Ie,[p(" Вы уверены что хотите удалить заказ за "+I(o.order.date)+" клиента ",1),Q("span",Pe,I(o.order.customerFullName),1),p(" ? ")])]),_:1}),t(ne,{class:"pa-0"},{default:e(()=>[t(A,{onClick:n[0]||(n[0]=x=>y.$emit("closeDialog")),height:"40",color:"blue-darken-4",variant:"flat"},{default:e(()=>[p(" Нет ")]),_:1}),t(A,{height:"40",color:"error",variant:"flat",loading:_.value,onClick:S},{default:e(()=>[p("Да")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["model-value"]))}}),Re=ae({__name:"OrdersEditDialog",props:{isOpened:{type:Boolean},order:null,isSearchActive:{type:Boolean}},emits:["closeDialog","updateSearchOrders"],setup(o,{emit:O}){const f=o,_=me(()=>{const d=f.order.date.split("-");return d[2]+"-"+d[1]+"-"+d[0]}),b=me(()=>({productCount:f.order.productCount,productId:f.order.productId,customerId:f.order.customerId,date:_.value})),{userOrderSchema:v}=ve(),{isSubmitting:V,resetForm:S,handleSubmit:y}=ye({validationSchema:v,initialValues:b}),{value:n,errorMessage:x}=q("customerId"),{value:C,errorMessage:T}=q("productId"),{value:D,errorMessage:M}=q("productCount"),{value:h,errorMessage:N}=q("date"),P=pe(),B=ce(),R=se(),U=Z(),J=le(),{customers:W,customersErrorMessage:j}=H(P),{userProducts:w,productsErrorMessage:s}=H(B),i=y(async E=>{var d;try{const{data:g}=await ee.updateOrder(E,f.order.id);E.date=E.date.split("-").reverse().join("-"),R.updateOrder({...E,...g}),f.isSearchActive&&O("updateSearchOrders"),U.showMessage("success","Заказ был успешно обновлен")}catch(g){if(te(g)){if(((d=g.response)==null?void 0:d.status)===401){J.push({name:"login-page",query:{isExpiredToken:"true",redirectedFrom:"orders-page"}});return}U.showMessage("error",re(g))}else U.showMessage("error","Ошибка при добавлении заказа")}finally{O("closeDialog"),S()}});return(E,d)=>(m(),c(ue,{"model-value":o.isOpened,"onUpdate:modelValue":d[5]||(d[5]=g=>E.$emit("closeDialog")),width:"auto",scrollable:"",transition:"dialog-bottom-transition"},{default:e(()=>[t(de,{width:"450",color:"white",class:"pa-4"},{default:e(()=>[t(oe,{class:"font-weight-bold text-h6 mb-3"},{default:e(()=>[p(" Редактирование заказа ")]),_:1}),t(ne,null,{default:e(()=>[t(fe,{onSubmit:ge(r(i),["prevent"])},{default:e(()=>[t(L,null,{default:e(()=>[t(l,{cols:"12"},{default:e(()=>[r(j)?(m(),c(G,{key:1},{default:e(()=>[t(Y,{type:"error",border:"end",variant:"outlined",class:"pa-2"},{default:e(()=>[t(X,{class:"text-h6"},{default:e(()=>[p(I(r(j)),1)]),_:1})]),_:1})]),_:1})):(m(),c(K,{key:0,modelValue:r(n),"onUpdate:modelValue":d[0]||(d[0]=g=>k(n)?n.value=g:null),"error-messages":r(x),label:"Клиент",items:r(W),"item-title":"fullName","item-value":"id","no-data-text":"Клиенты не найдены"},null,8,["modelValue","error-messages","items"]))]),_:1}),t(l,{cols:"12"},{default:e(()=>[r(s)?(m(),c(G,{key:1},{default:e(()=>[t(Y,{type:"error",border:"end",variant:"outlined",class:"pa-2"},{default:e(()=>[t(X,{class:"text-h6"},{default:e(()=>[p(I(r(s)),1)]),_:1})]),_:1})]),_:1})):(m(),c(K,{key:0,modelValue:r(C),"onUpdate:modelValue":d[1]||(d[1]=g=>k(C)?C.value=g:null),"error-messages":r(T),label:"Товар",items:r(w),"item-title":"name","item-value":"id","no-data-text":"Товары не найдены"},null,8,["modelValue","error-messages","items"]))]),_:1}),t(l,{cols:"12"},{default:e(()=>[t(F,{modelValue:r(D),"onUpdate:modelValue":d[2]||(d[2]=g=>k(D)?D.value=g:null),modelModifiers:{number:!0},label:"Количество товара","error-messages":r(M),type:"number"},null,8,["modelValue","error-messages"])]),_:1}),t(l,{cols:"12"},{default:e(()=>[t(F,{modelValue:r(h),"onUpdate:modelValue":d[3]||(d[3]=g=>k(h)?h.value=g:null),"error-messages":r(N),type:"date"},null,8,["modelValue","error-messages"])]),_:1}),t(l,{cols:"12"},{default:e(()=>[t(L,null,{default:e(()=>[t(l,{sm:"auto",cols:"12"},{default:e(()=>[t(A,{color:"green-darken-4",variant:"flat",type:"submit",block:"",loading:r(V)},{default:e(()=>[p(" Добавить ")]),_:1},8,["loading"])]),_:1}),t(l,{sm:"auto",cols:"12"},{default:e(()=>[t(A,{color:"blue-darken-4",block:"",variant:"flat",onClick:d[4]||(d[4]=g=>E.$emit("closeDialog"))},{default:e(()=>[p(" Отмена ")]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["model-value"]))}}),je={class:"text-h6"},ze=Q("h2",{class:"title text-h2 mb-5"},"Заказы",-1),Le=Q("span",{class:"text-wrap"}," Сбросить поиск",-1),Ye=ae({__name:"OrdersView",setup(o){const O=$([{fieldText:"Клиент",fieldName:"customerFullName"},{fieldText:"Товар",fieldName:"productName"},{fieldText:"Количество товара",fieldName:"productCount"},{fieldText:"Дата",fieldName:"date"}]),f=$("customerFullName"),_=De(),b=se(),v=Z(),{itemToEdit:V,isAddDialogActive:S,isEditDialogActive:y,isDeleteDialogActive:n,openDialog:x}=Ee(),C=we(),T=le(),{isSearchFormActive:D,isSearchLoading:M,isSearchActive:h,startDate:N,endDate:P,searchedOrders:B,customerName:R,productName:U,addSearchQuery:J,resetSearch:W,searchOrders:j}=Te(C,T,_.currentUser.id),w=Oe(()=>h.value?B.value:b.orders),{currentPage:s,paginatedElements:i,isInverseSort:E,elementsPerPageCount:d,totalPages:g,setSortField:be}=Ae({tableElements:w,pageName:"orders-page",sortField:f,route:C,router:T});return(ie,a)=>{const Ve=$e("TableActions");return m(),_e("div",null,[t(Ce,{modelValue:r(v).isMessageShown,"onUpdate:modelValue":a[0]||(a[0]=u=>r(v).isMessageShown=u),color:r(v).messageType,"location-strategy":"connected"},{default:e(()=>[Q("p",je,I(r(v).messageText),1)]),_:1},8,["modelValue","color"]),ze,t(de,{elevation:"3",color:"white",class:"pa-5 rounded-lg mx-sm-0 mx-n5"},{default:e(()=>[r(b).ordersErrorMessage?z("",!0):(m(),c(oe,{key:0,class:"pa-0"},{default:e(()=>[t(Ve,{count:r(d),"onUpdate:count":a[1]||(a[1]=u=>k(d)?d.value=u:null),onToggleAddDialog:a[2]||(a[2]=u=>S.value=!0),onToggleSearch:a[3]||(a[3]=u=>D.value=!r(D)),"is-badge-active":!!(ie.$route.query.startDate||ie.$route.query.endDate)},{default:e(()=>[p(" Все заказы ")]),_:1},8,["count","is-badge-active"]),t(xe,null,{default:e(()=>[r(D)?(m(),c(L,{key:0,class:"mb-5"},{default:e(()=>[t(l,{sm:"6",cols:"12"},{default:e(()=>[t(L,null,{default:e(()=>[t(l,{cols:"6"},{default:e(()=>[t(F,{modelValue:r(N),"onUpdate:modelValue":a[4]||(a[4]=u=>k(N)?N.value=u:null),type:"date",label:"Начальная дата",clearable:!1},null,8,["modelValue"])]),_:1}),t(l,{cols:"6"},{default:e(()=>[t(F,{modelValue:r(P),"onUpdate:modelValue":a[5]||(a[5]=u=>k(P)?P.value=u:null),type:"date",label:"Конечная дата",clearable:!1},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(l,{cols:"6"},{default:e(()=>[t(F,{modelValue:r(R),"onUpdate:modelValue":a[6]||(a[6]=u=>k(R)?R.value=u:null),label:"Клиент"},null,8,["modelValue"])]),_:1}),t(l,{cols:"6"},{default:e(()=>[t(F,{modelValue:r(U),"onUpdate:modelValue":a[7]||(a[7]=u=>k(U)?U.value=u:null),label:"Товар"},null,8,["modelValue"])]),_:1}),t(l,{md:"6",cols:"12"},{default:e(()=>[t(L,null,{default:e(()=>[t(l,{sm:"auto",cols:"6"},{default:e(()=>[t(A,{onClick:r(J),variant:"flat",color:"green-darken-3",block:""},{default:e(()=>[p(" Искать ")]),_:1},8,["onClick"])]),_:1}),t(l,{sm:"auto",cols:"6"},{default:e(()=>[t(A,{onClick:r(W),variant:"flat",color:"red-darken-4",block:""},{default:e(()=>[Le]),_:1},8,["onClick"])]),_:1}),t(l,{sm:"auto",cols:"12"},{default:e(()=>[t(A,{variant:"flat",color:"blue-darken-4",onClick:a[8]||(a[8]=u=>D.value=!1),block:""},{default:e(()=>[p(" Закрыть ")]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})):z("",!0)]),_:1})]),_:1})),r(b).ordersErrorMessage?(m(),c(G,{key:1},{default:e(()=>[t(Y,{variant:"outlined",border:"end",type:"error"},{default:e(()=>[Q("p",null,I(r(b).ordersErrorMessage),1)]),_:1})]),_:1})):r(M)?z("",!0):(m(),c(Ne,{key:2,items:r(i),fields:O.value,"current-sort-field":f.value,onUpdateSortField:a[9]||(a[9]=u=>r(be)(u)),"is-inverse-sort":r(E),onOpenDialog:a[10]||(a[10]=(u,Se)=>r(x)(u,Se)),"no-data-text":"Заказы не найдены"},null,8,["items","fields","current-sort-field","is-inverse-sort"])),r(M)?(m(),c(G,{key:3,class:"text-center mb-2"},{default:e(()=>[t(Me,{indeterminate:"",size:"32",color:"green"})]),_:1})):z("",!0),r(w).length?(m(),c(Ue,{key:4,length:r(g),modelValue:r(s),"onUpdate:modelValue":a[11]||(a[11]=u=>k(s)?s.value=u:null),rounded:"circle","total-visible":7,color:"deep-purple-darken-4"},null,8,["length","modelValue"])):z("",!0)]),_:1}),r(V)?(m(),c(Re,{key:0,"is-search-active":r(h),"is-opened":r(y),onCloseDialog:a[12]||(a[12]=u=>y.value=!1),onUpdateSearchOrders:r(j),order:r(V)},null,8,["is-search-active","is-opened","onUpdateSearchOrders","order"])):z("",!0),r(V)?(m(),c(Be,{key:1,"is-search-active":r(h),onUpdateSearchOrders:r(j),onCloseDialog:a[13]||(a[13]=u=>n.value=!1),"is-opened":r(n),order:r(V)},null,8,["is-search-active","onUpdateSearchOrders","is-opened","order"])):z("",!0),t(qe,{"is-opened":r(S),onCloseDialog:a[14]||(a[14]=u=>S.value=!1)},null,8,["is-opened"])])}}});export{Ye as default};
