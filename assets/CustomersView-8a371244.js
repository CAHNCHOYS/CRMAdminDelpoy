import{d as J,S as K,r as q,y as A,e as t,k as a,o as D,b as o,l as N,m as B,t as te,j as X,$ as Y,i as Z,h as ee,f as e,p as g,Q as Se,D as Ne,u as Ce,v as Ve,z as ye,c as we,x as j,g as xe}from"./index-895edbee.js";import{u as H}from"./alert-139ef2ed.js";import{u as ae,a as le,b as F}from"./useFormSchemas-8d352281.js";import{u as ke,a as De,_ as Ue}from"./ElementsTable.vue_vue_type_script_setup_true_lang-1b2db23d.js";const $e={class:"text-error"},Me=J({__name:"CustomersDeleteDialog",props:{isOpened:{type:Boolean},customer:null,isSearchActive:{type:Boolean}},emits:["closeDialog","updateSearchCustomers"],setup(n,{emit:C}){const i=n,V=H(),U=K(),y=X(),p=q(!1),w=async()=>{var d;try{p.value=!0,await Y.deleteCustomer(i.customer.id),U.deleteCustomer(i.customer.id),i.isSearchActive&&C("updateSearchCustomers"),V.showMessage("success","Клиент был успешно удален!")}catch(c){if(Z(c)){if(((d=c.response)==null?void 0:d.status)===401){y.push({name:"login-page",query:{isExpiredToken:"true",redirectedFrom:"customers-page"}});return}V.showMessage("error",ee(c))}else V.showMessage("error","Ошибка при удалении клиента!")}finally{C("closeDialog"),p.value=!1}};return(d,c)=>{const h=a("v-card-title"),x=a("v-card-text"),b=a("v-btn"),$=a("v-card-actions"),m=a("v-card"),E=a("v-dialog");return D(),A(E,{width:"auto","model-value":n.isOpened,persistent:!0,transition:"dialog-bottom-transition"},{default:t(()=>[o(m,{color:"white",class:"pa-4","max-width":450},{default:t(()=>[o(h,{class:"text-h5 mb-4 pa-0 font-weight-bold"},{default:t(()=>[N("Подтвердите удаление клиента")]),_:1}),o(x,{class:"text-h6 mb-4 pa-0"},{default:t(()=>[N(" Вы уверены что хотиет удалить клиента "),B("span",$e,te(n.customer.firstName+" "+n.customer.secondName),1),N(" ? ")]),_:1}),o($,{class:"justify-center pa-0"},{default:t(()=>[o(b,{onClick:c[0]||(c[0]=v=>d.$emit("closeDialog")),height:"40",color:"blue-darken-4",variant:"flat"},{default:t(()=>[N(" Нет ")]),_:1}),o(b,{height:"40",color:"error",variant:"flat",loading:p.value,onClick:w},{default:t(()=>[N("Да")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["model-value"])}}}),Ae=B("p",{class:"text-h6"},"Премиум клиент",-1),Ee=J({__name:"CustomersAddDialog",props:{isOpened:{type:Boolean}},emits:["closeDialog"],setup(n,{emit:C}){const{userCustomerSchema:i}=ae(),{resetForm:V,handleSubmit:U,isSubmitting:y}=le({validationSchema:i}),{value:p,errorMessage:w}=F("firstName"),{value:d,errorMessage:c}=F("secondName"),{value:h,errorMessage:x}=F("thirdName"),{value:b,errorMessage:$}=F("phone"),{value:m,errorMessage:E}=F("premium");m.value="Нет";const v=H(),T=K(),O=X(),W=U(async _=>{var l;try{const{data:r}=await Y.addCustomer(_);T.addCustomer({..._,id:r.customerId,fullName:_.secondName+" "+_.firstName+" "+_.thirdName}),v.showMessage("success","Клиент "+_.secondName+" был успешно добавлен!")}catch(r){if(Z(r)){if(((l=r.response)==null?void 0:l.status)===401){O.push({name:"login-page",query:{isExpiredToken:"true",redirectedFrom:"customers-page"}});return}v.showMessage("error",ee(r))}else v.showMessage("error","Ошибка при добавлении клиента")}finally{C("closeDialog"),V()}});return(_,l)=>{const r=a("v-card-title"),k=a("v-text-field"),S=a("v-col"),M=a("v-switch"),P=a("v-btn"),z=a("v-row"),I=a("v-form"),R=a("v-card-actions"),L=a("v-card"),G=a("v-dialog");return D(),A(G,{"model-value":n.isOpened,"onUpdate:modelValue":l[6]||(l[6]=f=>C("closeDialog")),width:"auto",scrollable:"",transition:"dialog-bottom-transition"},{default:t(()=>[o(L,{color:"white",class:"pa-4",width:"450"},{default:t(()=>[o(r,{class:"font-weight-bold text-h6 mb-3"},{default:t(()=>[N(" Добавление нового клиента ")]),_:1}),o(R,null,{default:t(()=>[o(I,{onSubmit:e(W)},{default:t(()=>[o(z,null,{default:t(()=>[o(S,{cols:"12"},{default:t(()=>[o(k,{modelValue:e(p),"onUpdate:modelValue":l[0]||(l[0]=f=>g(p)?p.value=f:null),"error-messages":e(w),label:"Имя"},null,8,["modelValue","error-messages"])]),_:1}),o(S,{cols:"12"},{default:t(()=>[o(k,{modelValue:e(d),"onUpdate:modelValue":l[1]||(l[1]=f=>g(d)?d.value=f:null),"error-messages":e(c),label:"Фамилия"},null,8,["modelValue","error-messages"])]),_:1}),o(S,{cols:"12"},{default:t(()=>[o(k,{modelValue:e(h),"onUpdate:modelValue":l[2]||(l[2]=f=>g(h)?h.value=f:null),"error-messages":e(x),label:"Отчество"},null,8,["modelValue","error-messages"])]),_:1}),o(S,{cols:"12"},{default:t(()=>[o(k,{label:"Номер телефона",modelValue:e(b),"onUpdate:modelValue":l[3]||(l[3]=f=>g(b)?b.value=f:null),"error-messages":e($)},null,8,["modelValue","error-messages"])]),_:1}),o(S,{cols:"12"},{default:t(()=>[Ae,o(M,{modelValue:e(m),"onUpdate:modelValue":l[4]||(l[4]=f=>g(m)?m.value=f:null),"true-value":"Да","false-value":"Нет","hide-details":"",label:e(m),color:"indigo","error-messages":e(E)},null,8,["modelValue","label","error-messages"])]),_:1}),o(S,{cols:"12"},{default:t(()=>[o(P,{color:"green-darken-4",variant:"flat",type:"submit",loading:e(y)},{default:t(()=>[N(" Добавить ")]),_:1},8,["loading"]),o(P,{color:"blue-darken-4",variant:"flat",onClick:l[5]||(l[5]=f=>_.$emit("closeDialog"))},{default:t(()=>[N(" Отмена ")]),_:1})]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["model-value"])}}}),Te=B("p",{class:"text-h6"},"Премиум клиент ?",-1),qe=J({__name:"CustomersEditDialog",props:{isOpened:{type:Boolean},customer:null,isSearchActive:{type:Boolean}},emits:["closeDialog","updateSearchCustomers"],setup(n,{emit:C}){const i=n,V=Se(()=>({firstName:i.customer.firstName,secondName:i.customer.secondName,thirdName:i.customer.thirdName,phone:i.customer.phone,premium:i.customer.premium})),{userCustomerSchema:U}=ae(),{resetForm:y,handleSubmit:p,isSubmitting:w}=le({validationSchema:U,initialValues:V}),{value:d,errorMessage:c}=F("firstName"),{value:h,errorMessage:x}=F("secondName"),{value:b,errorMessage:$}=F("thirdName"),{value:m,errorMessage:E}=F("phone"),{value:v}=F("premium"),T=H(),O=K(),W=X(),_=p(async l=>{var r;console.log(l);try{await Y.updateCustomer(l,i.customer.id),O.updateCustomer({...l,id:i.customer.id,fullName:l.secondName+" "+l.firstName+" "+l.thirdName}),i.isSearchActive&&C("updateSearchCustomers"),T.showMessage("success","Клиент был успешно изменен")}catch(k){if(Z(k)){if(((r=k.response)==null?void 0:r.status)===401){W.push({name:"login-page",query:{isExpiredToken:"true",redirectedFrom:"customers-page"}});return}T.showMessage("error",ee(k))}else T.showMessage("error","Ошибка при изменении клиента")}finally{y(),C("closeDialog")}});return(l,r)=>{const k=a("v-card-title"),S=a("v-text-field"),M=a("v-col"),P=a("v-switch"),z=a("v-btn"),I=a("v-row"),R=a("v-form"),L=a("v-card-actions"),G=a("v-card"),f=a("v-dialog");return D(),A(f,{"model-value":n.isOpened,"onUpdate:modelValue":r[6]||(r[6]=s=>l.$emit("closeDialog")),scrollable:"",width:"auto"},{default:t(()=>[o(G,{width:"450",color:"white",class:"pa-4"},{default:t(()=>[o(k,{class:"text-h6 font-weight-bold"},{default:t(()=>[N(" Редактирование клиента ")]),_:1}),o(L,null,{default:t(()=>[o(R,{onSubmit:e(_)},{default:t(()=>[o(I,null,{default:t(()=>[o(M,{cols:"12"},{default:t(()=>[o(S,{modelValue:e(d),"onUpdate:modelValue":r[0]||(r[0]=s=>g(d)?d.value=s:null),"error-messages":e(c),label:"Имя"},null,8,["modelValue","error-messages"])]),_:1}),o(M,{cols:"12"},{default:t(()=>[o(S,{modelValue:e(h),"onUpdate:modelValue":r[1]||(r[1]=s=>g(h)?h.value=s:null),"error-messages":e(x),label:"Фамилия"},null,8,["modelValue","error-messages"])]),_:1}),o(M,{cols:"12"},{default:t(()=>[o(S,{modelValue:e(b),"onUpdate:modelValue":r[2]||(r[2]=s=>g(b)?b.value=s:null),"error-messages":e($),label:"Отчество"},null,8,["modelValue","error-messages"])]),_:1}),o(M,{cols:"12"},{default:t(()=>[o(S,{label:"Номер телефона",modelValue:e(m),"onUpdate:modelValue":r[3]||(r[3]=s=>g(m)?m.value=s:null),"error-messages":e(E)},null,8,["modelValue","error-messages"])]),_:1}),o(M,{cols:"12"},{default:t(()=>[Te,o(P,{modelValue:e(v),"onUpdate:modelValue":r[4]||(r[4]=s=>g(v)?v.value=s:null),"true-value":"Да","false-value":"Нет","hide-details":"",label:e(v),color:"indigo"},null,8,["modelValue","label"])]),_:1}),o(M,{cols:"12"},{default:t(()=>[o(z,{color:"green-darken-4",variant:"flat",type:"submit",loading:e(w)},{default:t(()=>[N(" Обновить ")]),_:1},8,["loading"]),o(z,{color:"blue-darken-4",variant:"flat",onClick:r[5]||(r[5]=s=>l.$emit("closeDialog"))},{default:t(()=>[N(" Отмена ")]),_:1})]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["model-value"])}}}),Fe=(n,C,i)=>{const V=H(),U=q(n.query.secondName||""),y=q(+n.query.premium||0),p=q(!1),w=q([]),d=q(!1),c=q(!1),h=q(!1),x=()=>{U.value="",p.value=!1,y.value=0,d.value=!1,w.value=[],C.push({name:"customers-page",query:{}})},b=()=>{C.push({name:"customers-page",query:{...n.query,secondName:U.value,searchWithPremium:String(p.value),premium:y.value}})},$=async()=>{try{c.value=!0;const{data:m}=await Y.getSearchedCustomers({userId:i,premium:+n.query.premium,secondName:n.query.secondName,searchWithPremium:n.query.searchWithPremium});w.value=m.customers,d.value=!0}catch(m){Z(m)?V.showMessage("error",ee(m)):V.showMessage("error","Ошибка при поиске товаров!")}finally{c.value=!1}};return Ne([()=>n.query.secondName,()=>n.query.premium,()=>n.query.searchWithPremium],async()=>{n.query.secondName===void 0&&!n.query.premium||$()},{immediate:!0}),{premium:y,searchWithPremium:p,isSearchFormActive:h,isSearchActive:d,isSearchLoading:c,secondName:U,searchedCustomers:w,searchUserCustomers:$,addSearchQuery:b,resetSearch:x}},Pe={class:"text-h6"},Be=B("h2",{class:"title text-h2 mb-5"},"Клиенты",-1),Oe=B("span",{class:"text-wrap"}," Сбросить поиск",-1),We=B("span",{class:"text-wrap"}," Закрыть поиск",-1),Ie=J({__name:"CustomersView",setup(n){const C=K(),i=H(),V=Ce(),U=q([{fieldText:"Имя",fieldName:"firstName"},{fieldText:"Фамилия",fieldName:"secondName"},{fieldText:"Отчество",fieldName:"thirdName"},{fieldText:"Телефон",fieldName:"phone"},{fieldText:"Есть премиум",fieldName:"premium"}]),y=q("firstName"),{customers:p,customersErrorMessage:w}=Ve(C),{isAddDialogActive:d,isEditDialogActive:c,isDeleteDialogActive:h,itemToEdit:x,openDialog:b}=ke(),$=xe(),m=X(),{isSearchFormActive:E,isSearchLoading:v,searchWithPremium:T,premium:O,isSearchActive:W,secondName:_,searchedCustomers:l,addSearchQuery:r,resetSearch:k,searchUserCustomers:S}=Fe($,m,V.currentUser.id),M=ye(()=>W.value?l.value:p.value),{currentPage:P,paginatedElements:z,isInverseSort:I,elementsPerPageCount:R,totalPages:L,setSortField:G}=De({tableElements:M,pageName:"customers-page",sortField:y,route:$,router:m});return(f,s)=>{const re=a("v-snackbar"),ne=a("TableActions"),ue=a("v-text-field"),Q=a("v-col"),ie=a("v-checkbox"),de=a("v-switch"),me=a("v-scale-transition"),oe=a("v-btn"),se=a("v-row"),ce=a("v-expand-transition"),pe=a("v-alert-title"),ve=a("v-alert"),_e=a("v-progress-circular"),fe=a("v-sheet"),ge=a("v-pagination"),he=a("v-card");return D(),we("div",null,[o(re,{modelValue:e(i).isMessageShown,"onUpdate:modelValue":s[0]||(s[0]=u=>e(i).isMessageShown=u),"max-width":500,color:e(i).messageType,position:"fixed"},{default:t(()=>[B("p",Pe,te(e(i).messageText),1)]),_:1},8,["modelValue","color"]),Be,o(he,{color:"white",elevation:"3",class:"pa-5 mb-6 rounded-lg mx-sm-0 mx-n5"},{default:t(()=>[o(ne,{count:e(R),"onUpdate:count":s[1]||(s[1]=u=>g(R)?R.value=u:null),onToggleAddDialog:s[2]||(s[2]=u=>d.value=!0),onToggleSearch:s[3]||(s[3]=u=>E.value=!e(E)),"is-badge-active":f.$route.query.secondName!==void 0},{default:t(()=>[N(" Все клиенты ")]),_:1},8,["count","is-badge-active"]),o(ce,null,{default:t(()=>[e(E)?(D(),A(se,{key:0,class:"mb-5",align:"center"},{default:t(()=>[o(Q,{sm:"8",cols:"12"},{default:t(()=>[o(ue,{label:"Имя клиента",modelValue:e(_),"onUpdate:modelValue":s[4]||(s[4]=u=>g(_)?_.value=u:null),"onClick:clear":s[5]||(s[5]=u=>_.value="")},null,8,["modelValue"])]),_:1}),o(Q,{sm:"auto",cols:"6"},{default:t(()=>[o(ie,{modelValue:e(T),"onUpdate:modelValue":s[6]||(s[6]=u=>g(T)?T.value=u:null),color:"indigo-darken-4",label:"Искать с премиумом"},null,8,["modelValue"])]),_:1}),o(me,{"leave-absolute":!0},{default:t(()=>[e(T)?(D(),A(Q,{key:0,sm:"auto",cols:"6"},{default:t(()=>[o(de,{modelValue:e(O),"onUpdate:modelValue":s[7]||(s[7]=u=>g(O)?O.value=u:null),"true-value":1,"false-value":0,color:"indigo-darken-4",label:"Есть премиум?"},null,8,["modelValue"])]),_:1})):j("",!0)]),_:1}),o(Q,{cols:"12"},{default:t(()=>[o(se,null,{default:t(()=>[o(Q,{sm:"auto",cols:"6"},{default:t(()=>[o(oe,{variant:"flat",disabled:e(v),color:"green-darken-3",onClick:e(r),block:""},{default:t(()=>[N(" Искать ")]),_:1},8,["disabled","onClick"])]),_:1}),o(Q,{sm:"auto",cols:"6"},{default:t(()=>[o(oe,{variant:"flat",disabled:e(v),color:"error",onClick:e(k),block:""},{default:t(()=>[Oe]),_:1},8,["disabled","onClick"])]),_:1}),o(Q,{sm:"auto",cols:"12"},{default:t(()=>[o(oe,{variant:"flat",disabled:e(v),color:"blue-darken-4",onClick:s[8]||(s[8]=u=>E.value=!1),block:""},{default:t(()=>[We]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1})):j("",!0)]),_:1}),e(w)?(D(),A(ve,{key:0,type:"error",border:"end",variant:"tonal"},{default:t(()=>[o(pe,{class:"mb-2"},{default:t(()=>[N(" Ошибка при загрузке клиентов")]),_:1}),B("p",null,te(e(w)),1)]),_:1})):e(v)?j("",!0):(D(),A(Ue,{key:1,items:e(z),fields:U.value,"current-sort-field":y.value,onUpdateSortField:s[9]||(s[9]=u=>e(G)(u)),"is-inverse-sort":e(I),onOpenDialog:s[10]||(s[10]=(u,be)=>e(b)(u,be)),"no-data-text":"Клиенты не найдены"},null,8,["items","fields","current-sort-field","is-inverse-sort"])),e(v)?(D(),A(fe,{key:2,class:"text-center mb-2"},{default:t(()=>[o(_e,{indeterminate:"",size:"32",color:"green"})]),_:1})):j("",!0),e(M).length?(D(),A(ge,{key:3,length:e(L),modelValue:e(P),"onUpdate:modelValue":s[11]||(s[11]=u=>g(P)?P.value=u:null),rounded:"circle","total-visible":7,color:"deep-purple-darken-4"},null,8,["length","modelValue"])):j("",!0)]),_:1}),e(x)?(D(),A(Me,{key:0,"is-opened":e(h),onCloseDialog:s[12]||(s[12]=u=>h.value=!1),"is-search-active":e(W),onUpdateSearchCustomers:e(S),customer:e(x)},null,8,["is-opened","is-search-active","onUpdateSearchCustomers","customer"])):j("",!0),e(x)?(D(),A(qe,{key:1,"is-opened":e(c),onCloseDialog:s[13]||(s[13]=u=>c.value=!1),"is-search-active":e(W),onUpdateSearchCustomers:e(S),customer:e(x)},null,8,["is-opened","is-search-active","onUpdateSearchCustomers","customer"])):j("",!0),o(Ee,{"is-opened":e(d),onCloseDialog:s[14]||(s[14]=u=>d.value=!1)},null,8,["is-opened"])])}}});export{Ie as default};
