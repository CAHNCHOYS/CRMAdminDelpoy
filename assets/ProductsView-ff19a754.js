import{A as Ve,r as _,u as we,z as Q,y as W,B as le,f as ae,g as se,d as H,h as l,o as h,c as F,k as $,t as T,a as e,b as t,C as ee,D as ne,x as E,l as re,e as o,m as A,q as D,j as I,s as ue,E as $e,F as te,G as oe,T as Se,p as ke,n as Me,i as Ue,v as Ce,_ as Ae}from"./index-6edf1a79.js";import{u as ce,a as de,b as z}from"./useFormSchemas-ddd00117.js";const X=Ve("userProducts",()=>{const a=_([]),i=we(),r=_(!1),c=_(!1),n=_(""),s=_(!1),u=_(!1),v=_(""),p=_("success");async function b(){c.value=!0;const m=await Q({method:"get",url:"/AllUserProducts/"+i.currentUser.id});"error"in m?(console.log(m.error),r.value=!0,n.value=m.error):m.data&&(a.value=m.data),c.value=!1}async function V(m){const w=await Q({url:"/DeleteProduct/"+m,method:"delete"});u.value=!0,"error"in w?(p.value="error",v.value=w.error):(a.value=a.value.filter(P=>P.id!=m),p.value="success",v.value="Товар был успешно удален!"),setTimeout(()=>u.value=!1,3500)}async function y(m,w){const P=await Q({url:"/UpdateUserProduct",method:"patch",body:{...m,userId:i.currentUser.id,productId:w}});if(console.log(P),u.value=!0,"error"in P)p.value="error",v.value=P.error;else{let M=a.value.findIndex(L=>L.id===w);a.value[M]=P.data,p.value="success",v.value="Товар был изменен"}setTimeout(()=>u.value=!1,3500)}async function S(m){const w=await Q({url:"/AddProduct",method:"post",body:{...m,userId:i.currentUser.id}});u.value=!0,"error"in w?(p.value="error",v.value=w.error):(a.value.push(w.data),p.value="success",v.value=`Товар ${m.name} был успешно добавлен!`),setTimeout(()=>u.value=!1,3500)}return{userProducts:a,isProductsError:r,isProductsFetching:c,loadProductsError:n,isProductActionLoading:s,actionMessageText:v,actionMessageType:p,isActionMessageShown:u,fetchUserProducts:b,deleteUserProduct:V,updateUserProduct:y,addUserProduct:S}}),Ee=(a=_([]),i)=>{const r=ae(),c=se(),n=_(+r.query.currentPage||1),s=_(10),u=W(()=>Math.ceil(a.value.length/s.value)),v=_(!1),p=y=>{i.value===y?v.value=!v.value:v.value=!1,i.value=y},b=y=>{n.value=y},V=W(()=>{const y=a.value.length;let S=(n.value-1)*s.value;S>y&&(b(Math.ceil(y/s.value)),S=(n.value-1)*s.value);let m=S+s.value;const w=a.value.slice(S,m);return v.value?[...w].sort((P,M)=>P[i.value]>M[i.value]?-1:1):[...w].sort((P,M)=>P[i.value]>M[i.value]?1:-1)});return le(n,()=>{c.push({name:"products-page",query:{...r.query,currentPage:n.value}})}),{currentPage:n,paginatedProducts:V,totalPages:u,isInverseSort:v,productsByPage:s,setSortField:p}},De=a=>{const i=ae(),r=se(),c=_([{text:"Имя",field:"name"},{text:"Цена(руб)",field:"price"},{text:"Количество",field:"count"},{text:"Категория",field:"category"}]),n=_([+i.query.startPrice||1,+i.query.endPrice||999999]),s=_(i.query.name||""),u=W(()=>a.value.filter(b=>b.price>n.value[0]&&b.price<n.value[1]).filter(b=>b.name.toLowerCase().includes(s.value.toLowerCase()))),v=()=>{s.value="",n.value=[1,999999]};return le([s,n],()=>{console.log("changes appeared!"),r.push({name:"products-page",query:{...i.query,name:s.value,startPrice:n.value[0],endPrice:n.value[1]}})}),{tableSortFields:c,searchName:s,searchPrices:n,filterProducts:u,resetSearch:v}},Te={class:"py-4"},Ie=H({__name:"UserProductRow",props:{product:null},emits:["openDialog"],setup(a,{emit:i}){return(r,c)=>{const n=l("v-btn"),s=l("v-tooltip");return h(),F("tr",null,[$("td",null,T(a.product.name),1),$("td",null,T(a.product.price)+"₽ ",1),$("td",null,T(a.product.count),1),$("td",null,T(a.product.category),1),$("td",Te,[e(s,{text:"Удалить",location:"left"},{activator:t(({props:u})=>[e(n,ee(u,{variant:"flat",icon:"mdi-trash-can",onClick:c[0]||(c[0]=v=>r.$emit("openDialog",a.product,"delete")),color:"error",class:"mr-2"}),null,16)]),_:1}),e(s,{text:"Редактировать",location:"right"},{activator:t(({props:u})=>[e(n,ee(u,{variant:"flat",icon:"mdi-pencil",color:"info",onClick:c[1]||(c[1]=v=>r.$emit("openDialog",a.product,"edit"))}),null,16)]),_:1})])])}}}),ie=()=>{const a=_([]),i=_(!1),r=_("");return ne(async()=>{console.log("I am mounted");const c=await Q({url:"/ProductCategories",method:"get"});"error"in c?(i.value=!0,r.value=c.error):(console.log(c.data),a.value=c.data)}),{categories:a,isCategoriesLoadError:i,categoriesLoadErrorMessage:r}},Be=$("p",{class:"text-h6 font-weight-bold mb-4"},"Редактирование товара",-1),Fe={key:1,class:"text-h6 text-red"},Le=H({__name:"ProductEditDialog",props:{isActive:{type:Boolean},product:null},emits:["closeModal"],setup(a,{emit:i}){const r=a,c=W(()=>{var f,x,B,k;return{name:((f=r.product)==null?void 0:f.name)||"Товар не был выбран",price:((x=r.product)==null?void 0:x.price)||0,count:((B=r.product)==null?void 0:B.count)||0,categoryId:((k=r.product)==null?void 0:k.categoryId)||0}}),{userProductSchema:n}=ce(),{handleSubmit:s,isSubmitting:u}=de({validationSchema:n,initialValues:c}),{value:v,errorMessage:p}=z("name"),{value:b,errorMessage:V}=z("price"),{value:y,errorMessage:S}=z("count"),{value:m,errorMessage:w}=z("categoryId"),{categories:P,isCategoriesLoadError:M,categoriesLoadErrorMessage:L}=ie(),{updateUserProduct:j}=X(),N=s(async f=>{await j(f,r.product.id),i("closeModal")});return(f,x)=>{const B=l("v-card-title"),k=l("v-text-field"),q=l("v-col"),R=l("v-select"),G=l("v-btn"),O=l("v-row"),d=l("v-form"),J=l("v-card-actions"),K=l("v-card"),U=l("v-dialog");return h(),E(U,{transition:"dialog-bottom-transition","max-width":"500","onUpdate:modelValue":x[5]||(x[5]=C=>f.$emit("closeModal")),"model-value":a.isActive},{default:t(()=>[e(K,{class:"pa-5",color:"white",elevation:"4"},{default:t(()=>[e(B,null,{default:t(()=>[Be]),_:1}),e(J,null,{default:t(()=>[e(d,{onSubmit:re(o(N),["prevent"])},{default:t(()=>[e(O,null,{default:t(()=>[e(q,{cols:"12"},{default:t(()=>[e(k,{modelValue:o(v),"onUpdate:modelValue":x[0]||(x[0]=C=>A(v)?v.value=C:null),"error-messages":o(p),label:"Название товара"},null,8,["modelValue","error-messages"])]),_:1}),e(q,{cols:"12"},{default:t(()=>[o(P).length?(h(),E(R,{key:0,modelValue:o(m),"onUpdate:modelValue":x[1]||(x[1]=C=>A(m)?m.value=C:null),label:"Категория товара","error-messages":o(w),items:o(P),"item-title":"name","item-value":"id"},null,8,["modelValue","error-messages","items"])):D("",!0),o(M)?(h(),F("p",Fe,T(o(L)),1)):D("",!0)]),_:1}),e(q,{cols:"6"},{default:t(()=>[e(k,{modelValue:o(y),"onUpdate:modelValue":x[2]||(x[2]=C=>A(y)?y.value=C:null),"error-messages":o(S),label:"Количество",type:"number"},null,8,["modelValue","error-messages"])]),_:1}),e(q,{cols:"6"},{default:t(()=>[e(k,{modelValue:o(b),"onUpdate:modelValue":x[3]||(x[3]=C=>A(b)?b.value=C:null),"error-messages":o(V),label:"Цена",type:"number",suffix:"руб"},null,8,["modelValue","error-messages"])]),_:1}),e(q,{cols:"12"},{default:t(()=>[e(G,{color:"green-darken-4",variant:"flat",loading:o(u),type:"submit"},{default:t(()=>[I(" Сохранить ")]),_:1},8,["loading"]),e(G,{color:"blue-darken-4",variant:"flat",onClick:x[4]||(x[4]=C=>f.$emit("closeModal"))},{default:t(()=>[I(" Отмена ")]),_:1})]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["model-value"])}}}),qe=$("p",{class:"font-weight-bold text-h5"},"Подтверждение удаления",-1),Re={class:"text-h6"},Ne={class:"text-red"},ze=$("span",{class:"text-white"},"Нет",-1),je=H({__name:"ProductDeleteDialog",props:{product:null,isActive:{type:Boolean}},emits:["closeModal"],setup(a,{emit:i}){const r=a,c=X(),{deleteUserProduct:n}=c,{isProductActionLoading:s}=ue(c),u=async()=>{s.value=!0,await n(r.product.id),s.value=!1,i("closeModal")};return(v,p)=>{const b=l("v-card-title"),V=l("v-card-text"),y=l("v-btn"),S=l("v-card-actions"),m=l("v-card"),w=l("v-dialog");return h(),E(w,{"model-value":a.isActive,"max-width":450,persistent:""},{default:t(()=>[e(m,{class:"pa-4"},{default:t(()=>[e(b,{class:"pa-0 mb-3"},{default:t(()=>[qe]),_:1}),e(V,{class:"pa-0"},{default:t(()=>{var P;return[$("p",Re,[I(" Вы уверены что хотите удалить товар "),$("span",Ne,T((P=r.product)==null?void 0:P.name),1),I(" с базы данных ? ")])]}),_:1}),e(S,{class:"justify-center"},{default:t(()=>[e(y,{onClick:p[0]||(p[0]=P=>v.$emit("closeModal")),height:"40",color:"blue-darken-4",variant:"flat"},{default:t(()=>[ze]),_:1}),e(y,{height:"40",loading:o(s),color:"error",variant:"flat",onClick:u},{default:t(()=>[I("Да")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["model-value"])}}}),Ge=$("p",{class:"text-h6 font-weight-bold mb-4"},"Добавление нового товара",-1),Oe={key:1,class:"text-h6 text-red"},He=H({__name:"ProductAddDialog",props:{isActive:{type:Boolean}},emits:["closeModal"],setup(a,{emit:i}){const{userProductSchema:r}=ce(),{handleSubmit:c,isSubmitting:n,resetForm:s}=de({validationSchema:r}),{value:u,errorMessage:v}=z("name"),{value:p,errorMessage:b}=z("categoryId"),{value:V,errorMessage:y}=z("count"),{value:S,errorMessage:m}=z("price"),{addUserProduct:w}=X(),{categories:P,isCategoriesLoadError:M,categoriesLoadErrorMessage:L}=ie(),j=c(async N=>{await w(N),s(),i("closeModal")});return(N,f)=>{const x=l("v-card-title"),B=l("v-text-field"),k=l("v-col"),q=l("v-select"),R=l("v-btn"),G=l("v-row"),O=l("v-form"),d=l("v-card-actions"),J=l("v-card"),K=l("v-dialog");return h(),E(K,{transition:"dialog-bottom-transition","max-width":"500","onUpdate:modelValue":f[5]||(f[5]=U=>N.$emit("closeModal")),"model-value":a.isActive},{default:t(()=>[e(J,{class:"pa-5",color:"white",elevation:"4"},{default:t(()=>[e(x,null,{default:t(()=>[Ge]),_:1}),e(d,null,{default:t(()=>[e(O,{onSubmit:re(o(j),["prevent"])},{default:t(()=>[e(G,null,{default:t(()=>[e(k,{cols:"12"},{default:t(()=>[e(B,{modelValue:o(u),"onUpdate:modelValue":f[0]||(f[0]=U=>A(u)?u.value=U:null),"error-messages":o(v),label:"Название товара"},null,8,["modelValue","error-messages"])]),_:1}),e(k,{cols:"12"},{default:t(()=>[o(P).length?(h(),E(q,{key:0,modelValue:o(p),"onUpdate:modelValue":f[1]||(f[1]=U=>A(p)?p.value=U:null),label:"Категория товара","error-messages":o(b),items:o(P),"item-title":"name","item-value":"id"},null,8,["modelValue","error-messages","items"])):D("",!0),o(M)?(h(),F("p",Oe,T(o(L)),1)):D("",!0)]),_:1}),e(k,{cols:"6"},{default:t(()=>[e(B,{modelValue:o(V),"onUpdate:modelValue":f[2]||(f[2]=U=>A(V)?V.value=U:null),"error-messages":o(y),label:"Количество",type:"number"},null,8,["modelValue","error-messages"])]),_:1}),e(k,{cols:"6"},{default:t(()=>[e(B,{modelValue:o(S),"onUpdate:modelValue":f[3]||(f[3]=U=>A(S)?S.value=U:null),"error-messages":o(m),label:"Цена",suffix:"руб",type:"number"},null,8,["modelValue","error-messages"])]),_:1}),e(k,{cols:"12"},{default:t(()=>[e(R,{color:"green-darken-4",variant:"flat",loading:o(n),type:"submit"},{default:t(()=>[I(" Добавить ")]),_:1},8,["loading"]),e(R,{color:"blue-darken-4",variant:"flat",onClick:f[4]||(f[4]=U=>N.$emit("close"))},{default:t(()=>[I(" Отмена ")]),_:1})]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["model-value"])}}}),Je={class:"text-sm-h4 text-h6"},Ke=H({__name:"TableActions",props:{count:null},emits:["update:count","toggleSearch","toggleAddDialog"],setup(a,{emit:i}){const c=_(a.count);return(n,s)=>{const u=l("v-col"),v=l("v-select"),p=l("v-btn"),b=l("v-row");return h(),E(b,{class:"mb-8",align:"center","no-gutters":""},{default:t(()=>[e(u,{class:"flex-grow-1"},{default:t(()=>[$("div",Je,[$e(n.$slots,"default")])]),_:3}),e(u,{cols:"6",sm:"2",class:"order-sm-2 order-3 mx-2"},{default:t(()=>[e(v,{label:"Элементов на странице",variant:"underlined",modelValue:c.value,"onUpdate:modelValue":[s[0]||(s[0]=V=>c.value=V),s[1]||(s[1]=V=>n.$emit("update:count",c.value))],clearable:!1,items:[10,15,20,30,50]},null,8,["modelValue"])]),_:1}),e(u,{cols:"auto",class:"order-sm-3 order-2"},{default:t(()=>[e(p,{onClick:s[2]||(s[2]=V=>n.$emit("toggleSearch")),icon:"mdi-magnify",color:"teal",class:"mr-1"}),e(p,{onClick:s[3]||(s[3]=V=>n.$emit("toggleAddDialog")),icon:"mdi-plus",color:"green"})]),_:1})]),_:3})}}}),Y=a=>(ke("data-v-0c18376f"),a=a(),Me(),a),Qe={class:"text-h6"},We=Y(()=>$("div",{class:"title text-h2 mb-5"},"Товары",-1)),Xe={key:1},Ye=Y(()=>$("div",{class:"text-center mb-3 text-h6"},"Идет загрузка...",-1)),Ze={key:0,class:"mb-6"},et=["onClick"],tt=Y(()=>$("th",{class:"text-left text-h6"},"Действия",-1)),ot={key:4,class:"text-h6"},lt=H({__name:"ProductsView",setup(a){const i=X(),{userProducts:r,loadProductsError:c,isProductsFetching:n,isProductsError:s,isActionMessageShown:u,actionMessageText:v,actionMessageType:p}=ue(i);ne(async()=>{r.value.length||await i.fetchUserProducts()});const b=_(!1),V=_(!1),y=_(!1),S=_(!1),m=_(null),w=(O,d)=>{console.log(d),m.value=O,d==="delete"?b.value=!0:d==="edit"&&(y.value=!0)},{filterProducts:P,searchName:M,searchPrices:L,tableSortFields:j,resetSearch:N}=De(r),f=_(j.value[0].field),{currentPage:x,paginatedProducts:B,totalPages:k,isInverseSort:q,productsByPage:R,setSortField:G}=Ee(P,f);return(O,d)=>{const J=l("v-snackbar"),K=l("v-progress-linear"),U=l("v-text-field"),C=l("v-col"),ve=l("v-range-slider"),me=l("v-btn"),_e=l("v-row"),pe=l("v-form"),ge=l("VExpandTransition"),fe=l("v-icon"),be=l("v-table"),ye=l("v-alert-title"),Pe=l("v-alert"),he=l("v-pagination"),xe=l("v-card");return h(),F("div",null,[e(J,{modelValue:o(u),"onUpdate:modelValue":d[0]||(d[0]=g=>A(u)?u.value=g:null),location:"right bottom","max-width":500,color:o(p)},{default:t(()=>[$("p",Qe,T(o(v)),1)]),_:1},8,["modelValue","color"]),We,e(xe,{color:"white",elevation:"3",class:"pa-5 mb-6 rounded-lg mx-sm-0 mx-n5"},{default:t(()=>[o(r).length?(h(),E(Ke,{key:0,count:o(R),"onUpdate:count":[d[1]||(d[1]=g=>A(R)?R.value=g:null),d[2]||(d[2]=g=>R.value=g)],onToggleAddDialog:d[3]||(d[3]=g=>V.value=!0),onToggleSearch:d[4]||(d[4]=g=>S.value=!S.value)},{default:t(()=>[I(" Все товары("+T(o(r).length)+") ",1)]),_:1},8,["count"])):D("",!0),o(n)?(h(),F("div",Xe,[Ye,e(K,{color:"green",height:"4",indeterminate:""})])):D("",!0),e(ge,null,{default:t(()=>[S.value?(h(),F("div",Ze,[e(pe,null,{default:t(()=>[e(_e,{align:"center"},{default:t(()=>[e(C,{sm:"6",cols:"12"},{default:t(()=>[e(U,{modelValue:o(M),"onUpdate:modelValue":d[5]||(d[5]=g=>A(M)?M.value=g:null),modelModifiers:{lazy:!0},variant:"outlined",label:"Название товара"},null,8,["modelValue"])]),_:1}),e(C,{sm:"6",cols:"12"},{default:t(()=>[e(ve,{modelValue:o(L),"onUpdate:modelValue":d[6]||(d[6]=g=>A(L)?L.value=g:null),modelModifiers:{lazy:!0},"thumb-label":"always",min:"1",step:"10",max:"999999",strict:"",color:"blue-grey-darken-2",label:"Цена:","hide-details":"auto"},null,8,["modelValue"])]),_:1}),e(C,{cols:"auto"},{default:t(()=>[e(me,{variant:"flat",color:"red-darken-4",onClick:o(N)},{default:t(()=>[I(" Сбросить поиск ")]),_:1},8,["onClick"])]),_:1})]),_:1})]),_:1})])):D("",!0)]),_:1}),o(r).length?(h(),E(be,{key:2,density:"comfortable"},{default:t(()=>[$("thead",null,[$("tr",null,[(h(!0),F(te,null,oe(o(j),g=>(h(),F("th",{key:g.text,class:"text-left text-h6",onClick:Z=>o(G)(g.field)},[I(T(g.text)+" ",1),Ue(e(fe,{icon:o(q)?"mdi-arrow-up-thin":"mdi-arrow-down-thin"},null,8,["icon"]),[[Ce,f.value===g.field]])],8,et))),128)),tt])]),$("tbody",null,[e(Se,{name:"list",appear:""},{default:t(()=>[(h(!0),F(te,null,oe(o(B),(g,Z)=>(h(),E(Ie,{product:g,key:g.id,onOpenDialog:w,"data-index":Z},null,8,["product","data-index"]))),128))]),_:1})])]),_:1})):D("",!0),o(s)?(h(),E(Pe,{key:3,type:"error",border:"end",variant:"tonal"},{default:t(()=>[e(ye,{class:"mb-2"},{default:t(()=>[I(" Ошибка при загрузке товаров ")]),_:1}),$("p",null,T(o(c)),1)]),_:1})):o(r).length===0&&!o(n)?(h(),F("p",ot," Пока в таблице нет товаров, добавьте хоть одинф ")):D("",!0),e(he,{length:o(k),modelValue:o(x),"onUpdate:modelValue":d[7]||(d[7]=g=>A(x)?x.value=g:null),rounded:"circle","total-visible":7,color:"primary"},null,8,["length","modelValue"])]),_:1}),m.value?(h(),E(Le,{key:0,product:m.value,onCloseModal:d[8]||(d[8]=g=>y.value=!1),"is-active":y.value},null,8,["product","is-active"])):D("",!0),m.value?(h(),E(je,{key:1,"is-active":b.value,product:m.value,onCloseModal:d[9]||(d[9]=g=>b.value=!1)},null,8,["is-active","product"])):D("",!0),e(He,{onCloseModal:d[10]||(d[10]=g=>V.value=!1),"is-active":V.value},null,8,["is-active"])])}}});const nt=Ae(lt,[["__scopeId","data-v-0c18376f"]]);export{nt as default};
