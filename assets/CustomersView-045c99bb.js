import{d as R,aj as j,r as $,O as D,e as a,Z as K,o as w,b as s,s as X,p as V,a2 as pe,q,t as Z,v as Y,F as E,f as z,as as I,i as Q,h as G,x as te,g as e,z as W,B as d,C as T,D as v,at as ee,ah as ge,W as ve,u as he,J as Ve,P as be,c as Se,U as Ce,M as O,k as Ne,l as ye,a3 as we,L as ke,N as xe,n as De,m as Ue,a5 as _e,$ as $e,a6 as Ae,G as Me}from"./index-619baa70.js";import{u as L}from"./alert-163d7f92.js";import{u as se,a as Te,b as Ee,_ as Fe}from"./useLogoutHandler-593ec046.js";import{u as oe,a as re,b as A}from"./useFormSchemas-8a5fa9a3.js";const qe={class:"text-error"},Pe=R({__name:"CustomersDeleteDialog",props:{isOpened:{type:Boolean},customer:null,isSearchActive:{type:Boolean}},emits:["closeDialog","updateSearchCustomers"],setup(r,{emit:b}){const n=r,C=L(),k=j(),{handleLogout:N}=se("customers-page"),p=$(!1),y=async()=>{var i;try{p.value=!0,await I.deleteCustomer(n.customer.id),k.deleteCustomer(n.customer.id),n.isSearchActive&&b("updateSearchCustomers"),C.showMessage("success","Клиент был успешно удален!")}catch(m){if(Q(m)){if(((i=m.response)==null?void 0:i.status)===401){await N();return}C.showMessage("error",G(m))}else C.showMessage("error","Ошибка при удалении клиента!")}finally{p.value=!1,b("closeDialog")}};return(i,m)=>(w(),D(K,{width:"auto","model-value":r.isOpened,persistent:!0,transition:"dialog-bottom-transition"},{default:a(()=>[s(z,{color:"white",class:"pa-4","max-width":450},{default:a(()=>[s(X,{class:"text-h5 mb-4 pa-0 font-weight-bold"},{default:a(()=>[V("Подтвердите удаление клиента")]),_:1}),s(pe,{class:"text-h6 mb-4 pa-0"},{default:a(()=>[V(" Вы уверены что хотиет удалить клиента "),q("span",qe,Z(r.customer.firstName+" "+r.customer.secondName),1),V(" ? ")]),_:1}),s(Y,{class:"justify-center pa-0"},{default:a(()=>[s(E,{onClick:m[0]||(m[0]=S=>i.$emit("closeDialog")),height:"40",color:"blue-darken-4",variant:"flat"},{default:a(()=>[V(" Нет ")]),_:1}),s(E,{height:"40",color:"error",variant:"flat",loading:p.value,onClick:y},{default:a(()=>[V("Да")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["model-value"]))}}),Be=q("p",{class:"text-h6"},"Премиум клиент",-1),Oe=R({__name:"CustomersAddDialog",props:{isOpened:{type:Boolean}},emits:["closeDialog"],setup(r,{emit:b}){const{userCustomerSchema:n}=oe(),{resetForm:C,handleSubmit:k,isSubmitting:N}=re({validationSchema:n}),{value:p,errorMessage:y}=A("firstName"),{value:i,errorMessage:m}=A("secondName"),{value:S,errorMessage:U}=A("thirdName"),{value:x,errorMessage:M}=A("phone"),{value:c,errorMessage:F}=A("premium");c.value="Нет";const h=L(),_=j(),{handleLogout:P}=se("customers-page"),B=k(async g=>{var o;try{const{data:l}=await I.addCustomer(g);_.addCustomer({...g,id:l.customerId,fullName:g.secondName+" "+g.firstName+" "+g.thirdName}),h.showMessage("success","Клиент "+g.secondName+" был успешно добавлен!")}catch(l){if(Q(l)){if(((o=l.response)==null?void 0:o.status)===401){await P();return}h.showMessage("error",G(l))}else h.showMessage("error","Ошибка при добавлении клиента")}finally{b("closeDialog"),C()}});return(g,o)=>(w(),D(K,{"model-value":r.isOpened,"onUpdate:modelValue":o[6]||(o[6]=l=>b("closeDialog")),width:"auto",scrollable:"",transition:"dialog-bottom-transition"},{default:a(()=>[s(z,{color:"white",class:"pa-4",width:"450"},{default:a(()=>[s(X,{class:"font-weight-bold text-h6 mb-3"},{default:a(()=>[V(" Добавление нового клиента ")]),_:1}),s(Y,null,{default:a(()=>[s(te,{onSubmit:e(B)},{default:a(()=>[s(W,null,{default:a(()=>[s(d,{cols:"12"},{default:a(()=>[s(T,{modelValue:e(p),"onUpdate:modelValue":o[0]||(o[0]=l=>v(p)?p.value=l:null),"error-messages":e(y),label:"Имя"},null,8,["modelValue","error-messages"])]),_:1}),s(d,{cols:"12"},{default:a(()=>[s(T,{modelValue:e(i),"onUpdate:modelValue":o[1]||(o[1]=l=>v(i)?i.value=l:null),"error-messages":e(m),label:"Фамилия"},null,8,["modelValue","error-messages"])]),_:1}),s(d,{cols:"12"},{default:a(()=>[s(T,{modelValue:e(S),"onUpdate:modelValue":o[2]||(o[2]=l=>v(S)?S.value=l:null),"error-messages":e(U),label:"Отчество"},null,8,["modelValue","error-messages"])]),_:1}),s(d,{cols:"12"},{default:a(()=>[s(T,{label:"Номер телефона",modelValue:e(x),"onUpdate:modelValue":o[3]||(o[3]=l=>v(x)?x.value=l:null),"error-messages":e(M)},null,8,["modelValue","error-messages"])]),_:1}),s(d,{cols:"12"},{default:a(()=>[Be,s(ee,{modelValue:e(c),"onUpdate:modelValue":o[4]||(o[4]=l=>v(c)?c.value=l:null),"true-value":"Да","false-value":"Нет","hide-details":"",label:e(c),color:"indigo","error-messages":e(F)},null,8,["modelValue","label","error-messages"])]),_:1}),s(d,{cols:"12"},{default:a(()=>[s(E,{color:"green-darken-4",variant:"flat",type:"submit",loading:e(N)},{default:a(()=>[V(" Добавить ")]),_:1},8,["loading"]),s(E,{color:"blue-darken-4",variant:"flat",onClick:o[5]||(o[5]=l=>g.$emit("closeDialog"))},{default:a(()=>[V(" Отмена ")]),_:1})]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["model-value"]))}}),Le=q("p",{class:"text-h6"},"Премиум клиент ?",-1),We=R({__name:"CustomersEditDialog",props:{isOpened:{type:Boolean},customer:null,isSearchActive:{type:Boolean}},emits:["closeDialog","updateSearchCustomers"],setup(r,{emit:b}){const n=r,C=ge(()=>({firstName:n.customer.firstName,secondName:n.customer.secondName,thirdName:n.customer.thirdName,phone:n.customer.phone,premium:n.customer.premium})),{userCustomerSchema:k}=oe(),{resetForm:N,handleSubmit:p,isSubmitting:y}=re({validationSchema:k,initialValues:C}),{value:i,errorMessage:m}=A("firstName"),{value:S,errorMessage:U}=A("secondName"),{value:x,errorMessage:M}=A("thirdName"),{value:c,errorMessage:F}=A("phone"),{value:h}=A("premium"),_=L(),P=j(),{handleLogout:B}=se("customers-page"),g=p(async o=>{var l;try{await I.updateCustomer(o,n.customer.id),P.updateCustomer({...o,id:n.customer.id,fullName:o.secondName+" "+o.firstName+" "+o.thirdName}),n.isSearchActive&&b("updateSearchCustomers"),_.showMessage("success","Клиент был успешно изменен")}catch(f){if(Q(f)){if(((l=f.response)==null?void 0:l.status)===401){await B();return}_.showMessage("error",G(f))}else _.showMessage("error","Ошибка при изменении клиента")}finally{N(),b("closeDialog")}});return(o,l)=>(w(),D(K,{"model-value":r.isOpened,"onUpdate:modelValue":l[6]||(l[6]=f=>o.$emit("closeDialog")),scrollable:"",width:"auto"},{default:a(()=>[s(z,{width:"450",color:"white",class:"pa-4"},{default:a(()=>[s(X,{class:"text-h6 font-weight-bold"},{default:a(()=>[V(" Редактирование клиента ")]),_:1}),s(Y,null,{default:a(()=>[s(te,{onSubmit:e(g)},{default:a(()=>[s(W,null,{default:a(()=>[s(d,{cols:"12"},{default:a(()=>[s(T,{modelValue:e(i),"onUpdate:modelValue":l[0]||(l[0]=f=>v(i)?i.value=f:null),"error-messages":e(m),label:"Имя"},null,8,["modelValue","error-messages"])]),_:1}),s(d,{cols:"12"},{default:a(()=>[s(T,{modelValue:e(S),"onUpdate:modelValue":l[1]||(l[1]=f=>v(S)?S.value=f:null),"error-messages":e(U),label:"Фамилия"},null,8,["modelValue","error-messages"])]),_:1}),s(d,{cols:"12"},{default:a(()=>[s(T,{modelValue:e(x),"onUpdate:modelValue":l[2]||(l[2]=f=>v(x)?x.value=f:null),"error-messages":e(M),label:"Отчество"},null,8,["modelValue","error-messages"])]),_:1}),s(d,{cols:"12"},{default:a(()=>[s(T,{label:"Номер телефона",modelValue:e(c),"onUpdate:modelValue":l[3]||(l[3]=f=>v(c)?c.value=f:null),"error-messages":e(F)},null,8,["modelValue","error-messages"])]),_:1}),s(d,{cols:"12"},{default:a(()=>[Le,s(ee,{modelValue:e(h),"onUpdate:modelValue":l[4]||(l[4]=f=>v(h)?h.value=f:null),"true-value":"Да","false-value":"Нет","hide-details":"",label:e(h),color:"indigo"},null,8,["modelValue","label"])]),_:1}),s(d,{cols:"12"},{default:a(()=>[s(E,{color:"green-darken-4",variant:"flat",type:"submit",loading:e(y)},{default:a(()=>[V(" Обновить ")]),_:1},8,["loading"]),s(E,{color:"blue-darken-4",variant:"flat",onClick:l[5]||(l[5]=f=>o.$emit("closeDialog"))},{default:a(()=>[V(" Отмена ")]),_:1})]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["model-value"]))}}),Re=(r,b,n)=>{const C=L(),k=$(r.query.secondName||""),N=$(+r.query.premium||0),p=$(!1),y=$([]),i=$(!1),m=$(!1),S=$(!1),U=()=>{k.value="",p.value=!1,N.value=0,i.value=!1,y.value=[],b.push({name:"customers-page",query:{}})},x=()=>{b.push({name:"customers-page",query:{...r.query,secondName:k.value,searchWithPremium:String(p.value),premium:N.value}})},M=async()=>{try{m.value=!0;const{data:c}=await I.getSearchedCustomers({userId:n,premium:+r.query.premium,secondName:r.query.secondName,searchWithPremium:r.query.searchWithPremium});y.value=c.customers,i.value=!0}catch(c){Q(c)?C.showMessage("error",G(c)):C.showMessage("error","Ошибка при поиске товаров!")}finally{m.value=!1}};return ve([()=>r.query.secondName,()=>r.query.premium,()=>r.query.searchWithPremium],async()=>{r.query.secondName===void 0&&!r.query.premium||M()},{immediate:!0}),{premium:N,searchWithPremium:p,isSearchFormActive:S,isSearchActive:i,isSearchLoading:m,secondName:k,searchedCustomers:y,searchUserCustomers:M,addSearchQuery:x,resetSearch:U}},je={class:"text-h6"},ze=q("h2",{class:"title text-h2 mb-5"},"Клиенты",-1),Ie=q("span",{class:"text-wrap"}," Сбросить поиск",-1),Qe=q("span",{class:"text-wrap"}," Закрыть поиск",-1),Ke=R({__name:"CustomersView",setup(r){const b=j(),n=L(),C=he(),k=$([{fieldText:"Имя",fieldName:"firstName"},{fieldText:"Фамилия",fieldName:"secondName"},{fieldText:"Отчество",fieldName:"thirdName"},{fieldText:"Телефон",fieldName:"phone"},{fieldText:"Есть премиум",fieldName:"premium"}]),N=$("firstName"),{customers:p,customersErrorMessage:y}=Ve(b),{isAddDialogActive:i,isEditDialogActive:m,isDeleteDialogActive:S,itemToEdit:U,openDialog:x}=Te(),M=Ne(),c=ye(),{isSearchFormActive:F,isSearchLoading:h,searchWithPremium:_,premium:P,isSearchActive:B,secondName:g,searchedCustomers:o,addSearchQuery:l,resetSearch:f,searchUserCustomers:ae}=Re(M,c,C.currentUser.id),le=be(()=>B.value?o.value:p.value),{currentPage:H,paginatedElements:ue,isInverseSort:ne,elementsPerPageCount:J,totalPages:ie,setSortField:de}=Ee({tableElements:le,pageName:"customers-page",sortField:N,route:M,router:c});return(me,t)=>{const ce=Me("TableActions");return w(),Se("div",null,[s(Ce,{modelValue:e(n).isMessageShown,"onUpdate:modelValue":t[0]||(t[0]=u=>e(n).isMessageShown=u),color:e(n).messageType,"location-strategy":"connected"},{default:a(()=>[q("p",je,Z(e(n).messageText),1)]),_:1},8,["modelValue","color"]),ze,s(z,{color:"white",elevation:"3",class:"pa-5 mb-6 rounded-lg mx-sm-0 mx-n5"},{default:a(()=>[s(ce,{count:e(J),"onUpdate:count":t[1]||(t[1]=u=>v(J)?J.value=u:null),onToggleAddDialog:t[2]||(t[2]=u=>i.value=!0),onToggleSearch:t[3]||(t[3]=u=>F.value=!e(F)),"is-badge-active":me.$route.query.secondName!==void 0},{default:a(()=>[V(" Все клиенты ")]),_:1},8,["count","is-badge-active"]),s(we,null,{default:a(()=>[e(F)?(w(),D(W,{key:0,class:"mb-5",align:"center"},{default:a(()=>[s(d,{sm:"8",cols:"12"},{default:a(()=>[s(T,{label:"Имя клиента",modelValue:e(g),"onUpdate:modelValue":t[4]||(t[4]=u=>v(g)?g.value=u:null),"onClick:clear":t[5]||(t[5]=u=>g.value="")},null,8,["modelValue"])]),_:1}),s(d,{sm:"auto",cols:"6"},{default:a(()=>[s(ke,{modelValue:e(_),"onUpdate:modelValue":t[6]||(t[6]=u=>v(_)?_.value=u:null),color:"indigo-darken-4",label:"Искать с премиумом"},null,8,["modelValue"])]),_:1}),s(xe,{"leave-absolute":!0},{default:a(()=>[e(_)?(w(),D(d,{key:0,sm:"auto",cols:"6"},{default:a(()=>[s(ee,{modelValue:e(P),"onUpdate:modelValue":t[7]||(t[7]=u=>v(P)?P.value=u:null),"true-value":1,"false-value":0,color:"indigo-darken-4",label:"Есть премиум?"},null,8,["modelValue"])]),_:1})):O("",!0)]),_:1}),s(d,{cols:"12"},{default:a(()=>[s(W,null,{default:a(()=>[s(d,{sm:"auto",cols:"6"},{default:a(()=>[s(E,{variant:"flat",disabled:e(h),color:"green-darken-3",onClick:e(l),block:""},{default:a(()=>[V(" Искать ")]),_:1},8,["disabled","onClick"])]),_:1}),s(d,{sm:"auto",cols:"6"},{default:a(()=>[s(E,{variant:"flat",disabled:e(h),color:"error",onClick:e(f),block:""},{default:a(()=>[Ie]),_:1},8,["disabled","onClick"])]),_:1}),s(d,{sm:"auto",cols:"12"},{default:a(()=>[s(E,{variant:"flat",disabled:e(h),color:"blue-darken-4",onClick:t[8]||(t[8]=u=>F.value=!1),block:""},{default:a(()=>[Qe]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1})):O("",!0)]),_:1}),e(y)?(w(),D(Ue,{key:0,type:"error",border:"end",variant:"tonal"},{default:a(()=>[s(De,{class:"mb-2"},{default:a(()=>[V(" Ошибка при загрузке клиентов")]),_:1}),q("p",null,Z(e(y)),1)]),_:1})):e(h)?O("",!0):(w(),D(Fe,{key:1,items:e(ue),fields:k.value,"current-sort-field":N.value,onUpdateSortField:t[9]||(t[9]=u=>e(de)(u)),"is-inverse-sort":e(ne),onOpenDialog:t[10]||(t[10]=(u,fe)=>e(x)(u,fe)),"no-data-text":"Клиенты не найдены"},null,8,["items","fields","current-sort-field","is-inverse-sort"])),e(h)?(w(),D($e,{key:2,class:"text-center mb-2"},{default:a(()=>[s(_e,{indeterminate:"",size:"32",color:"green"})]),_:1})):O("",!0),e(le).length?(w(),D(Ae,{key:3,length:e(ie),modelValue:e(H),"onUpdate:modelValue":t[11]||(t[11]=u=>v(H)?H.value=u:null),rounded:"circle","total-visible":7,color:"deep-purple-darken-4"},null,8,["length","modelValue"])):O("",!0)]),_:1}),e(U)?(w(),D(Pe,{key:0,"is-opened":e(S),onCloseDialog:t[12]||(t[12]=u=>S.value=!1),"is-search-active":e(B),onUpdateSearchCustomers:e(ae),customer:e(U)},null,8,["is-opened","is-search-active","onUpdateSearchCustomers","customer"])):O("",!0),e(U)?(w(),D(We,{key:1,"is-opened":e(m),onCloseDialog:t[13]||(t[13]=u=>m.value=!1),"is-search-active":e(B),onUpdateSearchCustomers:e(ae),customer:e(U)},null,8,["is-opened","is-search-active","onUpdateSearchCustomers","customer"])):O("",!0),s(Oe,{"is-opened":e(i),onCloseDialog:t[14]||(t[14]=u=>i.value=!1)},null,8,["is-opened"])])}}});export{Ke as default};
