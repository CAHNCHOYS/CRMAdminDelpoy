import{r as I,D as xe,P as ee,i as te,h as oe,d as se,z as de,E as re,v as ne,y as g,e as o,j as ae,k as s,o as v,b as t,n as ue,f as e,p as A,l as x,t as Y,m as C,u as Ve,B as Me,c as ke,x as j,g as we}from"./index-01698fc6.js";import{u as Z}from"./alert-20e2704d.js";import{u as Ue,a as $e,_ as Ae}from"./ElementsTable.vue_vue_type_script_setup_true_lang-19b524f2.js";import{u as ie,a as me,b as z}from"./useFormSchemas-6566ee65.js";const Ee=(n,V,c)=>{const M=Z(),U=I([+n.query.startPrice||1,+n.query.endPrice||99999]),b=I(n.query.productName||""),h=I([]),k=I(!1),m=I(!1),_=I(!1),y=()=>{b.value="",U.value=[1,99999],k.value=!1,h.value=[],V.push({name:"products-page",query:{}})},q=()=>{V.push({name:"products-page",query:{...n.query,productName:b.value,startPrice:U.value[0],endPrice:U.value[1]}})},f=async()=>{try{m.value=!0;const{data:$}=await ee.getSearchedProducts({startPrice:n.query.startPrice,endPrice:n.query.endPrice,productName:n.query.productName,userId:c});h.value=$.products,console.log(h.value),k.value=!0}catch($){te($)?M.showMessage("error",oe($)):M.showMessage("error","Ошибка при поиске товара(")}finally{m.value=!1}};return xe([()=>n.query.startPrice,()=>n.query.endPrice,()=>n.query.productName],async()=>{!n.query.startPrice&&!n.query.endPrice||f()},{immediate:!0}),{searchPrices:U,searchName:b,isSearchActive:k,searchedProducts:h,isSearchLoading:m,isSearchFormActive:_,searchUserProducts:f,addSearchQuery:q,resetSearch:y}},Ce=C("p",{class:"text-h6 font-weight-bold mb-4"},"Редактирование товара",-1),qe=C("p",{class:"text-h6 mb-2"},"Загрузка категорий....",-1),Te=se({__name:"ProductEditDialog",props:{isActive:{type:Boolean},product:null,isSearchActive:{type:Boolean}},emits:["closeModal","updateSearchProducts"],setup(n,{emit:V}){const c=n,M=de(()=>{var u,a,i,P;return{name:((u=c.product)==null?void 0:u.name)||"Товар не был выбран",price:((a=c.product)==null?void 0:a.price)||0,count:((i=c.product)==null?void 0:i.count)||0,categoryId:((P=c.product)==null?void 0:P.categoryId)||0}}),{userProductSchema:U}=ie(),{handleSubmit:b,isSubmitting:h,resetForm:k}=me({validationSchema:U,initialValues:M}),{value:m,errorMessage:_}=z("name"),{value:y,errorMessage:q}=z("price"),{value:f,errorMessage:$}=z("count"),{value:E,errorMessage:T}=z("categoryId"),F=re(),N=Z(),{productsCategories:Q,categoriesErrorMessage:L,isCategoriesLoading:B}=ne(F),S=ae(),d=b(async u=>{var a;try{await ee.updateProduct(u,c.product.id);const i=Q.value.find(P=>P.id===u.categoryId).name;F.updateUserProduct({...u,category:i,id:c.product.id}),c.isSearchActive&&V("updateSearchProducts"),N.showMessage("success","Товар был изменен")}catch(i){if(te(i)){if(((a=i.response)==null?void 0:a.status)===401){S.push({name:"login-page",query:{isExpiredToken:"true",redirectedFrom:"products-page"}});return}N.showMessage("error",oe(i))}else N.showMessage("error","Ошибка при обновлении товара!")}finally{k(),V("closeModal")}});return(u,a)=>{const i=s("v-card-title"),P=s("v-text-field"),D=s("v-col"),G=s("v-progress-linear"),H=s("v-sheet"),R=s("v-autocomplete"),O=s("v-alert-title"),J=s("v-alert"),r=s("v-btn"),K=s("v-row"),W=s("v-form"),X=s("v-card-actions"),p=s("v-card"),le=s("v-dialog");return v(),g(le,{transition:"dialog-bottom-transition","max-width":"500","onUpdate:modelValue":a[5]||(a[5]=w=>u.$emit("closeModal")),"model-value":n.isActive},{default:o(()=>[t(p,{class:"pa-5",color:"white",elevation:"4"},{default:o(()=>[t(i,null,{default:o(()=>[Ce]),_:1}),t(X,null,{default:o(()=>[t(W,{onSubmit:ue(e(d),["prevent"])},{default:o(()=>[t(K,null,{default:o(()=>[t(D,{cols:"12"},{default:o(()=>[t(P,{modelValue:e(m),"onUpdate:modelValue":a[0]||(a[0]=w=>A(m)?m.value=w:null),"error-messages":e(_),label:"Название товара"},null,8,["modelValue","error-messages"])]),_:1}),t(D,{cols:"12"},{default:o(()=>[e(B)?(v(),g(H,{key:0},{default:o(()=>[qe,t(G,{indeterminate:"",height:"6",color:"green"})]),_:1})):e(L)?(v(),g(H,{key:2},{default:o(()=>[t(J,{type:"error",border:"end",variant:"outlined",class:"pa-2"},{default:o(()=>[t(O,{class:"text-h6"},{default:o(()=>[x(Y(e(L)),1)]),_:1})]),_:1})]),_:1})):(v(),g(R,{key:1,modelValue:e(E),"onUpdate:modelValue":a[1]||(a[1]=w=>A(E)?E.value=w:null),label:"Категория товара","error-messages":e(T),items:e(Q),"item-title":"name",clearable:!1,"item-value":"id","no-data-text":"Нет категорий"},null,8,["modelValue","error-messages","items"]))]),_:1}),t(D,{sm:"6",cols:"12"},{default:o(()=>[t(P,{modelValue:e(f),"onUpdate:modelValue":a[2]||(a[2]=w=>A(f)?f.value=w:null),modelModifiers:{number:!0},"error-messages":e($),label:"Количество",type:"number"},null,8,["modelValue","error-messages"])]),_:1}),t(D,{sm:"6",cols:"12"},{default:o(()=>[t(P,{modelValue:e(y),"onUpdate:modelValue":a[3]||(a[3]=w=>A(y)?y.value=w:null),modelModifiers:{number:!0},"error-messages":e(q),label:"Цена",type:"number",suffix:"руб"},null,8,["modelValue","error-messages"])]),_:1}),t(D,{cols:"12"},{default:o(()=>[t(r,{color:"green-darken-4",variant:"flat",loading:e(h),type:"submit"},{default:o(()=>[x(" Сохранить ")]),_:1},8,["loading"]),t(r,{color:"blue-darken-4",variant:"flat",onClick:a[4]||(a[4]=w=>u.$emit("closeModal"))},{default:o(()=>[x(" Отмена ")]),_:1})]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["model-value"])}}}),Ne=C("p",{class:"font-weight-bold text-h5"},"Подтверждение удаления",-1),De={class:"text-h6"},Fe={class:"text-red"},Be=C("span",{class:"text-white"},"Нет",-1),Ie=se({__name:"ProductDeleteDialog",props:{product:null,isActive:{type:Boolean},isSearchActive:{type:Boolean}},emits:["closeModal","updateSearchProducts"],setup(n,{emit:V}){const c=n,M=I(!1),U=re(),b=Z(),h=ae(),k=async()=>{var m;try{M.value=!0,await ee.deleteProduct(c.product.id),U.deleteUserProduct(c.product.id),c.isSearchActive&&V("updateSearchProducts"),b.showMessage("success","Товар был успешно удален")}catch(_){if(te(_)){if(((m=_.response)==null?void 0:m.status)===401){h.push({name:"login-page",query:{isExpiredToken:"true",redirectedFrom:"products-page"}});return}b.showMessage("error",oe(_))}else b.showMessage("error","Ошибка при удалении товара!")}finally{M.value=!1,V("closeModal")}};return(m,_)=>{const y=s("v-card-title"),q=s("v-card-text"),f=s("v-btn"),$=s("v-card-actions"),E=s("v-card"),T=s("v-dialog");return v(),g(T,{"model-value":n.isActive,"max-width":450,persistent:"",transition:"dialog-bottom-transition"},{default:o(()=>[t(E,{class:"pa-4"},{default:o(()=>[t(y,{class:"pa-0 mb-3"},{default:o(()=>[Ne]),_:1}),t(q,{class:"pa-0 mb-4"},{default:o(()=>[C("p",De,[x(" Вы уверены что хотите удалить товар "),C("span",Fe,Y(c.product.name),1),x(" из списка? ")])]),_:1}),t($,{class:"justify-center"},{default:o(()=>[t(f,{onClick:_[0]||(_[0]=F=>m.$emit("closeModal")),height:"40",color:"blue-darken-4",variant:"flat"},{default:o(()=>[Be]),_:1}),t(f,{height:"40",loading:M.value,color:"error",variant:"flat",onClick:k},{default:o(()=>[x("Да")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["model-value"])}}}),Le=C("p",{class:"text-h6 font-weight-bold mb-4"},"Добавление нового товара",-1),Re=C("p",{class:"text-h6 mb-2"},"Загрузка категорий....",-1),je=se({__name:"ProductAddDialog",props:{isActive:{type:Boolean}},emits:["closeModal"],setup(n,{emit:V}){const{userProductSchema:c}=ie(),{handleSubmit:M,isSubmitting:U,resetForm:b}=me({validationSchema:c}),{value:h,errorMessage:k}=z("name"),{value:m,errorMessage:_}=z("categoryId"),{value:y,errorMessage:q}=z("count"),{value:f,errorMessage:$}=z("price"),E=re(),T=Z(),{productsCategories:F,categoriesErrorMessage:N,isCategoriesLoading:Q}=ne(E),L=ae(),B=M(async S=>{var d;try{const{data:u}=await ee.addProduct(S);console.log(S),E.addUserProduct({...S,...u}),T.showMessage("success",`Товар ${S.name} был успешно добавлен!`)}catch(u){if(te(u)){if(((d=u.response)==null?void 0:d.status)===401){L.push({name:"login-page",query:{isExpiredToken:"true",redirectedFrom:"products-page"}});return}T.showMessage("error",oe(u))}else T.showMessage("error","Ошибка при добавлении товара !")}finally{b(),V("closeModal")}});return(S,d)=>{const u=s("v-card-title"),a=s("v-text-field"),i=s("v-col"),P=s("v-progress-linear"),D=s("v-sheet"),G=s("v-autocomplete"),H=s("v-alert-title"),R=s("v-alert"),O=s("v-btn"),J=s("v-row"),r=s("v-form"),K=s("v-card-actions"),W=s("v-card"),X=s("v-dialog");return v(),g(X,{transition:"dialog-bottom-transition","max-width":"500","onUpdate:modelValue":d[5]||(d[5]=p=>S.$emit("closeModal")),scrollable:"","model-value":n.isActive},{default:o(()=>[t(W,{class:"pa-5",color:"white",elevation:"4"},{default:o(()=>[t(u,null,{default:o(()=>[Le]),_:1}),t(K,null,{default:o(()=>[t(r,{onSubmit:ue(e(B),["prevent"])},{default:o(()=>[t(J,null,{default:o(()=>[t(i,{cols:"12"},{default:o(()=>[t(a,{modelValue:e(h),"onUpdate:modelValue":d[0]||(d[0]=p=>A(h)?h.value=p:null),"error-messages":e(k),label:"Название товара"},null,8,["modelValue","error-messages"])]),_:1}),t(i,{cols:"12"},{default:o(()=>[e(Q)?(v(),g(D,{key:0},{default:o(()=>[Re,t(P,{indeterminate:"",height:"6",color:"green"})]),_:1})):e(N)?(v(),g(D,{key:2},{default:o(()=>[t(R,{type:"error",border:"end",variant:"outlined",class:"pa-2"},{default:o(()=>[t(H,{class:"text-h6"},{default:o(()=>[x(Y(e(N)),1)]),_:1})]),_:1})]),_:1})):(v(),g(G,{key:1,modelValue:e(m),"onUpdate:modelValue":d[1]||(d[1]=p=>A(m)?m.value=p:null),label:"Категория товара","error-messages":e(_),items:e(F),"item-title":"name",clearable:!1,"item-value":"id","no-data-text":"Нет категорий"},null,8,["modelValue","error-messages","items"]))]),_:1}),t(i,{sm:"6",cols:"12"},{default:o(()=>[t(a,{modelValue:e(y),"onUpdate:modelValue":d[2]||(d[2]=p=>A(y)?y.value=p:null),modelModifiers:{number:!0},"error-messages":e(q),label:"Количество",type:"number"},null,8,["modelValue","error-messages"])]),_:1}),t(i,{sm:"6",cols:"12"},{default:o(()=>[t(a,{modelValue:e(f),"onUpdate:modelValue":d[3]||(d[3]=p=>A(f)?f.value=p:null),modelModifiers:{number:!0},"error-messages":e($),label:"Цена",suffix:"руб",type:"number"},null,8,["modelValue","error-messages"])]),_:1}),t(i,{cols:"12"},{default:o(()=>[t(O,{color:"green-darken-4",variant:"flat",loading:e(U),type:"submit"},{default:o(()=>[x(" Добавить ")]),_:1},8,["loading"]),t(O,{color:"blue-darken-4",variant:"flat",onClick:d[4]||(d[4]=p=>S.$emit("closeModal"))},{default:o(()=>[x(" Отмена ")]),_:1})]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["model-value"])}}}),ze={key:0},Qe={class:"text-h6"},He=C("h2",{class:"title text-h2 mb-5"},"Товары",-1),Oe={class:"text-h6"},Xe=se({__name:"ProductsView",setup(n){const V=re(),c=Z(),M=Ve(),U=I([{fieldText:"Имя",fieldName:"name"},{fieldText:"Цена(руб)",fieldName:"price"},{fieldText:"Кол-во",fieldName:"count"},{fieldText:"Категория",fieldName:"category"}]),b=I("name"),{userProducts:h,productsErrorMessage:k,productsCategories:m}=ne(V);Me(async()=>{m.value.length||V.getAllProductsCategories()});const{itemToEdit:_,isAddDialogActive:y,isEditDialogActive:q,isDeleteDialogActive:f,openDialog:$}=Ue(),E=we(),T=ae(),{searchName:F,searchPrices:N,searchedProducts:Q,isSearchActive:L,isSearchLoading:B,isSearchFormActive:S,resetSearch:d,addSearchQuery:u,searchUserProducts:a}=Ee(E,T,M.currentUser.id),i=de(()=>L.value?Q.value:h.value),{currentPage:P,paginatedElements:D,totalPages:G,isInverseSort:H,elemetsPerPage:R,setSortField:O}=$e({tableElements:i,pageName:"products-page",sortField:b,route:E,router:T});return(J,r)=>{const K=s("v-snackbar"),W=s("TableActions"),X=s("v-text-field"),p=s("v-col"),le=s("v-range-slider"),w=s("v-btn"),ce=s("v-row"),pe=s("v-form"),ve=s("v-expand-transition"),_e=s("v-card-title"),ge=s("v-alert-title"),fe=s("v-alert"),be=s("v-progress-circular"),ye=s("v-sheet"),he=s("v-pagination"),Se=s("v-card");return e(M).currentUser?(v(),ke("div",ze,[t(K,{modelValue:e(c).isMessageShown,"onUpdate:modelValue":r[0]||(r[0]=l=>e(c).isMessageShown=l),"max-width":500,color:e(c).messageType},{default:o(()=>[C("p",Qe,Y(e(c).messageText),1)]),_:1},8,["modelValue","color"]),He,t(Se,{color:"white",elevation:"3",class:"pa-5 mb-6 rounded-lg mx-sm-0 mx-n5"},{default:o(()=>[e(k)?j("",!0):(v(),g(_e,{key:0,class:"pa-0"},{default:o(()=>[t(W,{count:e(R),"onUpdate:count":[r[1]||(r[1]=l=>A(R)?R.value=l:null),r[2]||(r[2]=l=>R.value=l)],onToggleAddDialog:r[3]||(r[3]=l=>y.value=!0),onToggleSearch:r[4]||(r[4]=l=>S.value=!e(S)),"is-badge-active":!!J.$route.query.startPrice},{default:o(()=>[x(" Все товары ")]),_:1},8,["count","is-badge-active"]),t(ve,null,{default:o(()=>[e(S)?(v(),g(pe,{key:0,class:"mb-8"},{default:o(()=>[t(ce,{align:"center"},{default:o(()=>[t(p,{sm:"6",cols:"12"},{default:o(()=>[t(X,{modelValue:e(F),"onUpdate:modelValue":r[5]||(r[5]=l=>A(F)?F.value=l:null),variant:"outlined",label:"Название товара"},null,8,["modelValue"])]),_:1}),t(p,{sm:"6",cols:"12",class:"pr-7"},{default:o(()=>[t(le,{modelValue:e(N),"onUpdate:modelValue":r[6]||(r[6]=l=>A(N)?N.value=l:null),min:"1",step:"10",max:"99999",color:"blue-grey-darken-2",label:"Цена:"},null,8,["modelValue"])]),_:1}),t(p,{cols:"auto"},{default:o(()=>[t(ce,null,{default:o(()=>[t(p,null,{default:o(()=>[t(w,{variant:"flat",color:"green-darken-3",onClick:e(u),disabled:e(B)},{default:o(()=>[x(" Искать ")]),_:1},8,["onClick","disabled"])]),_:1}),t(p,null,{default:o(()=>[t(w,{variant:"flat",color:"red-darken-4",onClick:e(d),disabled:e(B)},{default:o(()=>[x(" Сбросить поиск ")]),_:1},8,["onClick","disabled"])]),_:1}),t(p,null,{default:o(()=>[t(w,{variant:"flat",color:"blue-darken-4",onClick:r[7]||(r[7]=l=>S.value=!1),disabled:e(B)},{default:o(()=>[x(" Закрыть ")]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})):j("",!0)]),_:1})]),_:1})),e(k)?(v(),g(fe,{key:1,type:"error",border:"end",variant:"tonal"},{default:o(()=>[t(ge,{class:"mb-2 text-h5"},{default:o(()=>[x(" Ошибка при загрузке товаров ")]),_:1}),C("p",Oe,Y(e(k)),1)]),_:1})):e(B)?j("",!0):(v(),g(Ae,{key:2,items:e(D),fields:U.value,"is-inverse-sort":e(H),"no-data-text":"Товары не найдены","current-sort-field":b.value,"onUpdate:currentSortField":[r[8]||(r[8]=l=>b.value=l),r[9]||(r[9]=l=>e(O)(l))],onOpenDialog:r[10]||(r[10]=(l,Pe)=>e($)(l,Pe))},null,8,["items","fields","is-inverse-sort","current-sort-field"])),e(B)?(v(),g(ye,{key:3,class:"text-center mb-2"},{default:o(()=>[t(be,{indeterminate:"",size:"48",color:"green"})]),_:1})):j("",!0),e(i).length?(v(),g(he,{key:4,length:e(G),modelValue:e(P),"onUpdate:modelValue":r[11]||(r[11]=l=>A(P)?P.value=l:null),rounded:"circle","total-visible":7,color:"indigo-darken-4"},null,8,["length","modelValue"])):j("",!0)]),_:1}),e(_)?(v(),g(Te,{key:0,product:e(_),onCloseModal:r[12]||(r[12]=l=>q.value=!1),"is-active":e(q),"is-search-active":e(L),onUpdateSearchProducts:e(a)},null,8,["product","is-active","is-search-active","onUpdateSearchProducts"])):j("",!0),e(_)?(v(),g(Ie,{key:1,"is-active":e(f),product:e(_),onCloseModal:r[13]||(r[13]=l=>f.value=!1),"is-search-active":e(L),onUpdateSearchProducts:e(a)},null,8,["is-active","product","is-search-active","onUpdateSearchProducts"])):j("",!0),t(je,{onCloseModal:r[14]||(r[14]=l=>y.value=!1),"is-active":e(y)},null,8,["is-active"])])):j("",!0)}}});export{Xe as default};
