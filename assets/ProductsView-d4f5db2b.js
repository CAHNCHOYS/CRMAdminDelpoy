import{a as H,r as U,X as Se,Y as K,i as O,h as W,d as X,Q as ne,Z as Y,K as te,P as p,f as a,$ as ae,o as m,e as t,v as Z,x as se,y as oe,z as de,j as e,B as G,C as f,D as R,E as w,a0 as j,a1 as ie,a2 as ce,n as re,p as le,q as k,t as z,G as E,g as J,s as A,a3 as Pe,u as _e,T as ke,c as xe,W as we,N as B,l as Ae,m as $e,a4 as Ce,a5 as De,a6 as Me,a7 as Ue,H as Ee}from"./index-01d92673.js";import{u as Te,a as Ne,_ as qe}from"./ElementsTable.vue_vue_type_script_setup_true_lang-c433d0bc.js";import{u as me,a as ge,b as L}from"./useFormSchemas-b3c2d877.js";import{u as ue}from"./useLogoutHandler-7e44aa0e.js";const Fe=(u,V,n)=>{const S=H(),x=U([+u.query.startPrice||1,+u.query.endPrice||99999]),v=U(u.query.productName||""),b=U([]),P=U(!1),c=U(!1),g=U(!1),y=()=>{v.value="",x.value=[1,99999],P.value=!1,b.value=[],V.push({name:"products-page",query:{}})},T=()=>{V.push({name:"products-page",query:{...u.query,productName:v.value,startPrice:x.value[0],endPrice:x.value[1]}})},_=async()=>{try{c.value=!0;const{data:$}=await K.getSearchedProducts({startPrice:u.query.startPrice,endPrice:u.query.endPrice,productName:u.query.productName,userId:n});b.value=$.products,console.log(b.value),P.value=!0}catch($){O($)?S.showMessage("error",W($)):S.showMessage("error","Ошибка при поиске товара(")}finally{c.value=!1}};return Se([()=>u.query.startPrice,()=>u.query.endPrice,()=>u.query.productName],async()=>{!u.query.startPrice&&!u.query.endPrice||_()},{immediate:!0}),{searchPrices:x,searchName:v,isSearchActive:P,searchedProducts:b,isSearchLoading:c,isSearchFormActive:g,searchUserProducts:_,addSearchQuery:T,resetSearch:y}},Ie=A("p",{class:"text-h6 font-weight-bold mb-4"},"Редактирование товара",-1),Be=A("p",{class:"text-h6 mb-2"},"Загрузка категорий....",-1),Le=X({__name:"ProductEditDialog",props:{isActive:{type:Boolean},product:null,isSearchActive:{type:Boolean}},emits:["closeDialog","updateSearchProducts"],setup(u,{emit:V}){const n=u,S=ne(()=>{var s,r,l,I;return{name:((s=n.product)==null?void 0:s.name)||"Товар не был выбран",price:((r=n.product)==null?void 0:r.price)||0,count:((l=n.product)==null?void 0:l.count)||0,categoryId:((I=n.product)==null?void 0:I.categoryId)||0}}),{userProductSchema:x}=me(),{handleSubmit:v,isSubmitting:b,resetForm:P}=ge({validationSchema:x,initialValues:S}),{value:c,errorMessage:g}=L("name"),{value:y,errorMessage:T}=L("price"),{value:_,errorMessage:$}=L("count"),{value:M,errorMessage:N}=L("categoryId"),q=Y(),C=H(),{handleLogout:Q}=ue("products-page"),{productsCategories:F,categoriesErrorMessage:D,isCategoriesLoading:h}=te(q),d=v(async s=>{var r;try{await K.updateProduct(s,n.product.id);const l=F.value.find(I=>I.id===s.categoryId).name;q.updateUserProduct({...s,category:l,id:n.product.id}),n.isSearchActive&&V("updateSearchProducts"),C.showMessage("success","Товар был изменен")}catch(l){if(O(l)){if(((r=l.response)==null?void 0:r.status)===401){await Q();return}C.showMessage("error",W(l))}else C.showMessage("error","Ошибка при обновлении товара!")}finally{P(),V("closeDialog")}});return(s,r)=>(m(),p(ae,{transition:"dialog-bottom-transition","max-width":"500","onUpdate:modelValue":r[5]||(r[5]=l=>s.$emit("closeDialog")),"model-value":u.isActive},{default:a(()=>[t(J,{class:"pa-5",color:"white",elevation:"4"},{default:a(()=>[t(Z,null,{default:a(()=>[Ie]),_:1}),t(se,null,{default:a(()=>[t(oe,{onSubmit:de(e(d),["prevent"])},{default:a(()=>[t(G,null,{default:a(()=>[t(f,{cols:"12"},{default:a(()=>[t(R,{modelValue:e(c),"onUpdate:modelValue":r[0]||(r[0]=l=>w(c)?c.value=l:null),"error-messages":e(g),label:"Название товара"},null,8,["modelValue","error-messages"])]),_:1}),t(f,{cols:"12"},{default:a(()=>[e(h)?(m(),p(j,{key:0},{default:a(()=>[Be,t(ie,{indeterminate:"",height:"6",color:"green"})]),_:1})):e(D)?(m(),p(j,{key:2},{default:a(()=>[t(re,{type:"error",border:"end",variant:"outlined",class:"pa-2"},{default:a(()=>[t(le,{class:"text-h6"},{default:a(()=>[k(z(e(D)),1)]),_:1})]),_:1})]),_:1})):(m(),p(ce,{key:1,modelValue:e(M),"onUpdate:modelValue":r[1]||(r[1]=l=>w(M)?M.value=l:null),label:"Категория товара","error-messages":e(N),items:e(F),"item-title":"name",clearable:!1,"item-value":"id","no-data-text":"Нет категорий"},null,8,["modelValue","error-messages","items"]))]),_:1}),t(f,{sm:"6",cols:"12"},{default:a(()=>[t(R,{modelValue:e(_),"onUpdate:modelValue":r[2]||(r[2]=l=>w(_)?_.value=l:null),modelModifiers:{number:!0},"error-messages":e($),label:"Количество",type:"number"},null,8,["modelValue","error-messages"])]),_:1}),t(f,{sm:"6",cols:"12"},{default:a(()=>[t(R,{modelValue:e(y),"onUpdate:modelValue":r[3]||(r[3]=l=>w(y)?y.value=l:null),modelModifiers:{number:!0},"error-messages":e(T),label:"Цена",type:"number",suffix:"руб"},null,8,["modelValue","error-messages"])]),_:1}),t(f,{cols:"12"},{default:a(()=>[t(E,{color:"green-darken-4",variant:"flat",loading:e(b),type:"submit"},{default:a(()=>[k(" Сохранить ")]),_:1},8,["loading"]),t(E,{color:"blue-darken-4",variant:"flat",onClick:r[4]||(r[4]=l=>s.$emit("closeDialog"))},{default:a(()=>[k(" Отмена ")]),_:1})]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["model-value"]))}}),Re=A("p",{class:"font-weight-bold text-h5"},"Подтверждение удаления",-1),Qe={class:"text-h6"},je={class:"text-red"},ze=A("span",{class:"text-white"},"Нет",-1),He=X({__name:"ProductDeleteDialog",props:{product:null,isActive:{type:Boolean},isSearchActive:{type:Boolean}},emits:["closeDialog","updateSearchProducts"],setup(u,{emit:V}){const n=u,S=U(!1),x=Y(),v=H(),{handleLogout:b}=ue("products-page"),P=async()=>{var c;try{S.value=!0,await K.deleteProduct(n.product.id),x.deleteUserProduct(n.product.id),n.isSearchActive&&V("updateSearchProducts"),v.showMessage("success","Товар был успешно удален")}catch(g){if(O(g)){if(((c=g.response)==null?void 0:c.status)===401){await b();return}v.showMessage("error",W(g))}else v.showMessage("error","Ошибка при удалении товара!")}finally{S.value=!1,V("closeDialog")}};return(c,g)=>(m(),p(ae,{"model-value":u.isActive,"max-width":450,persistent:"",transition:"dialog-bottom-transition"},{default:a(()=>[t(J,{class:"pa-4"},{default:a(()=>[t(Z,{class:"pa-0 mb-3"},{default:a(()=>[Re]),_:1}),t(Pe,{class:"pa-0 mb-4"},{default:a(()=>[A("p",Qe,[k(" Вы уверены что хотите удалить товар "),A("span",je,z(n.product.name),1),k(" из списка? ")])]),_:1}),t(se,{class:"justify-center"},{default:a(()=>[t(E,{onClick:g[0]||(g[0]=y=>c.$emit("closeDialog")),height:"40",color:"blue-darken-4",variant:"flat"},{default:a(()=>[ze]),_:1}),t(E,{height:"40",loading:S.value,color:"error",variant:"flat",onClick:P},{default:a(()=>[k("Да")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["model-value"]))}}),Ge=A("p",{class:"text-h6 font-weight-bold mb-4"},"Добавление нового товара",-1),Ke=A("p",{class:"text-h6 mb-2"},"Загрузка категорий....",-1),Oe=X({__name:"ProductAddDialog",props:{isActive:{type:Boolean}},emits:["closeDialog"],setup(u,{emit:V}){const{userProductSchema:n}=me(),{handleSubmit:S,isSubmitting:x,resetForm:v}=ge({validationSchema:n}),{value:b,errorMessage:P}=L("name"),{value:c,errorMessage:g}=L("categoryId"),{value:y,errorMessage:T}=L("count"),{value:_,errorMessage:$}=L("price"),M=Y(),N=H(),{handleLogout:q}=ue("products-page"),{productsCategories:C,categoriesErrorMessage:Q,isCategoriesLoading:F}=te(M),D=S(async h=>{var d;try{const{data:s}=await K.addProduct(h),r=C.value.find(l=>l.id===h.categoryId).name;M.addUserProduct({...h,id:s.productId,category:r}),N.showMessage("success",`Товар ${h.name} был успешно добавлен!`)}catch(s){if(O(s)){if(((d=s.response)==null?void 0:d.status)===401){await q();return}N.showMessage("error",W(s))}else N.showMessage("error","Ошибка при добавлении товара !")}finally{v(),V("closeDialog")}});return(h,d)=>(m(),p(ae,{transition:"dialog-bottom-transition","max-width":"500","onUpdate:modelValue":d[5]||(d[5]=s=>h.$emit("closeDialog")),scrollable:"","model-value":u.isActive},{default:a(()=>[t(J,{class:"pa-5",color:"white",elevation:"4"},{default:a(()=>[t(Z,null,{default:a(()=>[Ge]),_:1}),t(se,null,{default:a(()=>[t(oe,{onSubmit:de(e(D),["prevent"])},{default:a(()=>[t(G,null,{default:a(()=>[t(f,{cols:"12"},{default:a(()=>[t(R,{modelValue:e(b),"onUpdate:modelValue":d[0]||(d[0]=s=>w(b)?b.value=s:null),"error-messages":e(P),label:"Название товара"},null,8,["modelValue","error-messages"])]),_:1}),t(f,{cols:"12"},{default:a(()=>[e(F)?(m(),p(j,{key:0},{default:a(()=>[Ke,t(ie,{indeterminate:"",height:"6",color:"green"})]),_:1})):e(Q)?(m(),p(j,{key:2},{default:a(()=>[t(re,{type:"error",border:"end",variant:"outlined",class:"pa-2"},{default:a(()=>[t(le,{class:"text-h6"},{default:a(()=>[k(z(e(Q)),1)]),_:1})]),_:1})]),_:1})):(m(),p(ce,{key:1,modelValue:e(c),"onUpdate:modelValue":d[1]||(d[1]=s=>w(c)?c.value=s:null),label:"Категория товара","error-messages":e(g),items:e(C),"item-title":"name",clearable:!1,"item-value":"id","no-data-text":"Нет категорий"},null,8,["modelValue","error-messages","items"]))]),_:1}),t(f,{sm:"6",cols:"12"},{default:a(()=>[t(R,{modelValue:e(y),"onUpdate:modelValue":d[2]||(d[2]=s=>w(y)?y.value=s:null),modelModifiers:{number:!0},"error-messages":e(T),label:"Количество",type:"number"},null,8,["modelValue","error-messages"])]),_:1}),t(f,{sm:"6",cols:"12"},{default:a(()=>[t(R,{modelValue:e(_),"onUpdate:modelValue":d[3]||(d[3]=s=>w(_)?_.value=s:null),modelModifiers:{number:!0},"error-messages":e($),label:"Цена",suffix:"руб",type:"number"},null,8,["modelValue","error-messages"])]),_:1}),t(f,{cols:"12"},{default:a(()=>[t(E,{color:"green-darken-4",variant:"flat",loading:e(x),type:"submit"},{default:a(()=>[k(" Добавить ")]),_:1},8,["loading"]),t(E,{color:"blue-darken-4",variant:"flat",onClick:d[4]||(d[4]=s=>h.$emit("closeDialog"))},{default:a(()=>[k(" Отмена ")]),_:1})]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["model-value"]))}}),We={key:0},Xe={class:"text-h6"},Ye=A("h2",{class:"title text-h2 mb-5"},"Товары",-1),Ze=A("span",{class:"text-wrap"}," Сбросить поиск",-1),Je={class:"text-h6"},ot=X({__name:"ProductsView",setup(u){const V=Y(),n=H(),S=_e(),x=U([{fieldText:"Имя",fieldName:"name"},{fieldText:"Цена(руб)",fieldName:"price"},{fieldText:"Кол-во",fieldName:"count"},{fieldText:"Категория",fieldName:"category"}]),v=U("name"),{userProducts:b,productsErrorMessage:P,productsCategories:c}=te(V);ke(async()=>{c.value.length||V.getAllProductsCategories()});const{itemToEdit:g,isAddDialogActive:y,isEditDialogActive:T,isDeleteDialogActive:_,openDialog:$}=Te(),M=Ae(),N=$e(),{searchName:q,searchPrices:C,searchedProducts:Q,isSearchActive:F,isSearchLoading:D,isSearchFormActive:h,resetSearch:d,addSearchQuery:s,searchUserProducts:r}=Fe(M,N,S.currentUser.id),l=ne(()=>F.value?Q.value:b.value),{currentPage:I,paginatedElements:pe,totalPages:fe,isInverseSort:ve,elementsPerPageCount:ee,setSortField:be}=Ne({tableElements:l,pageName:"products-page",sortField:v,route:M,router:N});return(ye,o)=>{const he=Ee("TableActions");return e(S).currentUser?(m(),xe("div",We,[t(we,{modelValue:e(n).isMessageShown,"onUpdate:modelValue":o[0]||(o[0]=i=>e(n).isMessageShown=i),color:e(n).messageType,"location-strategy":"connected"},{default:a(()=>[A("p",Xe,z(e(n).messageText),1)]),_:1},8,["modelValue","color"]),Ye,t(J,{color:"white",elevation:"3",class:"pa-5 mb-6 rounded-lg mx-sm-0 mx-n5"},{default:a(()=>[e(P)?B("",!0):(m(),p(Z,{key:0,class:"pa-0"},{default:a(()=>[t(he,{count:e(ee),"onUpdate:count":o[1]||(o[1]=i=>w(ee)?ee.value=i:null),onToggleAddDialog:o[2]||(o[2]=i=>y.value=!0),onToggleSearch:o[3]||(o[3]=i=>h.value=!e(h)),"is-badge-active":!!ye.$route.query.startPrice},{default:a(()=>[k(" Все товары ")]),_:1},8,["count","is-badge-active"]),t(Ce,null,{default:a(()=>[e(h)?(m(),p(oe,{key:0,class:"mb-8"},{default:a(()=>[t(G,{align:"center"},{default:a(()=>[t(f,{sm:"6",cols:"12",class:"mb-sm-0 mb-2"},{default:a(()=>[t(R,{modelValue:e(q),"onUpdate:modelValue":o[4]||(o[4]=i=>w(q)?q.value=i:null),variant:"outlined",label:"Название товара"},null,8,["modelValue"])]),_:1}),t(f,{sm:"6",cols:"12",class:"pr-7"},{default:a(()=>[t(De,{modelValue:e(C),"onUpdate:modelValue":o[5]||(o[5]=i=>w(C)?C.value=i:null),min:"1",step:"10",max:"99999",color:"blue-grey-darken-2",label:"Цена:"},null,8,["modelValue"])]),_:1}),t(f,{sm:"auto",cols:"12"},{default:a(()=>[t(G,null,{default:a(()=>[t(f,{sm:"auto",cols:"6"},{default:a(()=>[t(E,{variant:"flat",color:"green-darken-3",onClick:e(s),disabled:e(D),block:""},{default:a(()=>[k(" Искать ")]),_:1},8,["onClick","disabled"])]),_:1}),t(f,{sm:"auto",cols:"6"},{default:a(()=>[t(E,{variant:"flat",color:"red-darken-4",onClick:e(d),disabled:e(D),block:""},{default:a(()=>[Ze]),_:1},8,["onClick","disabled"])]),_:1}),t(f,{sm:"auto",cols:"12"},{default:a(()=>[t(E,{variant:"flat",color:"blue-darken-4",onClick:o[6]||(o[6]=i=>h.value=!1),disabled:e(D),block:""},{default:a(()=>[k(" Закрыть ")]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})):B("",!0)]),_:1})]),_:1})),e(P)?(m(),p(re,{key:1,type:"error",border:"end",variant:"tonal"},{default:a(()=>[t(le,{class:"mb-2 text-h5"},{default:a(()=>[k(" Ошибка при загрузке товаров ")]),_:1}),A("p",Je,z(e(P)),1)]),_:1})):e(D)?B("",!0):(m(),p(qe,{key:2,items:e(pe),fields:x.value,"current-sort-field":v.value,onUpdateSortField:o[7]||(o[7]=i=>e(be)(i)),"is-inverse-sort":e(ve),"no-data-text":"Товары не найдены",onOpenDialog:o[8]||(o[8]=(i,Ve)=>e($)(i,Ve))},null,8,["items","fields","current-sort-field","is-inverse-sort"])),e(D)?(m(),p(j,{key:3,class:"text-center mb-2"},{default:a(()=>[t(Me,{indeterminate:"",size:"48",color:"green"})]),_:1})):B("",!0),e(l).length?(m(),p(Ue,{key:4,length:e(fe),modelValue:e(I),"onUpdate:modelValue":o[9]||(o[9]=i=>w(I)?I.value=i:null),rounded:"circle","total-visible":7,color:"indigo-darken-4"},null,8,["length","modelValue"])):B("",!0)]),_:1}),e(g)?(m(),p(Le,{key:0,"is-active":e(T),onCloseDialog:o[10]||(o[10]=i=>T.value=!1),product:e(g),"is-search-active":e(F),onUpdateSearchProducts:e(r)},null,8,["is-active","product","is-search-active","onUpdateSearchProducts"])):B("",!0),e(g)?(m(),p(He,{key:1,"is-active":e(_),onCloseDialog:o[11]||(o[11]=i=>_.value=!1),product:e(g),"is-search-active":e(F),onUpdateSearchProducts:e(r)},null,8,["is-active","product","is-search-active","onUpdateSearchProducts"])):B("",!0),t(Oe,{onCloseDialog:o[12]||(o[12]=i=>y.value=!1),"is-active":e(y)},null,8,["is-active"])])):B("",!0)}}});export{ot as default};
