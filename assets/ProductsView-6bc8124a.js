import{r as D,W as Ve,X as H,i as J,h as W,d as X,P as ne,Y,J as te,O as p,e as a,Z as ae,o as m,b as t,s as Z,v as se,x as oe,y as de,g as e,z as G,B as f,C as R,D as w,$ as O,a0 as ie,a1 as ce,m as re,n as le,p as k,t as Q,F as E,f as K,q as A,a2 as Pe,u as _e,S as ke,c as xe,U as we,M as B,k as Ae,l as Me,a3 as Ue,a4 as $e,a5 as Ce,a6 as De,G as Ee}from"./index-619baa70.js";import{u as j}from"./alert-163d7f92.js";import{u as ue,a as Te,b as qe,_ as Fe}from"./useLogoutHandler-593ec046.js";import{u as me,a as ge,b as L}from"./useFormSchemas-8a5fa9a3.js";const Ne=(u,S,n)=>{const V=j(),x=D([+u.query.startPrice||1,+u.query.endPrice||99999]),v=D(u.query.productName||""),b=D([]),P=D(!1),c=D(!1),g=D(!1),y=()=>{v.value="",x.value=[1,99999],P.value=!1,b.value=[],S.push({name:"products-page",query:{}})},T=()=>{S.push({name:"products-page",query:{...u.query,productName:v.value,startPrice:x.value[0],endPrice:x.value[1]}})},_=async()=>{try{c.value=!0;const{data:M}=await H.getSearchedProducts({startPrice:u.query.startPrice,endPrice:u.query.endPrice,productName:u.query.productName,userId:n});b.value=M.products,console.log(b.value),P.value=!0}catch(M){J(M)?V.showMessage("error",W(M)):V.showMessage("error","Ошибка при поиске товара(")}finally{c.value=!1}};return Ve([()=>u.query.startPrice,()=>u.query.endPrice,()=>u.query.productName],async()=>{!u.query.startPrice&&!u.query.endPrice||_()},{immediate:!0}),{searchPrices:x,searchName:v,isSearchActive:P,searchedProducts:b,isSearchLoading:c,isSearchFormActive:g,searchUserProducts:_,addSearchQuery:T,resetSearch:y}},Ie=A("p",{class:"text-h6 font-weight-bold mb-4"},"Редактирование товара",-1),Be=A("p",{class:"text-h6 mb-2"},"Загрузка категорий....",-1),Le=X({__name:"ProductEditDialog",props:{isActive:{type:Boolean},product:null,isSearchActive:{type:Boolean}},emits:["closeDialog","updateSearchProducts"],setup(u,{emit:S}){const n=u,V=ne(()=>{var s,r,l,I;return{name:((s=n.product)==null?void 0:s.name)||"Товар не был выбран",price:((r=n.product)==null?void 0:r.price)||0,count:((l=n.product)==null?void 0:l.count)||0,categoryId:((I=n.product)==null?void 0:I.categoryId)||0}}),{userProductSchema:x}=me(),{handleSubmit:v,isSubmitting:b,resetForm:P}=ge({validationSchema:x,initialValues:V}),{value:c,errorMessage:g}=L("name"),{value:y,errorMessage:T}=L("price"),{value:_,errorMessage:M}=L("count"),{value:C,errorMessage:q}=L("categoryId"),F=Y(),U=j(),{handleLogout:z}=ue("products-page"),{productsCategories:N,categoriesErrorMessage:$,isCategoriesLoading:h}=te(F),d=v(async s=>{var r;try{await H.updateProduct(s,n.product.id);const l=N.value.find(I=>I.id===s.categoryId).name;F.updateUserProduct({...s,category:l,id:n.product.id}),n.isSearchActive&&S("updateSearchProducts"),U.showMessage("success","Товар был изменен")}catch(l){if(J(l)){if(((r=l.response)==null?void 0:r.status)===401){await z();return}U.showMessage("error",W(l))}else U.showMessage("error","Ошибка при обновлении товара!")}finally{P(),S("closeDialog")}});return(s,r)=>(m(),p(ae,{transition:"dialog-bottom-transition","max-width":"500","onUpdate:modelValue":r[5]||(r[5]=l=>s.$emit("closeDialog")),"model-value":u.isActive},{default:a(()=>[t(K,{class:"pa-5",color:"white",elevation:"4"},{default:a(()=>[t(Z,null,{default:a(()=>[Ie]),_:1}),t(se,null,{default:a(()=>[t(oe,{onSubmit:de(e(d),["prevent"])},{default:a(()=>[t(G,null,{default:a(()=>[t(f,{cols:"12"},{default:a(()=>[t(R,{modelValue:e(c),"onUpdate:modelValue":r[0]||(r[0]=l=>w(c)?c.value=l:null),"error-messages":e(g),label:"Название товара"},null,8,["modelValue","error-messages"])]),_:1}),t(f,{cols:"12"},{default:a(()=>[e(h)?(m(),p(O,{key:0},{default:a(()=>[Be,t(ie,{indeterminate:"",height:"6",color:"green"})]),_:1})):e($)?(m(),p(O,{key:2},{default:a(()=>[t(re,{type:"error",border:"end",variant:"outlined",class:"pa-2"},{default:a(()=>[t(le,{class:"text-h6"},{default:a(()=>[k(Q(e($)),1)]),_:1})]),_:1})]),_:1})):(m(),p(ce,{key:1,modelValue:e(C),"onUpdate:modelValue":r[1]||(r[1]=l=>w(C)?C.value=l:null),label:"Категория товара","error-messages":e(q),items:e(N),"item-title":"name",clearable:!1,"item-value":"id","no-data-text":"Нет категорий"},null,8,["modelValue","error-messages","items"]))]),_:1}),t(f,{sm:"6",cols:"12"},{default:a(()=>[t(R,{modelValue:e(_),"onUpdate:modelValue":r[2]||(r[2]=l=>w(_)?_.value=l:null),modelModifiers:{number:!0},"error-messages":e(M),label:"Количество",type:"number"},null,8,["modelValue","error-messages"])]),_:1}),t(f,{sm:"6",cols:"12"},{default:a(()=>[t(R,{modelValue:e(y),"onUpdate:modelValue":r[3]||(r[3]=l=>w(y)?y.value=l:null),modelModifiers:{number:!0},"error-messages":e(T),label:"Цена",type:"number",suffix:"руб"},null,8,["modelValue","error-messages"])]),_:1}),t(f,{cols:"12"},{default:a(()=>[t(E,{color:"green-darken-4",variant:"flat",loading:e(b),type:"submit"},{default:a(()=>[k(" Сохранить ")]),_:1},8,["loading"]),t(E,{color:"blue-darken-4",variant:"flat",onClick:r[4]||(r[4]=l=>s.$emit("closeDialog"))},{default:a(()=>[k(" Отмена ")]),_:1})]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["model-value"]))}}),Re=A("p",{class:"font-weight-bold text-h5"},"Подтверждение удаления",-1),ze={class:"text-h6"},Oe={class:"text-red"},Qe=A("span",{class:"text-white"},"Нет",-1),je=X({__name:"ProductDeleteDialog",props:{product:null,isActive:{type:Boolean},isSearchActive:{type:Boolean}},emits:["closeDialog","updateSearchProducts"],setup(u,{emit:S}){const n=u,V=D(!1),x=Y(),v=j(),{handleLogout:b}=ue("products-page"),P=async()=>{var c;try{V.value=!0,await H.deleteProduct(n.product.id),x.deleteUserProduct(n.product.id),n.isSearchActive&&S("updateSearchProducts"),v.showMessage("success","Товар был успешно удален")}catch(g){if(J(g)){if(((c=g.response)==null?void 0:c.status)===401){await b();return}v.showMessage("error",W(g))}else v.showMessage("error","Ошибка при удалении товара!")}finally{V.value=!1,S("closeDialog")}};return(c,g)=>(m(),p(ae,{"model-value":u.isActive,"max-width":450,persistent:"",transition:"dialog-bottom-transition"},{default:a(()=>[t(K,{class:"pa-4"},{default:a(()=>[t(Z,{class:"pa-0 mb-3"},{default:a(()=>[Re]),_:1}),t(Pe,{class:"pa-0 mb-4"},{default:a(()=>[A("p",ze,[k(" Вы уверены что хотите удалить товар "),A("span",Oe,Q(n.product.name),1),k(" из списка? ")])]),_:1}),t(se,{class:"justify-center"},{default:a(()=>[t(E,{onClick:g[0]||(g[0]=y=>c.$emit("closeDialog")),height:"40",color:"blue-darken-4",variant:"flat"},{default:a(()=>[Qe]),_:1}),t(E,{height:"40",loading:V.value,color:"error",variant:"flat",onClick:P},{default:a(()=>[k("Да")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["model-value"]))}}),Ge=A("p",{class:"text-h6 font-weight-bold mb-4"},"Добавление нового товара",-1),He=A("p",{class:"text-h6 mb-2"},"Загрузка категорий....",-1),Je=X({__name:"ProductAddDialog",props:{isActive:{type:Boolean}},emits:["closeDialog"],setup(u,{emit:S}){const{userProductSchema:n}=me(),{handleSubmit:V,isSubmitting:x,resetForm:v}=ge({validationSchema:n}),{value:b,errorMessage:P}=L("name"),{value:c,errorMessage:g}=L("categoryId"),{value:y,errorMessage:T}=L("count"),{value:_,errorMessage:M}=L("price"),C=Y(),q=j(),{handleLogout:F}=ue("products-page"),{productsCategories:U,categoriesErrorMessage:z,isCategoriesLoading:N}=te(C),$=V(async h=>{var d;try{const{data:s}=await H.addProduct(h),r=U.value.find(l=>l.id===h.categoryId).name;C.addUserProduct({...h,id:s.productId,category:r}),q.showMessage("success",`Товар ${h.name} был успешно добавлен!`)}catch(s){if(J(s)){if(((d=s.response)==null?void 0:d.status)===401){await F();return}q.showMessage("error",W(s))}else q.showMessage("error","Ошибка при добавлении товара !")}finally{v(),S("closeDialog")}});return(h,d)=>(m(),p(ae,{transition:"dialog-bottom-transition","max-width":"500","onUpdate:modelValue":d[5]||(d[5]=s=>h.$emit("closeDialog")),scrollable:"","model-value":u.isActive},{default:a(()=>[t(K,{class:"pa-5",color:"white",elevation:"4"},{default:a(()=>[t(Z,null,{default:a(()=>[Ge]),_:1}),t(se,null,{default:a(()=>[t(oe,{onSubmit:de(e($),["prevent"])},{default:a(()=>[t(G,null,{default:a(()=>[t(f,{cols:"12"},{default:a(()=>[t(R,{modelValue:e(b),"onUpdate:modelValue":d[0]||(d[0]=s=>w(b)?b.value=s:null),"error-messages":e(P),label:"Название товара"},null,8,["modelValue","error-messages"])]),_:1}),t(f,{cols:"12"},{default:a(()=>[e(N)?(m(),p(O,{key:0},{default:a(()=>[He,t(ie,{indeterminate:"",height:"6",color:"green"})]),_:1})):e(z)?(m(),p(O,{key:2},{default:a(()=>[t(re,{type:"error",border:"end",variant:"outlined",class:"pa-2"},{default:a(()=>[t(le,{class:"text-h6"},{default:a(()=>[k(Q(e(z)),1)]),_:1})]),_:1})]),_:1})):(m(),p(ce,{key:1,modelValue:e(c),"onUpdate:modelValue":d[1]||(d[1]=s=>w(c)?c.value=s:null),label:"Категория товара","error-messages":e(g),items:e(U),"item-title":"name",clearable:!1,"item-value":"id","no-data-text":"Нет категорий"},null,8,["modelValue","error-messages","items"]))]),_:1}),t(f,{sm:"6",cols:"12"},{default:a(()=>[t(R,{modelValue:e(y),"onUpdate:modelValue":d[2]||(d[2]=s=>w(y)?y.value=s:null),modelModifiers:{number:!0},"error-messages":e(T),label:"Количество",type:"number"},null,8,["modelValue","error-messages"])]),_:1}),t(f,{sm:"6",cols:"12"},{default:a(()=>[t(R,{modelValue:e(_),"onUpdate:modelValue":d[3]||(d[3]=s=>w(_)?_.value=s:null),modelModifiers:{number:!0},"error-messages":e(M),label:"Цена",suffix:"руб",type:"number"},null,8,["modelValue","error-messages"])]),_:1}),t(f,{cols:"12"},{default:a(()=>[t(E,{color:"green-darken-4",variant:"flat",loading:e(x),type:"submit"},{default:a(()=>[k(" Добавить ")]),_:1},8,["loading"]),t(E,{color:"blue-darken-4",variant:"flat",onClick:d[4]||(d[4]=s=>h.$emit("closeDialog"))},{default:a(()=>[k(" Отмена ")]),_:1})]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["model-value"]))}}),We={key:0},Xe={class:"text-h6"},Ye=A("h2",{class:"title text-h2 mb-5"},"Товары",-1),Ze=A("span",{class:"text-wrap"}," Сбросить поиск",-1),Ke={class:"text-h6"},ot=X({__name:"ProductsView",setup(u){const S=Y(),n=j(),V=_e(),x=D([{fieldText:"Имя",fieldName:"name"},{fieldText:"Цена(руб)",fieldName:"price"},{fieldText:"Кол-во",fieldName:"count"},{fieldText:"Категория",fieldName:"category"}]),v=D("name"),{userProducts:b,productsErrorMessage:P,productsCategories:c}=te(S);ke(async()=>{c.value.length||S.getAllProductsCategories()});const{itemToEdit:g,isAddDialogActive:y,isEditDialogActive:T,isDeleteDialogActive:_,openDialog:M}=Te(),C=Ae(),q=Me(),{searchName:F,searchPrices:U,searchedProducts:z,isSearchActive:N,isSearchLoading:$,isSearchFormActive:h,resetSearch:d,addSearchQuery:s,searchUserProducts:r}=Ne(C,q,V.currentUser.id),l=ne(()=>N.value?z.value:b.value),{currentPage:I,paginatedElements:pe,totalPages:fe,isInverseSort:ve,elementsPerPageCount:ee,setSortField:be}=qe({tableElements:l,pageName:"products-page",sortField:v,route:C,router:q});return(ye,o)=>{const he=Ee("TableActions");return e(V).currentUser?(m(),xe("div",We,[t(we,{modelValue:e(n).isMessageShown,"onUpdate:modelValue":o[0]||(o[0]=i=>e(n).isMessageShown=i),color:e(n).messageType,"location-strategy":"connected"},{default:a(()=>[A("p",Xe,Q(e(n).messageText),1)]),_:1},8,["modelValue","color"]),Ye,t(K,{color:"white",elevation:"3",class:"pa-5 mb-6 rounded-lg mx-sm-0 mx-n5"},{default:a(()=>[e(P)?B("",!0):(m(),p(Z,{key:0,class:"pa-0"},{default:a(()=>[t(he,{count:e(ee),"onUpdate:count":o[1]||(o[1]=i=>w(ee)?ee.value=i:null),onToggleAddDialog:o[2]||(o[2]=i=>y.value=!0),onToggleSearch:o[3]||(o[3]=i=>h.value=!e(h)),"is-badge-active":!!ye.$route.query.startPrice},{default:a(()=>[k(" Все товары ")]),_:1},8,["count","is-badge-active"]),t(Ue,null,{default:a(()=>[e(h)?(m(),p(oe,{key:0,class:"mb-8"},{default:a(()=>[t(G,{align:"center"},{default:a(()=>[t(f,{sm:"6",cols:"12",class:"mb-sm-0 mb-2"},{default:a(()=>[t(R,{modelValue:e(F),"onUpdate:modelValue":o[4]||(o[4]=i=>w(F)?F.value=i:null),variant:"outlined",label:"Название товара"},null,8,["modelValue"])]),_:1}),t(f,{sm:"6",cols:"12",class:"pr-7"},{default:a(()=>[t($e,{modelValue:e(U),"onUpdate:modelValue":o[5]||(o[5]=i=>w(U)?U.value=i:null),min:"1",step:"10",max:"99999",color:"blue-grey-darken-2",label:"Цена:"},null,8,["modelValue"])]),_:1}),t(f,{sm:"auto",cols:"12"},{default:a(()=>[t(G,null,{default:a(()=>[t(f,{sm:"auto",cols:"6"},{default:a(()=>[t(E,{variant:"flat",color:"green-darken-3",onClick:e(s),disabled:e($),block:""},{default:a(()=>[k(" Искать ")]),_:1},8,["onClick","disabled"])]),_:1}),t(f,{sm:"auto",cols:"6"},{default:a(()=>[t(E,{variant:"flat",color:"red-darken-4",onClick:e(d),disabled:e($),block:""},{default:a(()=>[Ze]),_:1},8,["onClick","disabled"])]),_:1}),t(f,{sm:"auto",cols:"12"},{default:a(()=>[t(E,{variant:"flat",color:"blue-darken-4",onClick:o[6]||(o[6]=i=>h.value=!1),disabled:e($),block:""},{default:a(()=>[k(" Закрыть ")]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})):B("",!0)]),_:1})]),_:1})),e(P)?(m(),p(re,{key:1,type:"error",border:"end",variant:"tonal"},{default:a(()=>[t(le,{class:"mb-2 text-h5"},{default:a(()=>[k(" Ошибка при загрузке товаров ")]),_:1}),A("p",Ke,Q(e(P)),1)]),_:1})):e($)?B("",!0):(m(),p(Fe,{key:2,items:e(pe),fields:x.value,"current-sort-field":v.value,onUpdateSortField:o[7]||(o[7]=i=>e(be)(i)),"is-inverse-sort":e(ve),"no-data-text":"Товары не найдены",onOpenDialog:o[8]||(o[8]=(i,Se)=>e(M)(i,Se))},null,8,["items","fields","current-sort-field","is-inverse-sort"])),e($)?(m(),p(O,{key:3,class:"text-center mb-2"},{default:a(()=>[t(Ce,{indeterminate:"",size:"48",color:"green"})]),_:1})):B("",!0),e(l).length?(m(),p(De,{key:4,length:e(fe),modelValue:e(I),"onUpdate:modelValue":o[9]||(o[9]=i=>w(I)?I.value=i:null),rounded:"circle","total-visible":7,color:"indigo-darken-4"},null,8,["length","modelValue"])):B("",!0)]),_:1}),e(g)?(m(),p(Le,{key:0,"is-active":e(T),onCloseDialog:o[10]||(o[10]=i=>T.value=!1),product:e(g),"is-search-active":e(N),onUpdateSearchProducts:e(r)},null,8,["is-active","product","is-search-active","onUpdateSearchProducts"])):B("",!0),e(g)?(m(),p(je,{key:1,"is-active":e(_),onCloseDialog:o[11]||(o[11]=i=>_.value=!1),product:e(g),"is-search-active":e(N),onUpdateSearchProducts:e(r)},null,8,["is-active","product","is-search-active","onUpdateSearchProducts"])):B("",!0),t(Je,{onCloseDialog:o[12]||(o[12]=i=>y.value=!1),"is-active":e(y)},null,8,["is-active"])])):B("",!0)}}});export{ot as default};
