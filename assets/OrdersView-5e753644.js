import{r as $,W as he,au as ee,i as te,h as ae,d as re,Y as me,aj as pe,ak as se,J as Z,O as m,e,Z as de,o as c,b as t,s as le,p,v as ue,x as fe,y as ge,g as a,z as j,B as s,a1 as K,D,$ as H,m as W,n as X,t as I,C as F,F as E,f as oe,q as z,a2 as De,ah as ce,u as ke,P as Oe,c as _e,U as we,M as R,k as Ce,l as xe,a3 as Me,a5 as Ue,a6 as $e,G as Ae}from"./index-619baa70.js";import{u as ne,a as Ee,b as Ne,_ as Te}from"./useLogoutHandler-593ec046.js";import{u as Y}from"./alert-163d7f92.js";import{u as ve,a as be,b as q}from"./useFormSchemas-8a5fa9a3.js";const Fe=(l,_,f)=>{const w=Y(),V=$(!1),v=$(!1),y=$(!1),S=$([]),b=$("2023-01-01"),n=$("2024-01-01"),x=$(""),C=$(""),T=()=>{_.push({name:"orders-page",query:{startDate:b.value,endDate:n.value,customerName:x.value,productName:C.value}})},k=()=>{b.value="2023-01-01",n.value="2024-01-01",x.value="",C.value="",v.value=!1,S.value=[],_.push({name:"orders-page",query:{}})},M=async()=>{try{if(!l.query.startDate&&!l.query.endDate)return;y.value=!0;const{data:h}=await ee.getSerachedOrders({userId:f,product:l.query.productName,customer:l.query.customerName,startDate:l.query.startDate,endDate:l.query.endDate});S.value=h.orders,v.value=!0}catch(h){te(h)?w.showMessage("error",ae(h)):w.showMessage("error","Ошибка при поиске заказов")}finally{y.value=!1}};return he([()=>l.query.startDate,()=>l.query.endDate,()=>l.query.customerName,()=>l.query.productName],async()=>{!l.query.startDate&&!l.query.endDate||M()},{immediate:!0}),{isSearchLoading:y,isSearchFormActive:V,isSearchActive:v,startDate:b,endDate:n,customerName:x,productName:C,searchedOrders:S,resetSearch:k,addSearchQuery:T,searchOrders:M}},qe=z("span",{class:"px-5 text-wrap"},"Очистить ",-1),Ie=re({__name:"OrdersAddDialog",props:{isOpened:{type:Boolean}},emits:["closeDialog"],setup(l,{emit:_}){const f=me(),w=pe(),V=se(),v=Y(),{userProducts:y,productsErrorMessage:S}=Z(f),{customers:b,customersErrorMessage:n}=Z(w),{userOrderSchema:x}=ve(),{handleSubmit:C,isSubmitting:T,resetForm:k}=be({validationSchema:x}),{value:M,errorMessage:h}=q("customerId"),{value:N,errorMessage:P}=q("productId"),{value:B,errorMessage:L}=q("productCount"),{value:U,errorMessage:J}=q("date"),{handleLogout:Q}=ne("orders-page"),G=C(async O=>{var o;try{const{data:i}=await ee.addOrder(O);O.date=O.date.split("-").reverse().join("-"),V.addOrder({...O,...i}),v.showMessage("success","Заказ был успешно добавлен!"),k()}catch(i){if(te(i)){if(((o=i.response)==null?void 0:o.status)===401){await Q();return}v.showMessage("error",ae(i))}else v.showMessage("error","Ошибка при добавлении заказа")}finally{_("closeDialog")}});return(O,o)=>(c(),m(de,{"model-value":l.isOpened,"onUpdate:modelValue":o[6]||(o[6]=i=>O.$emit("closeDialog")),width:"auto",scrollable:"",transition:"dialog-bottom-transition"},{default:e(()=>[t(oe,{width:"450",color:"white",class:"pa-4"},{default:e(()=>[t(le,{class:"font-weight-bold text-h6 mb-3"},{default:e(()=>[p(" Добавление заказа ")]),_:1}),t(ue,null,{default:e(()=>[t(fe,{onSubmit:ge(a(G),["prevent"])},{default:e(()=>[t(j,null,{default:e(()=>[t(s,{cols:"12"},{default:e(()=>[a(n)?(c(),m(H,{key:1},{default:e(()=>[t(W,{type:"error",border:"end",variant:"outlined",class:"pa-2"},{default:e(()=>[t(X,{class:"text-h6"},{default:e(()=>[p(I(a(n)),1)]),_:1})]),_:1})]),_:1})):(c(),m(K,{key:0,modelValue:a(M),"onUpdate:modelValue":o[0]||(o[0]=i=>D(M)?M.value=i:null),"error-messages":a(h),label:"Клиент",items:a(b),"item-title":"fullName","item-value":"id","no-data-text":"Клиенты не найдены"},null,8,["modelValue","error-messages","items"]))]),_:1}),t(s,{cols:"12"},{default:e(()=>[a(S)?(c(),m(H,{key:1},{default:e(()=>[t(W,{type:"error",border:"end",variant:"outlined",class:"pa-2"},{default:e(()=>[t(X,{class:"text-h6"},{default:e(()=>[p(I(a(S)),1)]),_:1})]),_:1})]),_:1})):(c(),m(K,{key:0,modelValue:a(N),"onUpdate:modelValue":o[1]||(o[1]=i=>D(N)?N.value=i:null),"error-messages":a(P),label:"Товар",items:a(y),"item-title":"name","item-value":"id","no-data-text":"Товары не найдены"},null,8,["modelValue","error-messages","items"]))]),_:1}),t(s,{cols:"12"},{default:e(()=>[t(F,{type:"number",modelValue:a(B),"onUpdate:modelValue":o[2]||(o[2]=i=>D(B)?B.value=i:null),modelModifiers:{number:!0},label:"Количество товара","error-messages":a(L)},null,8,["modelValue","error-messages"])]),_:1}),t(s,{cols:"12"},{default:e(()=>[t(F,{modelValue:a(U),"onUpdate:modelValue":o[3]||(o[3]=i=>D(U)?U.value=i:null),"error-messages":a(J),type:"date"},null,8,["modelValue","error-messages"])]),_:1}),t(s,{cols:"12"},{default:e(()=>[t(j,null,{default:e(()=>[t(s,{sm:"auto",cols:"12"},{default:e(()=>[t(E,{color:"green-darken-4",variant:"flat",type:"submit",block:"",loading:a(T)},{default:e(()=>[p(" Добавить ")]),_:1},8,["loading"])]),_:1}),t(s,{sm:"5",cols:"6"},{default:e(()=>[t(E,{color:"error",variant:"flat",onClick:o[4]||(o[4]=i=>a(k)()),block:""},{default:e(()=>[qe]),_:1})]),_:1}),t(s,{sm:"auto",cols:"6"},{default:e(()=>[t(E,{color:"blue-darken-4",block:"",variant:"flat",onClick:o[5]||(o[5]=i=>O.$emit("closeDialog"))},{default:e(()=>[p(" Отмена ")]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["model-value"]))}}),Pe={class:"text-h6"},Be={class:"text-error"},Le=re({__name:"OrdersDeleteDialog",props:{isOpened:{type:Boolean},order:null,isSearchActive:{type:Boolean}},emits:["closeDialog","updateSearchOrders"],setup(l,{emit:_}){const f=l,w=$(!1),V=Y(),v=se(),{handleLogout:y}=ne("orders-page"),S=async()=>{var b;try{w.value=!0,await ee.deleteOrder(f.order.id),v.deleteOrder(f.order.id),f.isSearchActive&&_("updateSearchOrders"),V.showMessage("success","Заказ был успешно удален!")}catch(n){te(n)?(((b=n.response)==null?void 0:b.status)===401&&await y(),V.showMessage("error",ae(n))):V.showMessage("error","Ошибка при удалении заказа")}finally{w.value=!1,_("closeDialog")}};return(b,n)=>(c(),m(de,{scrollable:"",width:"auto","model-value":l.isOpened,"onUpdate:modelValue":n[1]||(n[1]=x=>b.$emit("closeDialog")),persistent:""},{default:e(()=>[t(oe,{width:"450",elevation:"3",class:"pa-4"},{default:e(()=>[t(le,{class:"font-weight-bold text-h6 mb-4 pa-0"},{default:e(()=>[p("Удаление заказа")]),_:1}),t(De,{class:"mb-4 pa-0"},{default:e(()=>[z("p",Pe,[p(" Вы уверены что хотите удалить заказ за "+I(l.order.date)+" клиента ",1),z("span",Be,I(l.order.customerFullName),1),p(" ? ")])]),_:1}),t(ue,{class:"pa-0"},{default:e(()=>[t(E,{onClick:n[0]||(n[0]=x=>b.$emit("closeDialog")),height:"40",color:"blue-darken-4",variant:"flat"},{default:e(()=>[p(" Нет ")]),_:1}),t(E,{height:"40",color:"error",variant:"flat",loading:w.value,onClick:S},{default:e(()=>[p("Да")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["model-value"]))}}),Re=re({__name:"OrdersEditDialog",props:{isOpened:{type:Boolean},order:null,isSearchActive:{type:Boolean}},emits:["closeDialog","updateSearchOrders"],setup(l,{emit:_}){const f=l,w=ce(()=>{const d=f.order.date.split("-");return d[2]+"-"+d[1]+"-"+d[0]}),V=ce(()=>({productCount:f.order.productCount,productId:f.order.productId,customerId:f.order.customerId,date:w.value})),{userOrderSchema:v}=ve(),{isSubmitting:y,resetForm:S,handleSubmit:b}=be({validationSchema:v,initialValues:V}),{value:n,errorMessage:x}=q("customerId"),{value:C,errorMessage:T}=q("productId"),{value:k,errorMessage:M}=q("productCount"),{value:h,errorMessage:N}=q("date"),P=pe(),B=me(),L=se(),U=Y(),{customers:J,customersErrorMessage:Q}=Z(P),{userProducts:G,productsErrorMessage:O}=Z(B),{handleLogout:o}=ne("orders-page"),i=b(async A=>{var d;try{const{data:g}=await ee.updateOrder(A,f.order.id);A.date=A.date.split("-").reverse().join("-"),L.updateOrder({...A,...g}),f.isSearchActive&&_("updateSearchOrders"),U.showMessage("success","Заказ был успешно обновлен")}catch(g){if(te(g)){if(((d=g.response)==null?void 0:d.status)===401){await o();return}U.showMessage("error",ae(g))}else U.showMessage("error","Ошибка при добавлении заказа")}finally{_("closeDialog"),S()}});return(A,d)=>(c(),m(de,{"model-value":l.isOpened,"onUpdate:modelValue":d[5]||(d[5]=g=>A.$emit("closeDialog")),width:"auto",scrollable:"",transition:"dialog-bottom-transition"},{default:e(()=>[t(oe,{width:"450",color:"white",class:"pa-4"},{default:e(()=>[t(le,{class:"font-weight-bold text-h6 mb-3"},{default:e(()=>[p(" Редактирование заказа ")]),_:1}),t(ue,null,{default:e(()=>[t(fe,{onSubmit:ge(a(i),["prevent"])},{default:e(()=>[t(j,null,{default:e(()=>[t(s,{cols:"12"},{default:e(()=>[a(Q)?(c(),m(H,{key:1},{default:e(()=>[t(W,{type:"error",border:"end",variant:"outlined",class:"pa-2"},{default:e(()=>[t(X,{class:"text-h6"},{default:e(()=>[p(I(a(Q)),1)]),_:1})]),_:1})]),_:1})):(c(),m(K,{key:0,modelValue:a(n),"onUpdate:modelValue":d[0]||(d[0]=g=>D(n)?n.value=g:null),"error-messages":a(x),label:"Клиент",items:a(J),"item-title":"fullName","item-value":"id","no-data-text":"Клиенты не найдены"},null,8,["modelValue","error-messages","items"]))]),_:1}),t(s,{cols:"12"},{default:e(()=>[a(O)?(c(),m(H,{key:1},{default:e(()=>[t(W,{type:"error",border:"end",variant:"outlined",class:"pa-2"},{default:e(()=>[t(X,{class:"text-h6"},{default:e(()=>[p(I(a(O)),1)]),_:1})]),_:1})]),_:1})):(c(),m(K,{key:0,modelValue:a(C),"onUpdate:modelValue":d[1]||(d[1]=g=>D(C)?C.value=g:null),"error-messages":a(T),label:"Товар",items:a(G),"item-title":"name","item-value":"id","no-data-text":"Товары не найдены"},null,8,["modelValue","error-messages","items"]))]),_:1}),t(s,{cols:"12"},{default:e(()=>[t(F,{modelValue:a(k),"onUpdate:modelValue":d[2]||(d[2]=g=>D(k)?k.value=g:null),modelModifiers:{number:!0},label:"Количество товара","error-messages":a(M),type:"number"},null,8,["modelValue","error-messages"])]),_:1}),t(s,{cols:"12"},{default:e(()=>[t(F,{modelValue:a(h),"onUpdate:modelValue":d[3]||(d[3]=g=>D(h)?h.value=g:null),"error-messages":a(N),type:"date"},null,8,["modelValue","error-messages"])]),_:1}),t(s,{cols:"12"},{default:e(()=>[t(j,null,{default:e(()=>[t(s,{sm:"auto",cols:"12"},{default:e(()=>[t(E,{color:"green-darken-4",variant:"flat",type:"submit",block:"",loading:a(y)},{default:e(()=>[p(" Сохранить ")]),_:1},8,["loading"])]),_:1}),t(s,{sm:"auto",cols:"12"},{default:e(()=>[t(E,{color:"blue-darken-4",block:"",variant:"flat",onClick:d[4]||(d[4]=g=>A.$emit("closeDialog"))},{default:e(()=>[p(" Отмена ")]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["model-value"]))}}),je={class:"text-h6"},ze=z("h2",{class:"title text-h2 mb-5"},"Заказы",-1),Qe=z("span",{class:"text-wrap"}," Сбросить поиск",-1),Ye=re({__name:"OrdersView",setup(l){const _=$([{fieldText:"Клиент",fieldName:"customerFullName"},{fieldText:"Товар",fieldName:"productName"},{fieldText:"Количество товара",fieldName:"productCount"},{fieldText:"Дата",fieldName:"date"}]),f=$("customerFullName"),w=ke(),V=se(),v=Y(),{itemToEdit:y,isAddDialogActive:S,isEditDialogActive:b,isDeleteDialogActive:n,openDialog:x}=Ee(),C=Ce(),T=xe(),{isSearchFormActive:k,isSearchLoading:M,isSearchActive:h,startDate:N,endDate:P,searchedOrders:B,customerName:L,productName:U,addSearchQuery:J,resetSearch:Q,searchOrders:G}=Fe(C,T,w.currentUser.id),O=Oe(()=>h.value?B.value:V.orders),{currentPage:o,paginatedElements:i,isInverseSort:A,elementsPerPageCount:d,totalPages:g,setSortField:Ve}=Ne({tableElements:O,pageName:"orders-page",sortField:f,route:C,router:T});return(ie,r)=>{const ye=Ae("TableActions");return c(),_e("div",null,[t(we,{modelValue:a(v).isMessageShown,"onUpdate:modelValue":r[0]||(r[0]=u=>a(v).isMessageShown=u),color:a(v).messageType,"location-strategy":"connected"},{default:e(()=>[z("p",je,I(a(v).messageText),1)]),_:1},8,["modelValue","color"]),ze,t(oe,{elevation:"3",color:"white",class:"pa-5 rounded-lg mx-sm-0 mx-n5"},{default:e(()=>[a(V).ordersErrorMessage?R("",!0):(c(),m(le,{key:0,class:"pa-0"},{default:e(()=>[t(ye,{count:a(d),"onUpdate:count":r[1]||(r[1]=u=>D(d)?d.value=u:null),onToggleAddDialog:r[2]||(r[2]=u=>S.value=!0),onToggleSearch:r[3]||(r[3]=u=>k.value=!a(k)),"is-badge-active":!!(ie.$route.query.startDate||ie.$route.query.endDate)},{default:e(()=>[p(" Все заказы ")]),_:1},8,["count","is-badge-active"]),t(Me,null,{default:e(()=>[a(k)?(c(),m(j,{key:0,class:"mb-5"},{default:e(()=>[t(s,{sm:"6",cols:"12"},{default:e(()=>[t(j,null,{default:e(()=>[t(s,{cols:"6"},{default:e(()=>[t(F,{modelValue:a(N),"onUpdate:modelValue":r[4]||(r[4]=u=>D(N)?N.value=u:null),type:"date",label:"Начальная дата",clearable:!1},null,8,["modelValue"])]),_:1}),t(s,{cols:"6"},{default:e(()=>[t(F,{modelValue:a(P),"onUpdate:modelValue":r[5]||(r[5]=u=>D(P)?P.value=u:null),type:"date",label:"Конечная дата",clearable:!1},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(s,{cols:"6"},{default:e(()=>[t(F,{modelValue:a(L),"onUpdate:modelValue":r[6]||(r[6]=u=>D(L)?L.value=u:null),label:"Клиент"},null,8,["modelValue"])]),_:1}),t(s,{cols:"6"},{default:e(()=>[t(F,{modelValue:a(U),"onUpdate:modelValue":r[7]||(r[7]=u=>D(U)?U.value=u:null),label:"Товар"},null,8,["modelValue"])]),_:1}),t(s,{md:"6",cols:"12"},{default:e(()=>[t(j,null,{default:e(()=>[t(s,{sm:"auto",cols:"6"},{default:e(()=>[t(E,{onClick:a(J),variant:"flat",color:"green-darken-3",block:""},{default:e(()=>[p(" Искать ")]),_:1},8,["onClick"])]),_:1}),t(s,{sm:"auto",cols:"6"},{default:e(()=>[t(E,{onClick:a(Q),variant:"flat",color:"red-darken-4",block:""},{default:e(()=>[Qe]),_:1},8,["onClick"])]),_:1}),t(s,{sm:"auto",cols:"12"},{default:e(()=>[t(E,{variant:"flat",color:"blue-darken-4",onClick:r[8]||(r[8]=u=>k.value=!1),block:""},{default:e(()=>[p(" Закрыть ")]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})):R("",!0)]),_:1})]),_:1})),a(V).ordersErrorMessage?(c(),m(H,{key:1},{default:e(()=>[t(W,{variant:"outlined",border:"end",type:"error"},{default:e(()=>[z("p",null,I(a(V).ordersErrorMessage),1)]),_:1})]),_:1})):a(M)?R("",!0):(c(),m(Te,{key:2,items:a(i),fields:_.value,"current-sort-field":f.value,onUpdateSortField:r[9]||(r[9]=u=>a(Ve)(u)),"is-inverse-sort":a(A),onOpenDialog:r[10]||(r[10]=(u,Se)=>a(x)(u,Se)),"no-data-text":"Заказы не найдены"},null,8,["items","fields","current-sort-field","is-inverse-sort"])),a(M)?(c(),m(H,{key:3,class:"text-center mb-2"},{default:e(()=>[t(Ue,{indeterminate:"",size:"32",color:"green"})]),_:1})):R("",!0),a(O).length?(c(),m($e,{key:4,length:a(g),modelValue:a(o),"onUpdate:modelValue":r[11]||(r[11]=u=>D(o)?o.value=u:null),rounded:"circle","total-visible":7,color:"deep-purple-darken-4"},null,8,["length","modelValue"])):R("",!0)]),_:1}),a(y)?(c(),m(Re,{key:0,"is-search-active":a(h),"is-opened":a(b),onCloseDialog:r[12]||(r[12]=u=>b.value=!1),onUpdateSearchOrders:a(G),order:a(y)},null,8,["is-search-active","is-opened","onUpdateSearchOrders","order"])):R("",!0),a(y)?(c(),m(Le,{key:1,"is-search-active":a(h),onUpdateSearchOrders:a(G),onCloseDialog:r[13]||(r[13]=u=>n.value=!1),"is-opened":a(n),order:a(y)},null,8,["is-search-active","onUpdateSearchOrders","is-opened","order"])):R("",!0),t(Ie,{"is-opened":a(S),onCloseDialog:r[14]||(r[14]=u=>S.value=!1)},null,8,["is-opened"])])}}});export{Ye as default};
