import{d as L,aj as j,r as $,O as D,e as a,Z as X,o as k,b as s,y as Y,p as V,a2 as pe,q,t as K,s as ee,F as E,f as z,l as I,as as Q,i as G,h as J,v as oe,g as e,z as R,B as d,C as M,D as v,at as se,ah as ge,W as ve,u as he,J as Ve,P as be,c as Se,U as Ce,M as O,k as Ne,a3 as ye,L as ke,N as we,n as xe,m as De,a5 as Ue,$ as _e,a6 as $e,G as Ae}from"./index-42528f6a.js";import{u as W}from"./alert-45d0e397.js";import{u as te,a as re,b as A}from"./useFormSchemas-05520230.js";import{u as Te,a as Me,_ as Ee}from"./ElementsTable.vue_vue_type_script_setup_true_lang-0278024e.js";const Fe={class:"text-error"},qe=L({__name:"CustomersDeleteDialog",props:{isOpened:{type:Boolean},customer:null,isSearchActive:{type:Boolean}},emits:["closeDialog","updateSearchCustomers"],setup(r,{emit:b}){const n=r,C=W(),w=j(),N=I(),p=$(!1),y=async()=>{var i;try{p.value=!0,await Q.deleteCustomer(n.customer.id),w.deleteCustomer(n.customer.id),n.isSearchActive&&b("updateSearchCustomers"),C.showMessage("success","Клиент был успешно удален!")}catch(m){if(G(m)){if(((i=m.response)==null?void 0:i.status)===401){N.push({name:"login-page",query:{isExpiredToken:"true",redirectedFrom:"customers-page"}});return}C.showMessage("error",J(m))}else C.showMessage("error","Ошибка при удалении клиента!")}finally{b("closeDialog"),p.value=!1}};return(i,m)=>(k(),D(X,{width:"auto","model-value":r.isOpened,persistent:!0,transition:"dialog-bottom-transition"},{default:a(()=>[s(z,{color:"white",class:"pa-4","max-width":450},{default:a(()=>[s(Y,{class:"text-h5 mb-4 pa-0 font-weight-bold"},{default:a(()=>[V("Подтвердите удаление клиента")]),_:1}),s(pe,{class:"text-h6 mb-4 pa-0"},{default:a(()=>[V(" Вы уверены что хотиет удалить клиента "),q("span",Fe,K(r.customer.firstName+" "+r.customer.secondName),1),V(" ? ")]),_:1}),s(ee,{class:"justify-center pa-0"},{default:a(()=>[s(E,{onClick:m[0]||(m[0]=S=>i.$emit("closeDialog")),height:"40",color:"blue-darken-4",variant:"flat"},{default:a(()=>[V(" Нет ")]),_:1}),s(E,{height:"40",color:"error",variant:"flat",loading:p.value,onClick:y},{default:a(()=>[V("Да")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["model-value"]))}}),Pe=q("p",{class:"text-h6"},"Премиум клиент",-1),Be=L({__name:"CustomersAddDialog",props:{isOpened:{type:Boolean}},emits:["closeDialog"],setup(r,{emit:b}){const{userCustomerSchema:n}=te(),{resetForm:C,handleSubmit:w,isSubmitting:N}=re({validationSchema:n}),{value:p,errorMessage:y}=A("firstName"),{value:i,errorMessage:m}=A("secondName"),{value:S,errorMessage:U}=A("thirdName"),{value:x,errorMessage:T}=A("phone"),{value:c,errorMessage:F}=A("premium");c.value="Нет";const h=W(),_=j(),P=I(),B=w(async g=>{var t;try{const{data:l}=await Q.addCustomer(g);_.addCustomer({...g,id:l.customerId,fullName:g.secondName+" "+g.firstName+" "+g.thirdName}),h.showMessage("success","Клиент "+g.secondName+" был успешно добавлен!")}catch(l){if(G(l)){if(((t=l.response)==null?void 0:t.status)===401){P.push({name:"login-page",query:{isExpiredToken:"true",redirectedFrom:"customers-page"}});return}h.showMessage("error",J(l))}else h.showMessage("error","Ошибка при добавлении клиента")}finally{b("closeDialog"),C()}});return(g,t)=>(k(),D(X,{"model-value":r.isOpened,"onUpdate:modelValue":t[6]||(t[6]=l=>b("closeDialog")),width:"auto",scrollable:"",transition:"dialog-bottom-transition"},{default:a(()=>[s(z,{color:"white",class:"pa-4",width:"450"},{default:a(()=>[s(Y,{class:"font-weight-bold text-h6 mb-3"},{default:a(()=>[V(" Добавление нового клиента ")]),_:1}),s(ee,null,{default:a(()=>[s(oe,{onSubmit:e(B)},{default:a(()=>[s(R,null,{default:a(()=>[s(d,{cols:"12"},{default:a(()=>[s(M,{modelValue:e(p),"onUpdate:modelValue":t[0]||(t[0]=l=>v(p)?p.value=l:null),"error-messages":e(y),label:"Имя"},null,8,["modelValue","error-messages"])]),_:1}),s(d,{cols:"12"},{default:a(()=>[s(M,{modelValue:e(i),"onUpdate:modelValue":t[1]||(t[1]=l=>v(i)?i.value=l:null),"error-messages":e(m),label:"Фамилия"},null,8,["modelValue","error-messages"])]),_:1}),s(d,{cols:"12"},{default:a(()=>[s(M,{modelValue:e(S),"onUpdate:modelValue":t[2]||(t[2]=l=>v(S)?S.value=l:null),"error-messages":e(U),label:"Отчество"},null,8,["modelValue","error-messages"])]),_:1}),s(d,{cols:"12"},{default:a(()=>[s(M,{label:"Номер телефона",modelValue:e(x),"onUpdate:modelValue":t[3]||(t[3]=l=>v(x)?x.value=l:null),"error-messages":e(T)},null,8,["modelValue","error-messages"])]),_:1}),s(d,{cols:"12"},{default:a(()=>[Pe,s(se,{modelValue:e(c),"onUpdate:modelValue":t[4]||(t[4]=l=>v(c)?c.value=l:null),"true-value":"Да","false-value":"Нет","hide-details":"",label:e(c),color:"indigo","error-messages":e(F)},null,8,["modelValue","label","error-messages"])]),_:1}),s(d,{cols:"12"},{default:a(()=>[s(E,{color:"green-darken-4",variant:"flat",type:"submit",loading:e(N)},{default:a(()=>[V(" Добавить ")]),_:1},8,["loading"]),s(E,{color:"blue-darken-4",variant:"flat",onClick:t[5]||(t[5]=l=>g.$emit("closeDialog"))},{default:a(()=>[V(" Отмена ")]),_:1})]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["model-value"]))}}),Oe=q("p",{class:"text-h6"},"Премиум клиент ?",-1),We=L({__name:"CustomersEditDialog",props:{isOpened:{type:Boolean},customer:null,isSearchActive:{type:Boolean}},emits:["closeDialog","updateSearchCustomers"],setup(r,{emit:b}){const n=r,C=ge(()=>({firstName:n.customer.firstName,secondName:n.customer.secondName,thirdName:n.customer.thirdName,phone:n.customer.phone,premium:n.customer.premium})),{userCustomerSchema:w}=te(),{resetForm:N,handleSubmit:p,isSubmitting:y}=re({validationSchema:w,initialValues:C}),{value:i,errorMessage:m}=A("firstName"),{value:S,errorMessage:U}=A("secondName"),{value:x,errorMessage:T}=A("thirdName"),{value:c,errorMessage:F}=A("phone"),{value:h}=A("premium"),_=W(),P=j(),B=I(),g=p(async t=>{var l;console.log(t);try{await Q.updateCustomer(t,n.customer.id),P.updateCustomer({...t,id:n.customer.id,fullName:t.secondName+" "+t.firstName+" "+t.thirdName}),n.isSearchActive&&b("updateSearchCustomers"),_.showMessage("success","Клиент был успешно изменен")}catch(f){if(G(f)){if(((l=f.response)==null?void 0:l.status)===401){B.push({name:"login-page",query:{isExpiredToken:"true",redirectedFrom:"customers-page"}});return}_.showMessage("error",J(f))}else _.showMessage("error","Ошибка при изменении клиента")}finally{N(),b("closeDialog")}});return(t,l)=>(k(),D(X,{"model-value":r.isOpened,"onUpdate:modelValue":l[6]||(l[6]=f=>t.$emit("closeDialog")),scrollable:"",width:"auto"},{default:a(()=>[s(z,{width:"450",color:"white",class:"pa-4"},{default:a(()=>[s(Y,{class:"text-h6 font-weight-bold"},{default:a(()=>[V(" Редактирование клиента ")]),_:1}),s(ee,null,{default:a(()=>[s(oe,{onSubmit:e(g)},{default:a(()=>[s(R,null,{default:a(()=>[s(d,{cols:"12"},{default:a(()=>[s(M,{modelValue:e(i),"onUpdate:modelValue":l[0]||(l[0]=f=>v(i)?i.value=f:null),"error-messages":e(m),label:"Имя"},null,8,["modelValue","error-messages"])]),_:1}),s(d,{cols:"12"},{default:a(()=>[s(M,{modelValue:e(S),"onUpdate:modelValue":l[1]||(l[1]=f=>v(S)?S.value=f:null),"error-messages":e(U),label:"Фамилия"},null,8,["modelValue","error-messages"])]),_:1}),s(d,{cols:"12"},{default:a(()=>[s(M,{modelValue:e(x),"onUpdate:modelValue":l[2]||(l[2]=f=>v(x)?x.value=f:null),"error-messages":e(T),label:"Отчество"},null,8,["modelValue","error-messages"])]),_:1}),s(d,{cols:"12"},{default:a(()=>[s(M,{label:"Номер телефона",modelValue:e(c),"onUpdate:modelValue":l[3]||(l[3]=f=>v(c)?c.value=f:null),"error-messages":e(F)},null,8,["modelValue","error-messages"])]),_:1}),s(d,{cols:"12"},{default:a(()=>[Oe,s(se,{modelValue:e(h),"onUpdate:modelValue":l[4]||(l[4]=f=>v(h)?h.value=f:null),"true-value":"Да","false-value":"Нет","hide-details":"",label:e(h),color:"indigo"},null,8,["modelValue","label"])]),_:1}),s(d,{cols:"12"},{default:a(()=>[s(E,{color:"green-darken-4",variant:"flat",type:"submit",loading:e(y)},{default:a(()=>[V(" Обновить ")]),_:1},8,["loading"]),s(E,{color:"blue-darken-4",variant:"flat",onClick:l[5]||(l[5]=f=>t.$emit("closeDialog"))},{default:a(()=>[V(" Отмена ")]),_:1})]),_:1})]),_:1})]),_:1},8,["onSubmit"])]),_:1})]),_:1})]),_:1},8,["model-value"]))}}),Re=(r,b,n)=>{const C=W(),w=$(r.query.secondName||""),N=$(+r.query.premium||0),p=$(!1),y=$([]),i=$(!1),m=$(!1),S=$(!1),U=()=>{w.value="",p.value=!1,N.value=0,i.value=!1,y.value=[],b.push({name:"customers-page",query:{}})},x=()=>{b.push({name:"customers-page",query:{...r.query,secondName:w.value,searchWithPremium:String(p.value),premium:N.value}})},T=async()=>{try{m.value=!0;const{data:c}=await Q.getSearchedCustomers({userId:n,premium:+r.query.premium,secondName:r.query.secondName,searchWithPremium:r.query.searchWithPremium});y.value=c.customers,i.value=!0}catch(c){G(c)?C.showMessage("error",J(c)):C.showMessage("error","Ошибка при поиске товаров!")}finally{m.value=!1}};return ve([()=>r.query.secondName,()=>r.query.premium,()=>r.query.searchWithPremium],async()=>{r.query.secondName===void 0&&!r.query.premium||T()},{immediate:!0}),{premium:N,searchWithPremium:p,isSearchFormActive:S,isSearchActive:i,isSearchLoading:m,secondName:w,searchedCustomers:y,searchUserCustomers:T,addSearchQuery:x,resetSearch:U}},Le={class:"text-h6"},je=q("h2",{class:"title text-h2 mb-5"},"Клиенты",-1),ze=q("span",{class:"text-wrap"}," Сбросить поиск",-1),Ie=q("span",{class:"text-wrap"}," Закрыть поиск",-1),He=L({__name:"CustomersView",setup(r){const b=j(),n=W(),C=he(),w=$([{fieldText:"Имя",fieldName:"firstName"},{fieldText:"Фамилия",fieldName:"secondName"},{fieldText:"Отчество",fieldName:"thirdName"},{fieldText:"Телефон",fieldName:"phone"},{fieldText:"Есть премиум",fieldName:"premium"}]),N=$("firstName"),{customers:p,customersErrorMessage:y}=Ve(b),{isAddDialogActive:i,isEditDialogActive:m,isDeleteDialogActive:S,itemToEdit:U,openDialog:x}=Te(),T=Ne(),c=I(),{isSearchFormActive:F,isSearchLoading:h,searchWithPremium:_,premium:P,isSearchActive:B,secondName:g,searchedCustomers:t,addSearchQuery:l,resetSearch:f,searchUserCustomers:ae}=Re(T,c,C.currentUser.id),le=be(()=>B.value?t.value:p.value),{currentPage:Z,paginatedElements:ue,isInverseSort:ne,elementsPerPageCount:H,totalPages:ie,setSortField:de}=Me({tableElements:le,pageName:"customers-page",sortField:N,route:T,router:c});return(me,o)=>{const ce=Ae("TableActions");return k(),Se("div",null,[s(Ce,{modelValue:e(n).isMessageShown,"onUpdate:modelValue":o[0]||(o[0]=u=>e(n).isMessageShown=u),color:e(n).messageType,"location-strategy":"connected"},{default:a(()=>[q("p",Le,K(e(n).messageText),1)]),_:1},8,["modelValue","color"]),je,s(z,{color:"white",elevation:"3",class:"pa-5 mb-6 rounded-lg mx-sm-0 mx-n5"},{default:a(()=>[s(ce,{count:e(H),"onUpdate:count":o[1]||(o[1]=u=>v(H)?H.value=u:null),onToggleAddDialog:o[2]||(o[2]=u=>i.value=!0),onToggleSearch:o[3]||(o[3]=u=>F.value=!e(F)),"is-badge-active":me.$route.query.secondName!==void 0},{default:a(()=>[V(" Все клиенты ")]),_:1},8,["count","is-badge-active"]),s(ye,null,{default:a(()=>[e(F)?(k(),D(R,{key:0,class:"mb-5",align:"center"},{default:a(()=>[s(d,{sm:"8",cols:"12"},{default:a(()=>[s(M,{label:"Имя клиента",modelValue:e(g),"onUpdate:modelValue":o[4]||(o[4]=u=>v(g)?g.value=u:null),"onClick:clear":o[5]||(o[5]=u=>g.value="")},null,8,["modelValue"])]),_:1}),s(d,{sm:"auto",cols:"6"},{default:a(()=>[s(ke,{modelValue:e(_),"onUpdate:modelValue":o[6]||(o[6]=u=>v(_)?_.value=u:null),color:"indigo-darken-4",label:"Искать с премиумом"},null,8,["modelValue"])]),_:1}),s(we,{"leave-absolute":!0},{default:a(()=>[e(_)?(k(),D(d,{key:0,sm:"auto",cols:"6"},{default:a(()=>[s(se,{modelValue:e(P),"onUpdate:modelValue":o[7]||(o[7]=u=>v(P)?P.value=u:null),"true-value":1,"false-value":0,color:"indigo-darken-4",label:"Есть премиум?"},null,8,["modelValue"])]),_:1})):O("",!0)]),_:1}),s(d,{cols:"12"},{default:a(()=>[s(R,null,{default:a(()=>[s(d,{sm:"auto",cols:"6"},{default:a(()=>[s(E,{variant:"flat",disabled:e(h),color:"green-darken-3",onClick:e(l),block:""},{default:a(()=>[V(" Искать ")]),_:1},8,["disabled","onClick"])]),_:1}),s(d,{sm:"auto",cols:"6"},{default:a(()=>[s(E,{variant:"flat",disabled:e(h),color:"error",onClick:e(f),block:""},{default:a(()=>[ze]),_:1},8,["disabled","onClick"])]),_:1}),s(d,{sm:"auto",cols:"12"},{default:a(()=>[s(E,{variant:"flat",disabled:e(h),color:"blue-darken-4",onClick:o[8]||(o[8]=u=>F.value=!1),block:""},{default:a(()=>[Ie]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1})]),_:1})):O("",!0)]),_:1}),e(y)?(k(),D(De,{key:0,type:"error",border:"end",variant:"tonal"},{default:a(()=>[s(xe,{class:"mb-2"},{default:a(()=>[V(" Ошибка при загрузке клиентов")]),_:1}),q("p",null,K(e(y)),1)]),_:1})):e(h)?O("",!0):(k(),D(Ee,{key:1,items:e(ue),fields:w.value,"current-sort-field":N.value,onUpdateSortField:o[9]||(o[9]=u=>e(de)(u)),"is-inverse-sort":e(ne),onOpenDialog:o[10]||(o[10]=(u,fe)=>e(x)(u,fe)),"no-data-text":"Клиенты не найдены"},null,8,["items","fields","current-sort-field","is-inverse-sort"])),e(h)?(k(),D(_e,{key:2,class:"text-center mb-2"},{default:a(()=>[s(Ue,{indeterminate:"",size:"32",color:"green"})]),_:1})):O("",!0),e(le).length?(k(),D($e,{key:3,length:e(ie),modelValue:e(Z),"onUpdate:modelValue":o[11]||(o[11]=u=>v(Z)?Z.value=u:null),rounded:"circle","total-visible":7,color:"deep-purple-darken-4"},null,8,["length","modelValue"])):O("",!0)]),_:1}),e(U)?(k(),D(qe,{key:0,"is-opened":e(S),onCloseDialog:o[12]||(o[12]=u=>S.value=!1),"is-search-active":e(B),onUpdateSearchCustomers:e(ae),customer:e(U)},null,8,["is-opened","is-search-active","onUpdateSearchCustomers","customer"])):O("",!0),e(U)?(k(),D(We,{key:1,"is-opened":e(m),onCloseDialog:o[13]||(o[13]=u=>m.value=!1),"is-search-active":e(B),onUpdateSearchCustomers:e(ae),customer:e(U)},null,8,["is-opened","is-search-active","onUpdateSearchCustomers","customer"])):O("",!0),s(Be,{"is-opened":e(i),onCloseDialog:o[14]||(o[14]=u=>i.value=!1)},null,8,["is-opened"])])}}});export{He as default};
